<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Monitor v4.3 - BotV2</title>
    
    <!-- Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <style>
        /* Live Monitor Specific Styles */
        .monitor-container {
            max-width: 100%;
            padding: 16px;
            height: 100vh;
            overflow-y: auto;
        }

        .monitor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .monitor-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border-radius: 16px;
            font-size: 12px;
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .monitor-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        @media (max-width: 1400px) {
            .monitor-grid {
                grid-template-columns: 1fr;
            }
        }

        .monitor-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            height: fit-content;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .panel-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .panel-badge {
            padding: 4px 8px;
            background: var(--accent-primary-bg);
            color: var(--accent-primary);
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        /* Market Prices */
        .prices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .price-card {
            background: var(--bg-primary);
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid var(--accent-primary);
            transition: all 0.2s;
        }

        .price-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .price-card.positive {
            border-left-color: var(--accent-success);
        }

        .price-card.negative {
            border-left-color: var(--accent-danger);
        }

        .price-symbol {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .price-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 4px;
        }

        .price-change {
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
        }

        .price-change.positive { color: var(--accent-success); }
        .price-change.negative { color: var(--accent-danger); }

        /* Trade Feed */
        .trade-feed {
            max-height: 400px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }

        .trade-item {
            padding: 10px 12px;
            margin-bottom: 6px;
            background: var(--bg-primary);
            border-radius: 6px;
            border-left: 3px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: fadeIn 0.3s;
        }

        .trade-item.buy {
            border-left-color: var(--accent-success);
        }

        .trade-item.sell {
            border-left-color: var(--accent-danger);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .trade-time {
            color: var(--text-secondary);
            font-size: 10px;
        }

        .trade-action {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
        }

        .trade-action.buy {
            background: var(--accent-success-bg);
            color: var(--accent-success);
        }

        .trade-action.sell {
            background: var(--accent-danger-bg);
            color: var(--accent-danger);
        }

        /* Positions Table */
        .positions-table {
            width: 100%;
            font-size: 12px;
        }

        .positions-table th {
            text-align: left;
            padding: 8px;
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-color);
        }

        .positions-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--bg-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .positions-table tr:hover {
            background: var(--bg-primary);
        }

        /* Strategy Cards */
        .strategies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .strategy-card-mini {
            background: var(--bg-primary);
            padding: 12px;
            border-radius: 6px;
            border-top: 3px solid var(--accent-primary);
        }

        .strategy-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .strategy-stat {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            margin-bottom: 4px;
        }

        .strategy-stat-label {
            color: var(--text-secondary);
        }

        .strategy-stat-value {
            color: var(--text-primary);
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        /* Risk Gauges */
        .risk-gauges {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .gauge {
            text-align: center;
        }

        .gauge-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .gauge-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .gauge-bar {
            height: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .gauge-fill {
            height: 100%;
            background: var(--accent-primary);
            transition: width 0.3s;
        }

        .gauge-fill.success { background: var(--accent-success); }
        .gauge-fill.warning { background: var(--accent-warning); }
        .gauge-fill.danger { background: var(--accent-danger); }

        /* Alerts */
        .alerts-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .alert-item {
            padding: 10px;
            margin-bottom: 8px;
            background: var(--bg-primary);
            border-radius: 6px;
            border-left: 3px solid var(--accent-warning);
            font-size: 12px;
        }

        .alert-item.critical {
            border-left-color: var(--accent-danger);
        }

        .alert-item.info {
            border-left-color: var(--accent-primary);
        }

        .alert-time {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Scrollbar Styling */
        .trade-feed::-webkit-scrollbar,
        .alerts-list::-webkit-scrollbar {
            width: 6px;
        }

        .trade-feed::-webkit-scrollbar-track,
        .alerts-list::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        .trade-feed::-webkit-scrollbar-thumb,
        .alerts-list::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        /* Update Flash */
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .flash-update {
            animation: flash 0.5s;
        }
    </style>
</head>
<body>
    <div class="monitor-container">
        <!-- Header -->
        <div class="monitor-header">
            <div class="monitor-title">
                <span>Live Monitor v4.3</span>
                <div class="live-indicator">
                    <div class="pulse-dot"></div>
                    <span id="connection-status">LIVE</span>
                </div>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn-update" onclick="toggleAutoRefresh()">Auto-Refresh: <span id="refresh-status">ON</span></button>
                <button class="btn-update" onclick="window.location.href='/'">Dashboard</button>
            </div>
        </div>

        <!-- Main Monitor Grid -->
        <div class="monitor-grid">
            <!-- Left Column -->
            <div style="display: flex; flex-direction: column; gap: 16px;">
                <!-- Market Prices -->
                <div class="monitor-panel">
                    <div class="panel-header">
                        <div class="panel-title">Market Prices</div>
                        <div class="panel-badge" id="price-updates">0 updates</div>
                    </div>
                    <div id="prices-grid" class="prices-grid">
                        <!-- Loaded dynamically -->
                    </div>
                </div>

                <!-- Active Positions -->
                <div class="monitor-panel">
                    <div class="panel-header">
                        <div class="panel-title">Active Positions</div>
                        <div class="panel-badge" id="positions-count">0</div>
                    </div>
                    <table class="positions-table" id="positions-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Size</th>
                                <th>Entry</th>
                                <th>Current</th>
                                <th>P&L</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Loaded dynamically -->
                        </tbody>
                    </table>
                </div>

                <!-- Strategy Performance -->
                <div class="monitor-panel">
                    <div class="panel-header">
                        <div class="panel-title">Strategy Performance</div>
                        <div class="panel-badge">LIVE</div>
                    </div>
                    <div id="strategies-grid" class="strategies-grid">
                        <!-- Loaded dynamically -->
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div style="display: flex; flex-direction: column; gap: 16px;">
                <!-- Trade Feed -->
                <div class="monitor-panel">
                    <div class="panel-header">
                        <div class="panel-title">Trade Feed</div>
                        <div class="panel-badge" id="trade-count">0</div>
                    </div>
                    <div id="trade-feed" class="trade-feed">
                        <!-- Loaded dynamically -->
                    </div>
                </div>

                <!-- Risk Metrics -->
                <div class="monitor-panel">
                    <div class="panel-header">
                        <div class="panel-title">Risk Metrics</div>
                        <div class="panel-badge">LIVE</div>
                    </div>
                    <div class="risk-gauges">
                        <div class="gauge">
                            <div class="gauge-label">Exposure</div>
                            <div class="gauge-value" id="exposure-value">0%</div>
                            <div class="gauge-bar">
                                <div class="gauge-fill" id="exposure-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="gauge">
                            <div class="gauge-label">Drawdown</div>
                            <div class="gauge-value" id="drawdown-value">0%</div>
                            <div class="gauge-bar">
                                <div class="gauge-fill danger" id="drawdown-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="gauge">
                            <div class="gauge-label">Win Rate</div>
                            <div class="gauge-value" id="winrate-value">0%</div>
                            <div class="gauge-bar">
                                <div class="gauge-fill success" id="winrate-bar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Alerts -->
                <div class="monitor-panel">
                    <div class="panel-header">
                        <div class="panel-title">Active Alerts</div>
                        <div class="panel-badge" id="alert-count">0</div>
                    </div>
                    <div id="alerts-list" class="alerts-list">
                        <!-- Loaded dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== GLOBAL STATE ====================
        let socket = null;
        let autoRefresh = true;
        let priceUpdates = 0;
        let tradeCount = 0;
        let alertCount = 0;

        const watchlist = ['BTC/USD', 'ETH/USD', 'AAPL', 'GOOGL', 'TSLA', 'NVDA'];

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸ“º Live Monitor v4.3 initialized');
            initWebSocket();
            loadInitialData();
            startAutoRefresh();
        });

        // ==================== WEBSOCKET ====================
        function initWebSocket() {
            socket = io();
            
            socket.on('connect', () => {
                console.log('âœ… WebSocket connected');
                updateConnectionStatus(true);
            });
            
            socket.on('disconnect', () => {
                console.log('âŒ WebSocket disconnected');
                updateConnectionStatus(false);
            });
            
            socket.on('price_update', (data) => {
                updatePrice(data);
            });
            
            socket.on('trade_executed', (data) => {
                addTradeToFeed(data);
            });
            
            socket.on('portfolio_update', (data) => {
                updatePositions(data);
            });
            
            socket.on('alert', (data) => {
                addAlert(data);
            });
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connection-status');
            const dot = document.querySelector('.pulse-dot');
            
            if (connected) {
                status.textContent = 'LIVE';
                dot.style.background = 'var(--accent-success)';
            } else {
                status.textContent = 'OFFLINE';
                dot.style.background = 'var(--accent-danger)';
            }
        }

        // ==================== DATA LOADING ====================
        async function loadInitialData() {
            await Promise.all([
                loadMarketPrices(),
                loadPositions(),
                loadStrategies(),
                loadRecentTrades(),
                loadRiskMetrics(),
                loadAlerts()
            ]);
        }

        async function loadMarketPrices() {
            const grid = document.getElementById('prices-grid');
            
            for (const symbol of watchlist) {
                try {
                    const response = await fetch(`/api/market/${symbol}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        const card = createPriceCard(data);
                        grid.appendChild(card);
                    }
                } catch (error) {
                    console.error(`Error loading ${symbol}:`, error);
                }
            }
        }

        function createPriceCard(data) {
            const div = document.createElement('div');
            div.className = `price-card ${data.change >= 0 ? 'positive' : 'negative'}`;
            div.id = `price-${data.symbol}`;
            
            div.innerHTML = `
                <div class="price-symbol">${data.symbol}</div>
                <div class="price-value">${data.price.toFixed(2)}</div>
                <div class="price-change ${data.change_pct >= 0 ? 'positive' : 'negative'}">
                    ${data.change >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(data.change_pct).toFixed(2)}%
                </div>
            `;
            
            return div;
        }

        function updatePrice(data) {
            const card = document.getElementById(`price-${data.symbol}`);
            if (!card) return;
            
            card.className = `price-card flash-update ${data.change >= 0 ? 'positive' : 'negative'}`;
            card.querySelector('.price-value').textContent = data.price.toFixed(2);
            card.querySelector('.price-change').innerHTML = `
                ${data.change >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(data.change_pct).toFixed(2)}%
            `;
            
            priceUpdates++;
            document.getElementById('price-updates').textContent = `${priceUpdates} updates`;
            
            setTimeout(() => card.classList.remove('flash-update'), 500);
        }

        async function loadPositions() {
            try {
                const response = await fetch('/api/trades?status=open&limit=10');
                const data = await response.json();
                
                if (data.success) {
                    const tbody = document.querySelector('#positions-table tbody');
                    tbody.innerHTML = '';
                    
                    if (data.trades.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">No open positions</td></tr>';
                    } else {
                        data.trades.forEach(trade => {
                            const pnl = trade.pnl || 0;
                            const pnlClass = pnl >= 0 ? 'positive' : 'negative';
                            
                            tbody.innerHTML += `
                                <tr>
                                    <td><strong>${trade.symbol}</strong></td>
                                    <td>${trade.quantity || trade.size}</td>
                                    <td>$${(trade.entry_price || 0).toFixed(2)}</td>
                                    <td>$${(trade.exit_price || trade.entry_price || 0).toFixed(2)}</td>
                                    <td class="price-change ${pnlClass}">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}</td>
                                </tr>
                            `;
                        });
                    }
                    
                    document.getElementById('positions-count').textContent = data.trades.length;
                }
            } catch (error) {
                console.error('Error loading positions:', error);
            }
        }

        async function loadStrategies() {
            try {
                const response = await fetch('/api/strategies/comparison');
                const data = await response.json();
                
                if (data.success) {
                    const grid = document.getElementById('strategies-grid');
                    grid.innerHTML = '';
                    
                    Object.entries(data.strategies).forEach(([name, stats]) => {
                        const card = document.createElement('div');
                        card.className = 'strategy-card-mini';
                        
                        card.innerHTML = `
                            <div class="strategy-name">${name}</div>
                            <div class="strategy-stat">
                                <span class="strategy-stat-label">Return</span>
                                <span class="strategy-stat-value">${(stats.return * 100).toFixed(2)}%</span>
                            </div>
                            <div class="strategy-stat">
                                <span class="strategy-stat-label">Sharpe</span>
                                <span class="strategy-stat-value">${stats.sharpe.toFixed(2)}</span>
                            </div>
                            <div class="strategy-stat">
                                <span class="strategy-stat-label">Win Rate</span>
                                <span class="strategy-stat-value">${(stats.win_rate * 100).toFixed(1)}%</span>
                            </div>
                        `;
                        
                        grid.appendChild(card);
                    });
                }
            } catch (error) {
                console.error('Error loading strategies:', error);
            }
        }

        async function loadRecentTrades() {
            try {
                const response = await fetch('/api/trades?limit=10');
                const data = await response.json();
                
                if (data.success && data.trades.length > 0) {
                    data.trades.slice(0, 10).forEach(trade => {
                        addTradeToFeed(trade, false);
                    });
                }
            } catch (error) {
                console.error('Error loading trades:', error);
            }
        }

        function addTradeToFeed(trade, prepend = true) {
            const feed = document.getElementById('trade-feed');
            const action = (trade.action || 'BUY').toLowerCase();
            
            const item = document.createElement('div');
            item.className = `trade-item ${action}`;
            
            const timestamp = trade.timestamp || trade.entry_time || new Date().toISOString();
            const time = new Date(timestamp).toLocaleTimeString();
            
            item.innerHTML = `
                <div>
                    <span class="trade-action ${action}">${action.toUpperCase()}</span>
                    <strong style="margin: 0 8px;">${trade.symbol}</strong>
                    <span style="color: var(--text-secondary);">${trade.size || trade.quantity}</span>
                    <span style="margin-left: 8px; color: var(--text-secondary);">@ $${(trade.price || trade.entry_price || 0).toFixed(2)}</span>
                </div>
                <div class="trade-time">${time}</div>
            `;
            
            if (prepend) {
                feed.insertBefore(item, feed.firstChild);
                tradeCount++;
                document.getElementById('trade-count').textContent = tradeCount;
            } else {
                feed.appendChild(item);
            }
            
            // Keep only last 20 trades
            while (feed.children.length > 20) {
                feed.removeChild(feed.lastChild);
            }
        }

        async function loadRiskMetrics() {
            try {
                const response = await fetch('/api/trades/stats');
                const data = await response.json();
                
                if (data.success) {
                    const winRate = data.win_rate || 0;
                    const exposure = Math.random() * 100; // Mock
                    const drawdown = Math.random() * 15; // Mock
                    
                    updateGauge('exposure', exposure);
                    updateGauge('drawdown', drawdown);
                    updateGauge('winrate', winRate);
                }
            } catch (error) {
                console.error('Error loading risk metrics:', error);
            }
        }

        function updateGauge(name, value) {
            document.getElementById(`${name}-value`).textContent = `${value.toFixed(1)}%`;
            document.getElementById(`${name}-bar`).style.width = `${Math.min(value, 100)}%`;
        }

        async function loadAlerts() {
            try {
                const response = await fetch('/api/alerts');
                const data = await response.json();
                
                if (data.success) {
                    const list = document.getElementById('alerts-list');
                    list.innerHTML = '';
                    
                    if (data.alerts.length === 0) {
                        list.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No active alerts</div>';
                    } else {
                        data.alerts.forEach(alert => addAlert(alert, false));
                    }
                    
                    alertCount = data.alerts.length;
                    document.getElementById('alert-count').textContent = alertCount;
                }
            } catch (error) {
                console.error('Error loading alerts:', error);
            }
        }

        function addAlert(alert, prepend = true) {
            const list = document.getElementById('alerts-list');
            const item = document.createElement('div');
            item.className = `alert-item ${alert.severity || 'info'}`;
            
            const time = new Date(alert.timestamp || new Date()).toLocaleString();
            
            item.innerHTML = `
                <div>${alert.message || alert.text}</div>
                <div class="alert-time">${time}</div>
            `;
            
            if (prepend) {
                list.insertBefore(item, list.firstChild);
            } else {
                list.appendChild(item);
            }
        }

        // ==================== AUTO REFRESH ====================
        function startAutoRefresh() {
            setInterval(() => {
                if (autoRefresh) {
                    loadPositions();
                    loadStrategies();
                    loadRiskMetrics();
                }
            }, 5000); // Refresh every 5 seconds
        }

        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            document.getElementById('refresh-status').textContent = autoRefresh ? 'ON' : 'OFF';
        }
    </script>
</body>
</html>