<!-- Due to file size limits, I'll provide the key additions to be integrated -->
<!-- This is a PARTIAL UPDATE showing the new interactive features -->
<!-- Full file would be dashboard.html (Phase 2 Part 1) + these additions -->

<!DOCTYPE html>
<html lang="en">
<head>
    <!-- [Previous HEAD content from Phase 2 Part 1] -->
    <style>
        /* [All Previous CSS from Phase 2 Part 1] */
        
        /* ============================================
           PHASE 2 PART 2: MODAL SYSTEM
           ============================================ */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(10px);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        .modal-overlay.active { display: flex; }
        
        .modal-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-tertiary);
        }
        
        .modal-title {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: var(--transition-fast);
        }
        .modal-close:hover { background: var(--danger); color: white; border-color: var(--danger); }
        
        .modal-body {
            padding: var(--spacing-xl);
            overflow-y: auto;
            max-height: calc(90vh - 140px);
        }
        
        .modal-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-md);
            background: var(--bg-tertiary);
        }
        
        .modal-button {
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition-fast);
        }
        .modal-button.primary { background: var(--primary); border-color: var(--primary); color: white; }
        .modal-button:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        
        /* ============================================
           FILTER CONTROLS
           ============================================ */
        .chart-filters {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-xs) var(--spacing-sm);
        }
        
        .filter-label {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .filter-value {
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition-fast);
        }
        .filter-value:hover { background: var(--primary); color: white; }
        
        .filter-clear {
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 4px;
            transition: var(--transition-fast);
        }
        .filter-clear:hover { color: var(--danger); }
        
        /* ============================================
           BRUSH SELECTION
           ============================================ */
        .brush-controls {
            position: fixed;
            bottom: 100px;
            right: var(--spacing-xl);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-xl);
            display: none;
            z-index: 1000;
        }
        .brush-controls.active { display: block; }
        
        .brush-info {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }
        
        .brush-range {
            font-family: var(--font-mono);
            color: var(--primary);
            font-weight: 600;
        }
        
        .brush-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }
        
        .brush-btn {
            padding: var(--spacing-xs) var(--spacing-md);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.875rem;
            transition: var(--transition-fast);
        }
        .brush-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* ============================================
           COMPARISON MODE
           ============================================ */
        .comparison-toggle {
            position: fixed;
            top: calc(var(--topbar-height) + var(--spacing-lg));
            right: var(--spacing-xl);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-lg);
            z-index: 999;
            display: none;
        }
        .comparison-toggle.active { display: block; }
        
        .comparison-selector {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        
        .strategy-checkbox {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition-fast);
        }
        .strategy-checkbox:hover { background: var(--bg-hover); }
        .strategy-checkbox input { cursor: pointer; }
        
        /* ============================================
           ANNOTATIONS
           ============================================ */
        .annotation-marker {
            width: 24px;
            height: 24px;
            border-radius: var(--radius-full);
            background: var(--warning);
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        .annotation-marker:hover { transform: scale(1.2); box-shadow: var(--shadow-md); }
        .annotation-marker.trade { background: var(--success); }
        .annotation-marker.signal { background: var(--info); }
        .annotation-marker.news { background: var(--danger); }
        
        .annotation-tooltip {
            position: absolute;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: var(--spacing-sm);
            font-size: 0.875rem;
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            pointer-events: none;
            opacity: 0;
            transition: opacity var(--transition-fast);
        }
        .annotation-marker:hover + .annotation-tooltip { opacity: 1; }
        
        /* ============================================
           SPARKLINES
           ============================================ */
        .sparkline-container {
            width: 80px;
            height: 24px;
            display: inline-block;
            cursor: pointer;
        }
        .sparkline-container:hover { filter: brightness(1.2); }
        
        /* ============================================
           TRADE SIGNALS
           ============================================ */
        .trade-signal {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition-fast);
            border: 2px solid white;
        }
        .trade-signal.buy { background: var(--success); color: white; }
        .trade-signal.sell { background: var(--danger); color: white; }
        .trade-signal:hover { transform: scale(1.3); box-shadow: 0 0 10px currentColor; }
        
        /* ============================================
           DATA GRID ENHANCEMENTS
           ============================================ */
        .data-grid {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 600px;
        }
        
        .data-grid table {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .data-grid th {
            position: sticky;
            top: 0;
            background: var(--bg-tertiary);
            z-index: 10;
        }
        
        .data-grid tr:hover {
            background: var(--bg-hover);
            cursor: pointer;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .modal-container { width: 95%; max-height: 95vh; }
            .modal-body { padding: var(--spacing-md); }
            .chart-filters { flex-direction: column; width: 100%; }
            .filter-group { width: 100%; }
            .comparison-toggle { position: static; margin: var(--spacing-md); }
            .brush-controls { bottom: 80px; right: var(--spacing-sm); }
        }
    </style>
</head>
<body>
    <!-- [Previous BODY content from Phase 2 Part 1] -->
    
    <!-- PHASE 2 PART 2: NEW ELEMENTS -->
    
    <!-- Modal System -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Details</div>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Dynamic content loaded here -->
            </div>
            <div class="modal-footer">
                <button class="modal-button" onclick="closeModal()">Close</button>
                <button class="modal-button primary" onclick="exportModalData()">üì• Export</button>
            </div>
        </div>
    </div>
    
    <!-- Brush Selection Controls -->
    <div class="brush-controls" id="brushControls">
        <div class="brush-info">
            <strong>Selected Range:</strong><br>
            <span class="brush-range" id="brushRange">-</span>
        </div>
        <div class="brush-actions">
            <button class="brush-btn" onclick="applyBrushSelection()">‚úì Apply</button>
            <button class="brush-btn" onclick="clearBrushSelection()">‚úï Clear</button>
        </div>
    </div>
    
    <!-- Comparison Mode Toggle -->
    <div class="comparison-toggle" id="comparisonToggle">
        <div style="margin-bottom: var(--spacing-md); font-weight: 600;">Compare Strategies</div>
        <div class="comparison-selector" id="comparisonSelector">
            <!-- Strategy checkboxes loaded dynamically -->
        </div>
        <div style="margin-top: var(--spacing-md); display: flex; gap: var(--spacing-sm);">
            <button class="brush-btn" onclick="applyComparison()">‚úì Compare</button>
            <button class="brush-btn" onclick="clearComparison()">‚úï Clear</button>
        </div>
    </div>
    
    <script>
        // [All Previous JavaScript from Phase 2 Part 1]
        
        // ============================================
        // PHASE 2 PART 2: MODAL SYSTEM
        // ============================================
        
        let currentModalData = null;
        
        function openModal(type, data) {
            currentModalData = data;
            const modal = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            
            // Set title based on type
            const titles = {
                'trade': 'üìä Trade Details',
                'strategy': 'üìà Strategy Performance',
                'risk': '‚ö†Ô∏è Risk Analysis',
                'chart': 'üìâ Chart Data'
            };
            title.textContent = titles[type] || 'Details';
            
            // Generate modal content based on type
            body.innerHTML = generateModalContent(type, data);
            
            // Show modal
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Add ESC key listener
            document.addEventListener('keydown', handleModalKeydown);
        }
        
        function closeModal() {
            const modal = document.getElementById('modalOverlay');
            modal.classList.remove('active');
            document.body.style.overflow = '';
            currentModalData = null;
            document.removeEventListener('keydown', handleModalKeydown);
        }
        
        function handleModalKeydown(e) {
            if (e.key === 'Escape') closeModal();
        }
        
        function generateModalContent(type, data) {
            switch(type) {
                case 'trade':
                    return `
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div class="metric-card">
                                <div class="metric-label">Symbol</div>
                                <div class="metric-value" style="font-size: 1.5rem;">${data.symbol}</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Strategy</div>
                                <div class="metric-value" style="font-size: 1.5rem;">${data.strategy}</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Entry Price</div>
                                <div class="metric-value" style="font-size: 1.5rem;">‚Ç¨${data.entry}</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Exit Price</div>
                                <div class="metric-value" style="font-size: 1.5rem;">‚Ç¨${data.exit}</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">P&L</div>
                                <div class="metric-value ${data.pnl >= 0 ? 'text-success' : 'text-danger'}" style="font-size: 1.5rem;">‚Ç¨${data.pnl.toFixed(2)}</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Duration</div>
                                <div class="metric-value" style="font-size: 1.5rem;">${data.duration}</div>
                            </div>
                        </div>
                        <div style="margin-top: 1.5rem;">
                            <h3 style="margin-bottom: 0.5rem;">Price Chart</h3>
                            <div id="modalChart" style="height: 300px;"></div>
                        </div>
                    `;
                
                case 'strategy':
                    return `
                        <div class="metrics-grid">
                            <div class="metric-card"><div class="metric-label">Total Return</div><div class="metric-value">${data.return}%</div></div>
                            <div class="metric-card"><div class="metric-label">Sharpe Ratio</div><div class="metric-value">${data.sharpe}</div></div>
                            <div class="metric-card"><div class="metric-label">Win Rate</div><div class="metric-value">${data.winRate}%</div></div>
                            <div class="metric-card"><div class="metric-label">Trades</div><div class="metric-value">${data.trades}</div></div>
                        </div>
                        <div style="margin-top: 1.5rem;">
                            <h3>Performance Over Time</h3>
                            <div id="modalChart" style="height: 350px;"></div>
                        </div>
                    `;
                
                default:
                    return '<p>No data available</p>';
            }
        }
        
        function exportModalData() {
            if (!currentModalData) return;
            const dataStr = JSON.stringify(currentModalData, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `modal_data_${Date.now()}.json`;
            a.click();
            showToast('Modal data exported', 'success');
        }
        
        // ============================================
        // ADVANCED FILTERS
        // ============================================
        
        const chartFilters = {};
        
        function applyChartFilter(chartId, filterType, value) {
            if (!chartFilters[chartId]) chartFilters[chartId] = {};
            chartFilters[chartId][filterType] = value;
            
            // Show filter pill
            showFilterPill(chartId, filterType, value);
            
            // Refresh chart with filters
            refreshChartWithFilters(chartId);
            
            showToast(`Filter applied to ${chartId}`, 'info');
        }
        
        function showFilterPill(chartId, filterType, value) {
            const container = document.querySelector(`#${chartId}`).closest('.chart-container');
            let filtersDiv = container.querySelector('.chart-filters');
            
            if (!filtersDiv) {
                filtersDiv = document.createElement('div');
                filtersDiv.className = 'chart-filters';
                container.querySelector('.chart-header').after(filtersDiv);
            }
            
            const pill = document.createElement('div');
            pill.className = 'filter-group';
            pill.innerHTML = `
                <span class="filter-label">${filterType}:</span>
                <span class="filter-value">${value}</span>
                <button class="filter-clear" onclick="removeFilter('${chartId}', '${filterType}')" title="Remove filter">‚úï</button>
            `;
            filtersDiv.appendChild(pill);
        }
        
        function removeFilter(chartId, filterType) {
            if (chartFilters[chartId]) {
                delete chartFilters[chartId][filterType];
            }
            refreshChartWithFilters(chartId);
            
            // Remove pill from UI
            const container = document.querySelector(`#${chartId}`).closest('.chart-container');
            const filtersDiv = container.querySelector('.chart-filters');
            if (filtersDiv) {
                Array.from(filtersDiv.children).forEach(pill => {
                    if (pill.textContent.includes(filterType)) pill.remove();
                });
            }
        }
        
        function refreshChartWithFilters(chartId) {
            const filters = chartFilters[chartId] || {};
            // Apply filters and redraw chart
            console.log(`Refreshing ${chartId} with filters:`, filters);
            // Implementation depends on backend API
        }
        
        // ============================================
        // BRUSH SELECTION
        // ============================================
        
        let brushSelection = { start: null, end: null };
        
        function initBrushSelection(chartId) {
            const chart = document.getElementById(chartId);
            if (!chart) return;
            
            // Add brush mode to Plotly config
            chart.on('plotly_selected', (eventData) => {
                if (!eventData || !eventData.range) return;
                
                brushSelection.start = eventData.range.x[0];
                brushSelection.end = eventData.range.x[1];
                
                showBrushControls();
            });
        }
        
        function showBrushControls() {
            const controls = document.getElementById('brushControls');
            const rangeDisplay = document.getElementById('brushRange');
            
            if (brushSelection.start && brushSelection.end) {
                const start = new Date(brushSelection.start).toLocaleDateString();
                const end = new Date(brushSelection.end).toLocaleDateString();
                rangeDisplay.textContent = `${start} - ${end}`;
                controls.classList.add('active');
            }
        }
        
        function applyBrushSelection() {
            if (!brushSelection.start || !brushSelection.end) return;
            
            // Sync all time-series charts to this range
            syncChartRanges(brushSelection.start, brushSelection.end);
            
            showToast('Time range applied to all charts', 'success');
        }
        
        function clearBrushSelection() {
            brushSelection = { start: null, end: null };
            document.getElementById('brushControls').classList.remove('active');
            
            // Reset all charts to full range
            resetChartRanges();
            
            showToast('Selection cleared', 'info');
        }
        
        function syncChartRanges(start, end) {
            const timeSeriesCharts = ['equityChart', 'returnsChart', 'drawdownChart', 'candlestickChart'];
            
            timeSeriesCharts.forEach(chartId => {
                const chart = document.getElementById(chartId);
                if (chart && chart.layout) {
                    Plotly.relayout(chartId, {
                        'xaxis.range': [start, end]
                    });
                }
            });
        }
        
        function resetChartRanges() {
            const timeSeriesCharts = ['equityChart', 'returnsChart', 'drawdownChart', 'candlestickChart'];
            
            timeSeriesCharts.forEach(chartId => {
                const chart = document.getElementById(chartId);
                if (chart && chart.layout) {
                    Plotly.relayout(chartId, {
                        'xaxis.autorange': true
                    });
                }
            });
        }
        
        // ============================================
        // COMPARISON MODE
        // ============================================
        
        let comparisonMode = false;
        let selectedStrategies = [];
        
        function toggleComparisonMode() {
            comparisonMode = !comparisonMode;
            const toggle = document.getElementById('comparisonToggle');
            
            if (comparisonMode) {
                toggle.classList.add('active');
                loadStrategySelector();
            } else {
                toggle.classList.remove('active');
                clearComparison();
            }
        }
        
        function loadStrategySelector() {
            const selector = document.getElementById('comparisonSelector');
            const strategies = AppState.data.strategies?.strategies || [];
            
            selector.innerHTML = strategies.map(s => `
                <label class="strategy-checkbox">
                    <input type="checkbox" value="${s.name}" onchange="toggleStrategy('${s.name}')">
                    <span>${s.name}</span>
                </label>
            `).join('');
        }
        
        function toggleStrategy(name) {
            const index = selectedStrategies.indexOf(name);
            if (index > -1) {
                selectedStrategies.splice(index, 1);
            } else {
                selectedStrategies.push(name);
            }
        }
        
        function applyComparison() {
            if (selectedStrategies.length < 2) {
                showToast('Please select at least 2 strategies', 'warning');
                return;
            }
            
            overlayStrategies(selectedStrategies);
            showToast(`Comparing ${selectedStrategies.length} strategies`, 'success');
        }
        
        function overlayStrategies(strategies) {
            // Create overlay chart with multiple traces
            const traces = strategies.map((name, index) => {
                const strategy = AppState.data.strategies.strategies.find(s => s.name === name);
                const colors = ['#0066ff', '#00d4aa', '#f59e0b', '#ef4444', '#8b5cf6'];
                
                return {
                    x: strategy.timestamps || [],
                    y: strategy.equity || [],
                    type: 'scatter',
                    mode: 'lines',
                    name: name,
                    line: { color: colors[index % colors.length], width: 2 }
                };
            });
            
            const isDark = AppState.theme === 'dark' || AppState.theme === 'bloomberg';
            const layout = {
                title: 'Strategy Comparison',
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: isDark ? '#e0e0e0' : '#0f172a' },
                xaxis: { gridcolor: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' },
                yaxis: { gridcolor: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)', title: 'Equity (‚Ç¨)' },
                showlegend: true,
                legend: { x: 0, y: 1 }
            };
            
            // Replace strategiesDetailChart with comparison
            Plotly.newPlot('strategiesDetailChart', traces, layout, { responsive: true });
        }
        
        function clearComparison() {
            selectedStrategies = [];
            comparisonMode = false;
            document.getElementById('comparisonToggle').classList.remove('active');
            
            // Restore original strategies chart
            if (AppState.data.strategies) {
                updateStrategiesChart(AppState.data.strategies);
            }
        }
        
        // ============================================
        // ENHANCED CSV EXPORT
        // ============================================
        
        function exportToCSV(tableId, filename) {
            const table = document.querySelector(`#${tableId} table`);
            if (!table) {
                showToast('Table not found', 'danger');
                return;
            }
            
            let csv = [];
            const rows = table.querySelectorAll('tr');
            
            rows.forEach(row => {
                const cols = row.querySelectorAll('th, td');
                const rowData = Array.from(cols).map(col => {
                    // Clean text and handle special characters
                    let text = col.textContent.trim();
                    // Escape quotes
                    text = text.replace(/"/g, '""');
                    // Wrap in quotes if contains comma
                    if (text.includes(',')) text = `"${text}"`;
                    return text;
                });
                csv.push(rowData.join(','));
            });
            
            // Add metadata header
            const metadata = [
                `"Exported from BotV2 Dashboard"`,
                `"Date: ${new Date().toISOString()}"`,
                `"Version: 3.2.0"`,
                '""' // Empty row
            ];
            
            const fullCSV = [...metadata, ...csv].join('\n');
            
            // Download
            const blob = new Blob([fullCSV], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename || 'export'}_${Date.now()}.csv`;
            a.click();
            
            showToast('CSV exported successfully', 'success');
        }
        
        // ============================================
        // ANNOTATIONS
        // ============================================
        
        const annotations = JSON.parse(localStorage.getItem('chartAnnotations')) || {};
        
        function addAnnotation(chartId, date, text, type = 'custom') {
            if (!annotations[chartId]) annotations[chartId] = [];
            
            const annotation = {
                id: Date.now(),
                date: date,
                text: text,
                type: type,
                timestamp: new Date().toISOString()
            };
            
            annotations[chartId].push(annotation);
            localStorage.setItem('chartAnnotations', JSON.stringify(annotations));
            
            // Redraw chart with annotation
            renderAnnotations(chartId);
            
            showToast('Annotation added', 'success');
        }
        
        function renderAnnotations(chartId) {
            const chart = document.getElementById(chartId);
            if (!chart || !annotations[chartId]) return;
            
            const shapes = annotations[chartId].map(ann => ({
                type: 'line',
                x0: ann.date,
                x1: ann.date,
                y0: 0,
                y1: 1,
                yref: 'paper',
                line: {
                    color: getAnnotationColor(ann.type),
                    width: 2,
                    dash: 'dash'
                }
            }));
            
            const annotationLabels = annotations[chartId].map(ann => ({
                x: ann.date,
                y: 1,
                yref: 'paper',
                text: ann.text,
                showarrow: true,
                arrowhead: 2,
                ax: 0,
                ay: -30,
                bgcolor: getAnnotationColor(ann.type),
                bordercolor: 'white',
                borderwidth: 1
            }));
            
            Plotly.relayout(chartId, {
                shapes: shapes,
                annotations: annotationLabels
            });
        }
        
        function getAnnotationColor(type) {
            const colors = {
                'trade': '#10b981',
                'signal': '#3b82f6',
                'news': '#ef4444',
                'custom': '#f59e0b'
            };
            return colors[type] || colors.custom;
        }
        
        // ============================================
        // SPARKLINES
        // ============================================
        
        function createSparkline(data, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const trace = {
                y: data,
                type: 'scatter',
                mode: 'lines',
                line: { color: data[data.length - 1] >= data[0] ? '#10b981' : '#ef4444', width: 1.5 },
                fill: 'tozeroy',
                fillcolor: data[data.length - 1] >= data[0] ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)',
                hoverinfo: 'y'
            };
            
            const layout = {
                width: 80,
                height: 24,
                margin: { l: 0, r: 0, t: 0, b: 0 },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                xaxis: { visible: false },
                yaxis: { visible: false },
                showlegend: false
            };
            
            Plotly.newPlot(containerId, [trace], layout, { displayModeBar: false, staticPlot: false });
        }
        
        // ============================================
        // TRADE SIGNALS
        // ============================================
        
        function addTradeSignals(chartId, signals) {
            const chart = document.getElementById(chartId);
            if (!chart) return;
            
            const buySignals = {
                x: signals.filter(s => s.type === 'buy').map(s => s.date),
                y: signals.filter(s => s.type === 'buy').map(s => s.price),
                mode: 'markers',
                type: 'scatter',
                name: 'Buy Signal',
                marker: {
                    color: '#10b981',
                    size: 12,
                    symbol: 'triangle-up',
                    line: { color: 'white', width: 2 }
                },
                text: signals.filter(s => s.type === 'buy').map(s => `Buy: ‚Ç¨${s.price}`),
                hoverinfo: 'text'
            };
            
            const sellSignals = {
                x: signals.filter(s => s.type === 'sell').map(s => s.date),
                y: signals.filter(s => s.type === 'sell').map(s => s.price),
                mode: 'markers',
                type: 'scatter',
                name: 'Sell Signal',
                marker: {
                    color: '#ef4444',
                    size: 12,
                    symbol: 'triangle-down',
                    line: { color: 'white', width: 2 }
                },
                text: signals.filter(s => s.type === 'sell').map(s => `Sell: ‚Ç¨${s.price}`),
                hoverinfo: 'text'
            };
            
            Plotly.addTraces(chartId, [buySignals, sellSignals]);
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        // Add to existing DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            // ... existing init code ...
            
            // Initialize Phase 2 Part 2 features
            initPhase2Part2();
        });
        
        function initPhase2Part2() {
            // Enable brush selection on equity chart
            setTimeout(() => {
                initBrushSelection('equityChart');
            }, 1000);
            
            // Load saved annotations
            Object.keys(annotations).forEach(chartId => {
                renderAnnotations(chartId);
            });
            
            // Add click listeners to charts for modal
            ['equityChart', 'strategiesChart', 'heatmapChart'].forEach(chartId => {
                const chart = document.getElementById(chartId);
                if (chart) {
                    chart.on('plotly_click', (data) => {
                        const point = data.points[0];
                        openModal('chart', {
                            x: point.x,
                            y: point.y,
                            chartId: chartId
                        });
                    });
                }
            });
            
            // Add comparison mode button to topbar
            const compareBtn = document.createElement('button');
            compareBtn.className = 'action-btn';
            compareBtn.innerHTML = '<span>üìä</span><span class="action-text">Compare</span>';
            compareBtn.onclick = toggleComparisonMode;
            document.querySelector('.topbar-actions').prepend(compareBtn);
            
            console.log('‚úÖ Phase 2 Part 2 features initialized');
        }
        
        // Export functions to window for HTML onclick handlers
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.exportModalData = exportModalData;
        window.applyChartFilter = applyChartFilter;
        window.removeFilter = removeFilter;
        window.applyBrushSelection = applyBrushSelection;
        window.clearBrushSelection = clearBrushSelection;
        window.toggleComparisonMode = toggleComparisonMode;
        window.toggleStrategy = toggleStrategy;
        window.applyComparison = applyComparison;
        window.clearComparison = clearComparison;
        window.exportToCSV = exportToCSV;
        window.addAnnotation = addAnnotation;
        window.createSparkline = createSparkline;
        window.addTradeSignals = addTradeSignals;
    </script>
</body>
</html>