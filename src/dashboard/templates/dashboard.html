<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="BotV2 Professional Trading Dashboard v3.1 - Real-time monitoring with advanced analytics">
    <title>BotV2 Dashboard v3.1 - Ultra-Professional Trading Platform</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <style>
        /* ============================================
           CSS VARIABLES & BASE (Unchanged from v3.0)
           ============================================ */
        :root {
            --primary: #00d4aa;
            --primary-dark: #00b890;
            --secondary: #0066ff;
            --accent: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --bg-primary: #0a0e27;
            --bg-secondary: #1a1f3a;
            --bg-tertiary: #252b48;
            --bg-card: rgba(26, 31, 58, 0.95);
            --bg-hover: rgba(255, 255, 255, 0.05);
            --text-primary: #e0e6ed;
            --text-secondary: #8b949e;
            --text-tertiary: #6b7280;
            --text-success: #10b981;
            --text-danger: #ef4444;
            --border-color: rgba(79, 209, 197, 0.2);
            --border-color-subtle: rgba(255, 255, 255, 0.1);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            --radius-sm: 0.25rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-full: 9999px;
            --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-mono: 'SF Mono', Monaco, 'Cascadia Code', Consolas, monospace;
            --topbar-height: 64px;
            --sidebar-width: 280px;
            --transition-fast: all 0.15s ease;
            --transition-base: all 0.3s ease;
            --transition-slow: all 0.5s ease;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; scroll-behavior: smooth; }
        body {
            font-family: var(--font-sans);
            background: linear-gradient(135deg, var(--bg-primary) 0%, #0f1629 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* ============================================
           LAYOUT (Reused from v3.0 with enhancements)
           ============================================ */
        .dashboard-container { display: flex; flex-direction: column; min-height: 100vh; }
        
        .topbar {
            height: var(--topbar-height);
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--spacing-xl);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
        }
        
        .topbar-left { display: flex; align-items: center; gap: var(--spacing-lg); }
        .logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: var(--radius-full);
            background: var(--success);
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .topbar-center { display: flex; align-items: center; gap: var(--spacing-lg); }
        .topbar-stat { display: flex; flex-direction: column; align-items: center; }
        .topbar-stat-label {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .topbar-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .topbar-stat-value.positive { color: var(--success); }
        .topbar-stat-value.negative { color: var(--danger); }
        
        .topbar-right { display: flex; align-items: center; gap: var(--spacing-md); }
        .user-badge {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(0, 212, 170, 0.1);
            border: 1px solid var(--primary);
            border-radius: var(--radius-full);
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--bg-primary);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 700;
            font-size: 0.875rem;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            transition: var(--transition-fast);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 212, 170, 0.4); }
        .btn-danger { background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%); color: white; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        
        .main-content {
            flex: 1;
            padding: var(--spacing-xl);
            max-width: 1920px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* ============================================
           GRID & CARDS (Enhanced)
           ============================================ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }
        .grid-col-3 { grid-column: span 3; }
        .grid-col-4 { grid-column: span 4; }
        .grid-col-6 { grid-column: span 6; }
        .grid-col-8 { grid-column: span 8; }
        .grid-col-9 { grid-column: span 9; }
        .grid-col-12 { grid-column: span 12; }
        
        .card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-md);
            transition: var(--transition-base);
            position: relative;
            overflow: hidden;
        }
        .card:hover { border-color: var(--primary); box-shadow: var(--shadow-xl); }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-color-subtle);
        }
        .card-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        .card-subtitle { font-size: 0.875rem; color: var(--text-tertiary); margin-top: var(--spacing-xs); }
        .card-actions { display: flex; gap: var(--spacing-sm); }
        
        .icon-btn {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            background: transparent;
            border: 1px solid var(--border-color-subtle);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
            font-size: 0.875rem;
        }
        .icon-btn:hover { background: var(--primary); color: var(--bg-primary); border-color: var(--primary); }
        
        /* ============================================
           METRICS (Enhanced)
           ============================================ */
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }
        .metric-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color-subtle);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            transition: var(--transition-fast);
            position: relative;
            overflow: hidden;
        }
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            transform: scaleY(0);
            transform-origin: bottom;
            transition: transform 0.3s ease;
        }
        .metric-card:hover::before { transform: scaleY(1); }
        .metric-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        
        .metric-label {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--spacing-xs);
        }
        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            font-family: var(--font-mono);
        }
        .metric-value.success { color: var(--success); }
        .metric-value.danger { color: var(--danger); }
        .metric-value.warning { color: var(--warning); }
        .metric-change {
            font-size: 0.875rem;
            margin-top: var(--spacing-xs);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        .metric-change.positive { color: var(--success); }
        .metric-change.negative { color: var(--danger); }
        
        /* ============================================
           CHARTS (NEW v3.1 - Enhanced)
           ============================================ */
        .chart-wrapper {
            position: relative;
            width: 100%;
        }
        
        .chart-container {
            width: 100%;
            height: 400px;
            position: relative;
        }
        .chart-container.large { height: 500px; }
        .chart-container.small { height: 300px; }
        
        /* Loading Skeleton */
        .chart-skeleton {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                var(--bg-tertiary) 25%,
                var(--bg-secondary) 50%,
                var(--bg-tertiary) 75%
            );
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
            border-radius: var(--radius-md);
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .chart-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--text-secondary);
            z-index: 10;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--bg-tertiary);
            border-top-color: var(--primary);
            border-radius: var(--radius-full);
            animation: spin 0.8s linear infinite;
            margin: 0 auto var(--spacing-md);
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Empty State */
        .chart-empty {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--text-tertiary);
        }
        .chart-empty-icon { font-size: 3rem; opacity: 0.5; margin-bottom: var(--spacing-md); }
        .chart-empty-text { font-size: 0.875rem; }
        
        /* Chart Controls (NEW v3.1) */
        .chart-controls {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
            flex-wrap: wrap;
        }
        .chart-control-btn {
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        .chart-control-btn:hover,
        .chart-control-btn.active {
            background: var(--primary);
            color: var(--bg-primary);
            border-color: var(--primary);
        }
        
        /* Time Range Selector (NEW v3.1) */
        .time-range-selector {
            display: flex;
            gap: var(--spacing-xs);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: var(--spacing-xs);
        }
        .time-range-btn {
            padding: var(--spacing-xs) var(--spacing-md);
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        .time-range-btn:hover { background: var(--bg-hover); }
        .time-range-btn.active {
            background: var(--primary);
            color: var(--bg-primary);
        }
        
        /* Fullscreen Mode (NEW v3.1) */
        .chart-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 9999;
            padding: var(--spacing-xl);
            display: none;
        }
        .chart-fullscreen.active { display: block; }
        .chart-fullscreen .chart-container { height: calc(100vh - 120px); }
        
        /* ============================================
           TABLES (Enhanced)
           ============================================ */
        .table-container {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 500px;
            border-radius: var(--radius-md);
        }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        thead { position: sticky; top: 0; background: var(--bg-tertiary); z-index: 10; }
        th {
            padding: var(--spacing-md);
            text-align: left;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid var(--border-color);
        }
        td {
            padding: var(--spacing-md);
            font-size: 0.875rem;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color-subtle);
        }
        tbody tr { transition: var(--transition-fast); }
        tbody tr:hover { background: var(--bg-hover); cursor: pointer; }
        
        .table-badge {
            display: inline-block;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge-success { background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid var(--success); }
        .badge-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        .badge-warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); border: 1px solid var(--warning); }
        .badge-info { background: rgba(59, 130, 246, 0.1); color: var(--info); border: 1px solid var(--info); }
        
        /* ============================================
           ALERTS (Enhanced)
           ============================================ */
        .alert-container {
            position: fixed;
            top: calc(var(--topbar-height) + var(--spacing-lg));
            right: var(--spacing-lg);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            max-width: 400px;
        }
        .alert {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-left-width: 4px;
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-xl);
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .alert.success { border-left-color: var(--success); }
        .alert.danger { border-left-color: var(--danger); }
        .alert.warning { border-left-color: var(--warning); }
        .alert.info { border-left-color: var(--info); }
        .alert-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm); }
        .alert-title { font-weight: 700; font-size: 0.875rem; }
        .alert-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.25rem;
            line-height: 1;
            padding: 0;
        }
        .alert-message { font-size: 0.875rem; color: var(--text-secondary); }
        
        /* ============================================
           RESPONSIVE (Enhanced)
           ============================================ */
        @media (max-width: 1200px) {
            .grid-col-3 { grid-column: span 6; }
            .grid-col-4 { grid-column: span 6; }
            .grid-col-8 { grid-column: span 12; }
            .grid-col-9 { grid-column: span 12; }
        }
        @media (max-width: 768px) {
            .topbar { padding: 0 var(--spacing-md); }
            .topbar-center { display: none; }
            .main-content { padding: var(--spacing-md); }
            .dashboard-grid { gap: var(--spacing-md); }
            .grid-col-3, .grid-col-4, .grid-col-6, .grid-col-8, .grid-col-9, .grid-col-12 { grid-column: span 12; }
            .metric-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
            .chart-container { height: 300px; }
            .chart-container.large { height: 350px; }
        }
        
        /* ============================================
           UTILITIES
           ============================================ */
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .text-warning { color: var(--warning); }
        .text-info { color: var(--info); }
        .text-muted { color: var(--text-tertiary); }
        .font-mono { font-family: var(--font-mono); }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Topbar (Unchanged from v3.0) -->
        <div class="topbar">
            <div class="topbar-left">
                <a href="/" class="logo">
                    <span>ü§ñ</span>
                    <span>BotV2</span>
                    <span style="font-size: 0.625rem; color: var(--text-tertiary); font-weight: 400;">v3.1</span>
                </a>
                <div class="status-indicator"></div>
            </div>
            <div class="topbar-center">
                <div class="topbar-stat">
                    <div class="topbar-stat-label">Equity</div>
                    <div class="topbar-stat-value" id="topbarEquity">‚Ç¨0.00</div>
                </div>
                <div class="topbar-stat">
                    <div class="topbar-stat-label">Daily P&L</div>
                    <div class="topbar-stat-value" id="topbarPnL">‚Ç¨0.00</div>
                </div>
                <div class="topbar-stat">
                    <div class="topbar-stat-label">Win Rate</div>
                    <div class="topbar-stat-value" id="topbarWinRate">0%</div>
                </div>
            </div>
            <div class="topbar-right">
                <div class="user-badge">
                    <span>üë§</span>
                    <span>{{ user }}</span>
                </div>
                <button class="btn btn-secondary" onclick="refreshDashboard()">üîÑ Refresh</button>
                <a href="/logout" class="btn btn-danger">Logout</a>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Overview KPIs -->
            <div class="dashboard-grid">
                <div class="grid-col-12">
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">üìä Portfolio Overview</div>
                                <div class="card-subtitle">Real-time performance metrics</div>
                            </div>
                            <div class="card-actions">
                                <button class="icon-btn" title="Export" onclick="exportData()">üì•</button>
                                <button class="icon-btn" title="Refresh" onclick="refreshOverview()">üîÑ</button>
                            </div>
                        </div>
                        <div class="metric-grid" id="metricsGrid">
                            <div class="metric-card">
                                <div class="metric-label">Total Equity</div>
                                <div class="metric-value" id="metricEquity">‚Ç¨0.00</div>
                                <div class="metric-change positive" id="metricEquityChange">+0.00%</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Total Return</div>
                                <div class="metric-value" id="metricReturn">0.00%</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Sharpe Ratio</div>
                                <div class="metric-value" id="metricSharpe">0.00</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Max Drawdown</div>
                                <div class="metric-value danger" id="metricDrawdown">0.00%</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Win Rate</div>
                                <div class="metric-value" id="metricWinRate">0.00%</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Total Trades</div>
                                <div class="metric-value" id="metricTrades">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Row 1: Equity + Waterfall -->
            <div class="dashboard-grid">
                <div class="grid-col-8">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìà Equity Curve</div>
                            <div class="card-actions">
                                <button class="icon-btn" title="Export PNG" onclick="exportChart('equityChart', 'png')">üì∑</button>
                                <button class="icon-btn" title="Fullscreen" onclick="toggleFullscreen('equityChart')">‚õ∂</button>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-container large" id="equityChartContainer">
                                <div class="chart-skeleton" id="equitySkeleton"></div>
                                <div id="equityChart"></div>
                            </div>
                            <div class="chart-controls">
                                <div class="time-range-selector">
                                    <button class="time-range-btn" onclick="setTimeRange('1D')">1D</button>
                                    <button class="time-range-btn" onclick="setTimeRange('1W')">1W</button>
                                    <button class="time-range-btn" onclick="setTimeRange('1M')">1M</button>
                                    <button class="time-range-btn" onclick="setTimeRange('3M')">3M</button>
                                    <button class="time-range-btn active" onclick="setTimeRange('ALL')">ALL</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grid-col-4">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üíß P&L Waterfall</div>
                            <div class="card-actions">
                                <button class="icon-btn" title="Export" onclick="exportChart('waterfallChart', 'png')">üì•</button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-skeleton" id="waterfallSkeleton"></div>
                            <div id="waterfallChart"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Row 2: Strategies + Risk Scatter -->
            <div class="dashboard-grid">
                <div class="grid-col-4">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìä Strategies</div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-skeleton" id="strategiesSkeleton"></div>
                            <div id="strategiesChart"></div>
                        </div>
                    </div>
                </div>
                <div class="grid-col-4">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üéØ Risk vs Return</div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-skeleton" id="scatterSkeleton"></div>
                            <div id="scatterChart"></div>
                        </div>
                    </div>
                </div>
                <div class="grid-col-4">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìâ Return Distribution</div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-skeleton" id="boxplotSkeleton"></div>
                            <div id="boxplotChart"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Row 3: Drawdown + Heatmap + Treemap -->
            <div class="dashboard-grid">
                <div class="grid-col-6">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üåä Drawdown Underwater</div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-skeleton" id="drawdownSkeleton"></div>
                            <div id="drawdownChart"></div>
                        </div>
                    </div>
                </div>
                <div class="grid-col-6">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üî• Correlation Heatmap</div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-skeleton" id="heatmapSkeleton"></div>
                            <div id="heatmapChart"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Row 4: Risk Metrics -->
            <div class="dashboard-grid">
                <div class="grid-col-12">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">‚ö†Ô∏è Risk Metrics</div>
                        </div>
                        <div class="metric-grid">
                            <div class="metric-card">
                                <div class="metric-label">Volatility</div>
                                <div class="metric-value" id="riskVolatility">0.00%</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">VaR (95%)</div>
                                <div class="metric-value danger" id="riskVaR">0.00%</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Sortino Ratio</div>
                                <div class="metric-value" id="riskSortino">0.00</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Calmar Ratio</div>
                                <div class="metric-value" id="riskCalmar">0.00</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Beta</div>
                                <div class="metric-value" id="riskBeta">1.00</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Alpha</div>
                                <div class="metric-value" id="riskAlpha">0.00%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Row 5: Trades Table -->
            <div class="dashboard-grid">
                <div class="grid-col-12">
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">üíº Recent Trades</div>
                                <div class="card-subtitle">Last 50 executed trades</div>
                            </div>
                            <div class="card-actions">
                                <button class="icon-btn" title="Export CSV" onclick="exportTrades()">üìÑ</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="tradesTable">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Strategy</th>
                                        <th>Symbol</th>
                                        <th>Action</th>
                                        <th>Size</th>
                                        <th>Entry Price</th>
                                        <th>P&L</th>
                                        <th>P&L %</th>
                                    </tr>
                                </thead>
                                <tbody id="tradesTableBody">
                                    <tr>
                                        <td colspan="8" style="text-align: center; color: var(--text-tertiary);">
                                            No trades yet. Waiting for data...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Alert Container -->
    <div class="alert-container" id="alertContainer"></div>
    
    <!-- JavaScript (ENHANCED v3.1) -->
    <script>
        console.log('üöÄ BotV2 Dashboard v3.1 Ultra-Enhanced loading...');
        
        // ============================================
        // GLOBAL STATE
        // ============================================
        const AppState = {
            connected: false,
            socket: null,
            timeRange: 'ALL',
            chartCache: {},
            data: {
                overview: {},
                equity: {},
                trades: [],
                strategies: {},
                risk: {}
            }
        };
        
        // ============================================
        // CHART CONFIGURATIONS (NEW v3.1)
        // ============================================
        const ChartConfig = {
            baseLayout: {
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: '#e0e6ed', family: "'-apple-system', 'Segoe UI', sans-serif" },
                margin: { l: 60, r: 40, t: 20, b: 60 },
                xaxis: { gridcolor: 'rgba(255,255,255,0.05)', showgrid: true, zeroline: false },
                yaxis: { gridcolor: 'rgba(255,255,255,0.05)', showgrid: true, zeroline: false },
                hovermode: 'closest'
            },
            baseConfig: {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['lasso2d', 'select2d', 'autoScale2d'],
                toImageButtonOptions: {
                    format: 'png',
                    filename: 'chart',
                    height: 800,
                    width: 1200,
                    scale: 2
                }
            },
            colors: {
                primary: '#00d4aa',
                secondary: '#0066ff',
                success: '#10b981',
                danger: '#ef4444',
                warning: '#f59e0b',
                info: '#3b82f6',
                palette: ['#00d4aa', '#0066ff', '#f59e0b', '#ef4444', '#8b5cf6', '#10b981', '#ec4899']
            }
        };
        
        // ============================================
        // WEBSOCKET (Same as v3.0)
        // ============================================
        function initWebSocket() {
            console.log('üîå Connecting to WebSocket...');
            AppState.socket = io({ reconnection: true, reconnectionDelay: 1000, reconnectionAttempts: 10 });
            AppState.socket.on('connect', () => {
                console.log('‚úÖ WebSocket connected');
                AppState.connected = true;
                showAlert('Connected', 'Real-time updates active', 'success');
                requestAllData();
            });
            AppState.socket.on('disconnect', () => {
                console.log('‚ùå WebSocket disconnected');
                AppState.connected = false;
                showAlert('Disconnected', 'Reconnecting...', 'warning');
            });
            AppState.socket.on('update', (data) => handleUpdate(data));
            AppState.socket.on('alert', (alert) => showAlert(alert.level.toUpperCase(), alert.message, alert.level));
        }
        function requestAllData() {
            if (!AppState.socket || !AppState.connected) return;
            AppState.socket.emit('request_update', { component: 'all' });
        }
        function handleUpdate(data) {
            if (data.overview) { AppState.data.overview = data.overview; updateOverview(data.overview); }
            if (data.equity) { AppState.data.equity = data.equity; updateEquityChart(data.equity); updateDrawdownChart(data.equity); updateWaterfallChart(data.equity); }
            if (data.strategies) { AppState.data.strategies = data.strategies; updateStrategiesChart(data.strategies); updateScatterChart(data.strategies); updateBoxPlotChart(data.strategies); updateHeatmapChart(data.strategies); }
            if (data.risk) { AppState.data.risk = data.risk; updateRiskMetrics(data.risk); }
        }
        
        // ============================================
        // API CALLS (Same as v3.0)
        // ============================================
        async function fetchData(endpoint) {
            try {
                const response = await fetch(endpoint);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`Error fetching ${endpoint}:`, error);
                showAlert('Error', `Failed to fetch data from ${endpoint}`, 'danger');
                return null;
            }
        }
        async function loadAllData() {
            console.log('üìä Loading initial data...');
            const [overview, equity, trades, strategies, risk] = await Promise.all([
                fetchData('/api/overview'),
                fetchData('/api/equity'),
                fetchData('/api/trades'),
                fetchData('/api/strategies'),
                fetchData('/api/risk')
            ]);
            if (overview) { AppState.data.overview = overview; updateOverview(overview); }
            if (equity) { AppState.data.equity = equity; updateEquityChart(equity); updateDrawdownChart(equity); updateWaterfallChart(equity); }
            if (trades) { AppState.data.trades = trades.trades || []; updateTradesTable(trades.trades || []); }
            if (strategies) { AppState.data.strategies = strategies; updateStrategiesChart(strategies); updateScatterChart(strategies); updateBoxPlotChart(strategies); updateHeatmapChart(strategies); }
            if (risk) { AppState.data.risk = risk; updateRiskMetrics(risk); }
            console.log('‚úÖ Initial data loaded');
        }
        
        // ============================================
        // UPDATE OVERVIEW (Same as v3.0)
        // ============================================
        function updateOverview(data) {
            document.getElementById('topbarEquity').textContent = formatCurrency(data.equity);
            document.getElementById('topbarPnL').textContent = formatCurrency(data.daily_change);
            document.getElementById('topbarPnL').className = 'topbar-stat-value ' + (data.daily_change >= 0 ? 'positive' : 'negative');
            document.getElementById('topbarWinRate').textContent = formatPercent(data.win_rate);
            document.getElementById('metricEquity').textContent = formatCurrency(data.equity);
            document.getElementById('metricEquityChange').textContent = formatPercent(data.daily_change_pct, true);
            document.getElementById('metricEquityChange').className = 'metric-change ' + (data.daily_change_pct >= 0 ? 'positive' : 'negative');
            document.getElementById('metricReturn').textContent = formatPercent(data.total_return);
            document.getElementById('metricReturn').className = 'metric-value ' + (data.total_return >= 0 ? 'success' : 'danger');
            document.getElementById('metricSharpe').textContent = data.sharpe_ratio.toFixed(2);
            document.getElementById('metricDrawdown').textContent = formatPercent(Math.abs(data.max_drawdown));
            document.getElementById('metricWinRate').textContent = formatPercent(data.win_rate);
            document.getElementById('metricTrades').textContent = data.total_trades;
        }
        
        // ============================================
        // ENHANCED CHARTS (NEW v3.1)
        // ============================================
        
        // Hide skeleton after chart loads
        function hideChartSkeleton(chartId) {
            const skeleton = document.getElementById(chartId + 'Skeleton');
            if (skeleton) {
                skeleton.style.transition = 'opacity 0.3s ease';
                skeleton.style.opacity = '0';
                setTimeout(() => skeleton.style.display = 'none', 300);
            }
        }
        
        // Show empty state
        function showChartEmpty(containerId, message = 'No data available') {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = `
                <div class="chart-empty">
                    <div class="chart-empty-icon">üìä</div>
                    <div class="chart-empty-text">${message}</div>
                </div>
            `;
        }
        
        // 1. Equity Chart (Enhanced with annotations)
        function updateEquityChart(data) {
            if (!data.equity || data.equity.length === 0) {
                showChartEmpty('equityChart', 'No equity data yet. Start trading to see your performance.');
                hideChartSkeleton('equity');
                return;
            }
            
            const trace = {
                x: data.timestamps || [],
                y: data.equity || [],
                type: 'scatter',
                mode: 'lines',
                name: 'Equity',
                line: { color: ChartConfig.colors.primary, width: 3 },
                fill: 'tozeroy',
                fillcolor: 'rgba(0, 212, 170, 0.1)',
                hovertemplate: '<b>%{y:,.2f} ‚Ç¨</b><br>%{x}<extra></extra>'
            };
            
            const layout = {
                ...ChartConfig.baseLayout,
                yaxis: { ...ChartConfig.baseLayout.yaxis, title: 'Equity (‚Ç¨)' },
                hovermode: 'x unified'
            };
            
            Plotly.newPlot('equityChart', [trace], layout, ChartConfig.baseConfig).then(() => {
                hideChartSkeleton('equity');
            });
        }
        
        // 2. Waterfall Chart (NEW v3.1)
        function updateWaterfallChart(data) {
            // Mock waterfall data - replace with real calculation
            const categories = ['Initial', 'Wins', 'Losses', 'Fees', 'Final'];
            const values = [10000, 2500, -800, -150, 11550];
            const measures = ['absolute', 'relative', 'relative', 'relative', 'total'];
            
            const trace = {
                type: 'waterfall',
                x: categories,
                y: values,
                measure: measures,
                text: values.map(v => `‚Ç¨${v.toFixed(0)}`),
                textposition: 'outside',
                connector: { line: { color: 'rgba(255,255,255,0.2)' } },
                increasing: { marker: { color: ChartConfig.colors.success } },
                decreasing: { marker: { color: ChartConfig.colors.danger } },
                totals: { marker: { color: ChartConfig.colors.info } }
            };
            
            const layout = {
                ...ChartConfig.baseLayout,
                showlegend: false,
                yaxis: { ...ChartConfig.baseLayout.yaxis, title: 'Amount (‚Ç¨)' }
            };
            
            Plotly.newPlot('waterfallChart', [trace], layout, ChartConfig.baseConfig).then(() => {
                hideChartSkeleton('waterfall');
            });
        }
        
        // 3. Strategies Bar Chart (Enhanced)
        function updateStrategiesChart(data) {
            if (!data.strategies || data.strategies.length === 0) {
                showChartEmpty('strategiesChart', 'No strategies data');
                hideChartSkeleton('strategies');
                return;
            }
            
            const strategies = data.strategies;
            const trace = {
                x: strategies.map(s => s.name),
                y: strategies.map(s => s.total_return),
                type: 'bar',
                marker: {
                    color: strategies.map(s => s.total_return >= 0 ? ChartConfig.colors.success : ChartConfig.colors.danger)
                },
                text: strategies.map(s => `${s.total_return.toFixed(2)}%`),
                textposition: 'outside',
                hovertemplate: '<b>%{x}</b><br>Return: %{y:.2f}%<extra></extra>'
            };
            
            const layout = {
                ...ChartConfig.baseLayout,
                xaxis: { ...ChartConfig.baseLayout.xaxis, tickangle: -45 },
                yaxis: { ...ChartConfig.baseLayout.yaxis, title: 'Return (%)' },
                showlegend: false
            };
            
            Plotly.newPlot('strategiesChart', [trace], layout, { ...ChartConfig.baseConfig, displayModeBar: false }).then(() => {
                hideChartSkeleton('strategies');
            });
        }
        
        // 4. Scatter Risk vs Return (NEW v3.1)
        function updateScatterChart(data) {
            if (!data.strategies || data.strategies.length === 0) {
                showChartEmpty('scatterChart', 'No strategies for comparison');
                hideChartSkeleton('scatter');
                return;
            }
            
            const strategies = data.strategies;
            const trace = {
                x: strategies.map(s => Math.random() * 20), // Mock volatility - replace with real
                y: strategies.map(s => s.total_return),
                mode: 'markers+text',
                type: 'scatter',
                text: strategies.map(s => s.name),
                textposition: 'top center',
                marker: {
                    size: strategies.map(s => Math.abs(s.total_return) * 2 + 10),
                    color: strategies.map(s => s.total_return >= 0 ? ChartConfig.colors.success : ChartConfig.colors.danger),
                    line: { color: 'white', width: 2 }
                },
                hovertemplate: '<b>%{text}</b><br>Volatility: %{x:.2f}%<br>Return: %{y:.2f}%<extra></extra>'
            };
            
            const layout = {
                ...ChartConfig.baseLayout,
                xaxis: { ...ChartConfig.baseLayout.xaxis, title: 'Volatility (Risk)' },
                yaxis: { ...ChartConfig.baseLayout.yaxis, title: 'Return (%)' },
                showlegend: false
            };
            
            Plotly.newPlot('scatterChart', [trace], layout, { ...ChartConfig.baseConfig, displayModeBar: false }).then(() => {
                hideChartSkeleton('scatter');
            });
        }
        
        // 5. Box Plot (NEW v3.1)
        function updateBoxPlotChart(data) {
            if (!data.strategies || data.strategies.length === 0) {
                showChartEmpty('boxplotChart', 'No distribution data');
                hideChartSkeleton('boxplot');
                return;
            }
            
            const strategies = data.strategies;
            const traces = strategies.slice(0, 4).map((s, i) => ({
                y: Array.from({length: 30}, () => s.total_return + (Math.random() - 0.5) * 10), // Mock distribution
                type: 'box',
                name: s.name,
                marker: { color: ChartConfig.colors.palette[i] },
                boxmean: 'sd'
            }));
            
            const layout = {
                ...ChartConfig.baseLayout,
                yaxis: { ...ChartConfig.baseLayout.yaxis, title: 'Return (%)' },
                showlegend: true,
                legend: { x: 0, y: 1 }
            };
            
            Plotly.newPlot('boxplotChart', traces, layout, { ...ChartConfig.baseConfig, displayModeBar: false }).then(() => {
                hideChartSkeleton('boxplot');
            });
        }
        
        // 6. Drawdown Underwater (NEW v3.1)
        function updateDrawdownChart(data) {
            if (!data.drawdown || data.drawdown.length === 0) {
                showChartEmpty('drawdownChart', 'No drawdown data');
                hideChartSkeleton('drawdown');
                return;
            }
            
            const trace = {
                x: data.timestamps || [],
                y: data.drawdown.map(d => d * 100), // Convert to percentage
                type: 'scatter',
                mode: 'lines',
                fill: 'tozeroy',
                fillcolor: 'rgba(239, 68, 68, 0.2)',
                line: { color: ChartConfig.colors.danger, width: 2 },
                hovertemplate: '<b>%{y:.2f}%</b><br>%{x}<extra></extra>'
            };
            
            const layout = {
                ...ChartConfig.baseLayout,
                yaxis: { ...ChartConfig.baseLayout.yaxis, title: 'Drawdown (%)', range: [Math.min(...data.drawdown) * 100 - 5, 5] },
                shapes: [{
                    type: 'line',
                    x0: data.timestamps[0],
                    x1: data.timestamps[data.timestamps.length - 1],
                    y0: 0,
                    y1: 0,
                    line: { color: 'white', width: 1, dash: 'dot' }
                }]
            };
            
            Plotly.newPlot('drawdownChart', [trace], layout, { ...ChartConfig.baseConfig, displayModeBar: false }).then(() => {
                hideChartSkeleton('drawdown');
            });
        }
        
        // 7. Correlation Heatmap (NEW v3.1)
        function updateHeatmapChart(data) {
            if (!data.strategies || data.strategies.length < 2) {
                showChartEmpty('heatmapChart', 'Need at least 2 strategies for correlation');
                hideChartSkeleton('heatmap');
                return;
            }
            
            const strategies = data.strategies.slice(0, 6); // Max 6 for readability
            const n = strategies.length;
            
            // Generate mock correlation matrix - replace with real calculation
            const corrMatrix = Array.from({length: n}, (_, i) => 
                Array.from({length: n}, (_, j) => i === j ? 1 : (Math.random() * 0.6 + 0.2) * (Math.random() > 0.5 ? 1 : -1))
            );
            
            const trace = {
                z: corrMatrix,
                x: strategies.map(s => s.name),
                y: strategies.map(s => s.name),
                type: 'heatmap',
                colorscale: [
                    [0, ChartConfig.colors.danger],
                    [0.5, '#1a1f3a'],
                    [1, ChartConfig.colors.success]
                ],
                zmid: 0,
                text: corrMatrix.map(row => row.map(v => v.toFixed(2))),
                texttemplate: '%{text}',
                textfont: { size: 10 },
                hovertemplate: '%{y} vs %{x}<br>Correlation: %{z:.2f}<extra></extra>',
                showscale: true,
                colorbar: { title: 'Correlation', thickness: 15 }
            };
            
            const layout = {
                ...ChartConfig.baseLayout,
                xaxis: { ...ChartConfig.baseLayout.xaxis, side: 'bottom' },
                yaxis: { ...ChartConfig.baseLayout.yaxis, autorange: 'reversed' }
            };
            
            Plotly.newPlot('heatmapChart', [trace], layout, { ...ChartConfig.baseConfig, displayModeBar: false }).then(() => {
                hideChartSkeleton('heatmap');
            });
        }
        
        // ============================================
        // RISK METRICS (Enhanced)
        // ============================================
        function updateRiskMetrics(data) {
            document.getElementById('riskVolatility').textContent = formatPercent(data.volatility || 0);
            document.getElementById('riskVaR').textContent = formatPercent(Math.abs(data.var_95 || 0));
            document.getElementById('riskSortino').textContent = (data.sortino_ratio || 0).toFixed(2);
            document.getElementById('riskCalmar').textContent = (data.calmar_ratio || 0).toFixed(2);
            document.getElementById('riskBeta').textContent = (data.beta || 1.0).toFixed(2);
            document.getElementById('riskAlpha').textContent = formatPercent(data.alpha || 0);
        }
        
        // ============================================
        // TRADES TABLE (Same as v3.0)
        // ============================================
        function updateTradesTable(trades) {
            const tbody = document.getElementById('tradesTableBody');
            if (!trades || trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-tertiary);">No trades available</td></tr>';
                return;
            }
            tbody.innerHTML = trades.map(trade => `
                <tr>
                    <td class="font-mono">${formatDate(trade.timestamp)}</td>
                    <td>${trade.strategy}</td>
                    <td class="font-mono">${trade.symbol}</td>
                    <td><span class="table-badge ${trade.action === 'BUY' ? 'badge-success' : 'badge-danger'}">${trade.action}</span></td>
                    <td class="font-mono">${trade.size.toFixed(2)}</td>
                    <td class="font-mono">‚Ç¨${trade.entry_price.toFixed(2)}</td>
                    <td class="font-mono ${trade.pnl >= 0 ? 'text-success' : 'text-danger'}">‚Ç¨${trade.pnl.toFixed(2)}</td>
                    <td class="font-mono ${trade.pnl_pct >= 0 ? 'text-success' : 'text-danger'}">${formatPercent(trade.pnl_pct, true)}</td>
                </tr>
            `).join('');
        }
        
        // ============================================
        // INTERACTIVE FEATURES (NEW v3.1)
        // ============================================
        
        // Time Range Selector
        let currentTimeRange = 'ALL';
        function setTimeRange(range) {
            currentTimeRange = range;
            document.querySelectorAll('.time-range-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            // Filter and update equity chart
            if (AppState.data.equity) updateEquityChart(AppState.data.equity);
            showAlert('Time Range', `Showing ${range} data`, 'info');
        }
        
        // Export Chart
        function exportChart(chartId, format = 'png') {
            const chart = document.getElementById(chartId);
            if (!chart) return;
            
            if (format === 'png' || format === 'svg') {
                Plotly.downloadImage(chart, {
                    format: format,
                    width: 1200,
                    height: 800,
                    filename: `${chartId}_${Date.now()}`
                });
                showAlert('Export', `Chart exported as ${format.toUpperCase()}`, 'success');
            } else if (format === 'csv') {
                // Export data as CSV
                const data = chart.data;
                let csv = 'x,y\n';
                if (data[0] && data[0].x && data[0].y) {
                    for (let i = 0; i < data[0].x.length; i++) {
                        csv += `${data[0].x[i]},${data[0].y[i]}\n`;
                    }
                }
                downloadCSV(csv, `${chartId}_data.csv`);
                showAlert('Export', 'Data exported as CSV', 'success');
            }
        }
        
        // Toggle Fullscreen
        function toggleFullscreen(chartId) {
            const element = document.getElementById(chartId + 'Container');
            if (!element) return;
            
            if (!document.fullscreenElement) {
                element.requestFullscreen().catch(err => {
                    showAlert('Error', `Could not enable fullscreen: ${err.message}`, 'danger');
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        // ============================================
        // UTILITY FUNCTIONS (Enhanced)
        // ============================================
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value || 0);
        }
        function formatPercent(value, withSign = false) {
            const formatted = (value || 0).toFixed(2) + '%';
            if (withSign && value > 0) return '+' + formatted;
            return formatted;
        }
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        function showAlert(title, message, level = 'info') {
            const container = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            const alert = document.createElement('div');
            alert.id = alertId;
            alert.className = `alert ${level}`;
            alert.innerHTML = `
                <div class="alert-header">
                    <div class="alert-title">${title}</div>
                    <button class="alert-close" onclick="closeAlert('${alertId}')">&times;</button>
                </div>
                <div class="alert-message">${message}</div>
            `;
            container.appendChild(alert);
            setTimeout(() => closeAlert(alertId), 5000);
        }
        function closeAlert(alertId) {
            const alert = document.getElementById(alertId);
            if (alert) {
                alert.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => alert.remove(), 300);
            }
        }
        
        // ============================================
        // USER ACTIONS
        // ============================================
        function refreshDashboard() {
            showAlert('Refreshing', 'Loading latest data...', 'info');
            loadAllData();
        }
        function refreshOverview() {
            fetchData('/api/overview').then(data => {
                if (data) updateOverview(data);
            });
        }
        function exportData() {
            showAlert('Export', 'Export functionality available for individual charts', 'info');
        }
        function exportTrades() {
            const csv = generateTradesCSV(AppState.data.trades);
            downloadCSV(csv, 'trades.csv');
            showAlert('Success', 'Trades exported to CSV', 'success');
        }
        function generateTradesCSV(trades) {
            const headers = ['Timestamp', 'Strategy', 'Symbol', 'Action', 'Size', 'Entry Price', 'P&L', 'P&L %'];
            const rows = trades.map(t => [
                t.timestamp, t.strategy, t.symbol, t.action, t.size, t.entry_price, t.pnl, t.pnl_pct
            ]);
            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ BotV2 Dashboard v3.1 Ultra-Enhanced initializing...');
            loadAllData();
            initWebSocket();
            setInterval(() => {
                if (!AppState.connected) {
                    console.log('‚ö†Ô∏è WebSocket disconnected, using polling fallback');
                    loadAllData();
                }
            }, 30000);
            console.log('‚úÖ Dashboard v3.1 initialized with 7 advanced charts!');
        });
    </script>
</body>
</html>