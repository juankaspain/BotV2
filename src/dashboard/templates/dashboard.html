<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="BotV2 Professional Trading Dashboard v3.2 Ultra-Advanced - Real-time monitoring with enterprise features">
    <title>BotV2 Dashboard v3.2 - Ultra-Advanced Trading Platform</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* ============================================
           CSS VARIABLES (Enhanced with Light Theme)
           ============================================ */
        :root[data-theme="dark"] {
            --primary: #00d4aa;
            --primary-dark: #00b890;
            --secondary: #0066ff;
            --accent: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --bg-primary: #0a0e27;
            --bg-secondary: #1a1f3a;
            --bg-tertiary: #252b48;
            --bg-card: rgba(26, 31, 58, 0.95);
            --bg-hover: rgba(255, 255, 255, 0.05);
            --bg-overlay: rgba(10, 14, 39, 0.95);
            --text-primary: #e0e6ed;
            --text-secondary: #8b949e;
            --text-tertiary: #6b7280;
            --text-success: #10b981;
            --text-danger: #ef4444;
            --border-color: rgba(79, 209, 197, 0.2);
            --border-color-subtle: rgba(255, 255, 255, 0.1);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        :root[data-theme="light"] {
            --primary: #00a388;
            --primary-dark: #008c74;
            --secondary: #0052cc;
            --accent: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --bg-card: rgba(255, 255, 255, 0.98);
            --bg-hover: rgba(0, 0, 0, 0.05);
            --bg-overlay: rgba(255, 255, 255, 0.95);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-tertiary: #94a3b8;
            --text-success: #10b981;
            --text-danger: #ef4444;
            --border-color: rgba(0, 163, 136, 0.3);
            --border-color-subtle: rgba(0, 0, 0, 0.1);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        :root {
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            --radius-sm: 0.25rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-full: 9999px;
            --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-mono: 'SF Mono', Monaco, 'Cascadia Code', Consolas, monospace;
            --topbar-height: 64px;
            --sidebar-width: 320px;
            --transition-fast: all 0.15s ease;
            --transition-base: all 0.3s ease;
            --transition-slow: all 0.5s ease;
            --z-modal: 10000;
            --z-overlay: 9999;
            --z-sidebar: 9998;
            --z-topbar: 1000;
            --z-alert: 2000;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; scroll-behavior: smooth; }
        body {
            font-family: var(--font-sans);
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        /* Reuse all previous CSS from v3.1 (Layout, Topbar, Cards, Metrics, Charts, Tables, Alerts) */
        /* ... (mantener todo el CSS de v3.1) ... */
        
        /* ============================================
           MODAL SYSTEM (NEW v3.2)
           ============================================ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-overlay);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: var(--z-overlay);
            animation: fadeIn 0.2s ease;
        }
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title { font-size: 1.25rem; font-weight: 700; }
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close:hover { background: var(--bg-hover); color: var(--text-primary); }
        
        .modal-body {
            padding: var(--spacing-lg);
            overflow-y: auto;
            flex: 1;
        }
        
        .modal-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-color-subtle);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
        }
        
        /* Trade Details Modal */
        .trade-detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        .trade-detail-item {
            background: var(--bg-tertiary);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color-subtle);
        }
        .trade-detail-label {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--spacing-xs);
        }
        .trade-detail-value {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
            font-family: var(--font-mono);
        }
        
        /* ============================================
           SIDEBAR PANELS (NEW v3.2)
           ============================================ */
        .sidebar-panel {
            position: fixed;
            top: var(--topbar-height);
            right: -360px;
            width: 360px;
            height: calc(100vh - var(--topbar-height));
            background: var(--bg-card);
            border-left: 1px solid var(--border-color);
            box-shadow: var(--shadow-xl);
            transition: right 0.3s ease;
            z-index: var(--z-sidebar);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .sidebar-panel.active { right: 0; }
        
        .sidebar-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar-title { font-size: 1.125rem; font-weight: 700; }
        .sidebar-close {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-fast);
        }
        .sidebar-close:hover { background: var(--bg-hover); }
        
        .sidebar-body {
            padding: var(--spacing-lg);
            overflow-y: auto;
            flex: 1;
        }
        
        /* Filter Panel */
        .filter-group {
            margin-bottom: var(--spacing-lg);
        }
        .filter-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
            display: block;
        }
        .filter-input {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color-subtle);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: var(--transition-fast);
        }
        .filter-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
        }
        
        .filter-presets {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
        }
        .filter-preset-btn {
            padding: var(--spacing-xs) var(--spacing-md);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color-subtle);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        .filter-preset-btn:hover,
        .filter-preset-btn.active {
            background: var(--primary);
            color: var(--bg-primary);
            border-color: var(--primary);
        }
        
        .filter-actions {
            display: flex;
            gap: var(--spacing-sm);
        }
        
        /* Settings Panel */
        .settings-section {
            margin-bottom: var(--spacing-xl);
        }
        .settings-section-title {
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--border-color-subtle);
        }
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) 0;
            border-bottom: 1px solid var(--border-color-subtle);
        }
        .settings-item:last-child { border-bottom: none; }
        .settings-label { font-size: 0.875rem; color: var(--text-primary); }
        .settings-description { font-size: 0.75rem; color: var(--text-tertiary); margin-top: var(--spacing-xs); }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            border: 1px solid var(--border-color-subtle);
            cursor: pointer;
            transition: var(--transition-base);
        }
        .toggle-switch.active { background: var(--primary); border-color: var(--primary); }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: var(--radius-full);
            transition: var(--transition-base);
        }
        .toggle-switch.active::after { left: 26px; }
        
        /* ============================================
           COMPARISON MODE (NEW v3.2)
           ============================================ */
        .comparison-banner {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: var(--spacing-md) var(--spacing-xl);
            display: none;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .comparison-banner.active { display: flex; }
        .comparison-info { display: flex; align-items: center; gap: var(--spacing-md); }
        .comparison-actions { display: flex; gap: var(--spacing-sm); }
        
        .strategy-selector {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin: var(--spacing-md) 0;
        }
        .strategy-chip {
            padding: var(--spacing-xs) var(--spacing-md);
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color-subtle);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
            user-select: none;
        }
        .strategy-chip:hover { border-color: var(--primary); }
        .strategy-chip.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: var(--bg-primary);
        }
        
        /* ============================================
           TOAST NOTIFICATIONS (NEW v3.2)
           ============================================ */
        .toast-container {
            position: fixed;
            bottom: var(--spacing-lg);
            right: var(--spacing-lg);
            z-index: var(--z-alert);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            max-width: 350px;
        }
        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-left-width: 4px;
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-xl);
            animation: slideInRight 0.3s ease;
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-sm);
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast.success { border-left-color: var(--success); }
        .toast.danger { border-left-color: var(--danger); }
        .toast.warning { border-left-color: var(--warning); }
        .toast.info { border-left-color: var(--info); }
        .toast-icon { font-size: 1.25rem; }
        .toast-content { flex: 1; }
        .toast-title { font-weight: 700; font-size: 0.875rem; margin-bottom: var(--spacing-xs); }
        .toast-message { font-size: 0.75rem; color: var(--text-secondary); }
        .toast-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.125rem;
            padding: 0;
            line-height: 1;
        }
        
        /* ============================================
           KEYBOARD SHORTCUTS HELPER (NEW v3.2)
           ============================================ */
        .shortcuts-help {
            position: fixed;
            bottom: var(--spacing-lg);
            left: var(--spacing-lg);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-lg);
            display: none;
            z-index: var(--z-modal);
        }
        .shortcuts-help.active { display: block; }
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--spacing-lg);
            padding: var(--spacing-xs) 0;
            font-size: 0.75rem;
        }
        .shortcut-key {
            background: var(--bg-tertiary);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color-subtle);
            font-family: var(--font-mono);
            font-weight: 700;
        }
        
        /* ============================================
           UTILITIES (Enhanced)
           ============================================ */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 var(--spacing-xs);
            background: var(--danger);
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            border-radius: var(--radius-full);
        }
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mt-1 { margin-top: var(--spacing-md); }
        .mb-1 { margin-bottom: var(--spacing-md); }
        
        /* Reuse layout, topbar, cards, metrics, charts, tables from v3.1 */
        /* (Include all CSS from v3.1 here - Layout, Topbar, Main Content, Grid, Cards, Metrics, Charts, Tables, Alerts, Responsive) */
        /* ... */
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Comparison Mode Banner (NEW v3.2) -->
        <div class="comparison-banner" id="comparisonBanner">
            <div class="comparison-info">
                <span>üîÑ</span>
                <div>
                    <strong>Comparison Mode Active</strong>
                    <div style="font-size: 0.75rem; opacity: 0.9;">Select strategies to compare</div>
                </div>
            </div>
            <div class="comparison-actions">
                <button class="btn btn-secondary" onclick="exportComparison()">üì• Export</button>
                <button class="btn btn-danger" onclick="toggleComparisonMode()">Exit</button>
            </div>
        </div>
        
        <!-- Topbar (Enhanced v3.2) -->
        <div class="topbar">
            <div class="topbar-left">
                <a href="/" class="logo">
                    <span>ü§ñ</span>
                    <span>BotV2</span>
                    <span style="font-size: 0.625rem; color: var(--text-tertiary); font-weight: 400;">v3.2</span>
                </a>
                <div class="status-indicator"></div>
            </div>
            <div class="topbar-center">
                <div class="topbar-stat">
                    <div class="topbar-stat-label">Equity</div>
                    <div class="topbar-stat-value" id="topbarEquity">‚Ç¨0.00</div>
                </div>
                <div class="topbar-stat">
                    <div class="topbar-stat-label">Daily P&L</div>
                    <div class="topbar-stat-value" id="topbarPnL">‚Ç¨0.00</div>
                </div>
                <div class="topbar-stat">
                    <div class="topbar-stat-label">Win Rate</div>
                    <div class="topbar-stat-value" id="topbarWinRate">0%</div>
                </div>
            </div>
            <div class="topbar-right">
                <button class="icon-btn" title="Toggle Theme (T)" onclick="toggleTheme()" id="themeToggle">üåô</button>
                <button class="icon-btn" title="Filters (F)" onclick="toggleFilterPanel()" id="filterBtn">
                    üîç
                    <span class="badge hidden" id="filterBadge">0</span>
                </button>
                <button class="icon-btn" title="Comparison (C)" onclick="toggleComparisonMode()">üîÑ</button>
                <button class="icon-btn" title="Settings (S)" onclick="toggleSettingsPanel()">‚öôÔ∏è</button>
                <div class="user-badge">
                    <span>üë§</span>
                    <span>{{ user }}</span>
                </div>
                <button class="btn btn-secondary" onclick="refreshDashboard()">üîÑ Refresh</button>
                <a href="/logout" class="btn btn-danger">Logout</a>
            </div>
        </div>
        
        <!-- Main Content (Reuse from v3.1 with enhancements) -->
        <div class="main-content" id="mainContent">
            <!-- Content from v3.1: Overview KPIs, Equity+Waterfall, Strategies+Scatter+BoxPlot, Drawdown+Heatmap, Risk Metrics, Trades Table -->
            <!-- Add onclick handlers to charts and trades for drill-down modals -->
        </div>
    </div>
    
    <!-- Modal Overlay (NEW v3.2) -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Modal Title</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer" id="modalFooter">
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Filter Panel (NEW v3.2) -->
    <div class="sidebar-panel" id="filterPanel">
        <div class="sidebar-header">
            <div class="sidebar-title">üîç Filters</div>
            <button class="sidebar-close" onclick="toggleFilterPanel()">&times;</button>
        </div>
        <div class="sidebar-body">
            <div class="filter-presets">
                <button class="filter-preset-btn" onclick="applyPresetFilter('today')">Today</button>
                <button class="filter-preset-btn" onclick="applyPresetFilter('week')">This Week</button>
                <button class="filter-preset-btn" onclick="applyPresetFilter('winners')">Winners</button>
                <button class="filter-preset-btn" onclick="applyPresetFilter('losers')">Losers</button>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Date Range</label>
                <input type="date" class="filter-input" id="filterDateFrom" placeholder="From">
                <input type="date" class="filter-input mt-1" id="filterDateTo" placeholder="To">
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Strategy</label>
                <select class="filter-input" id="filterStrategy">
                    <option value="">All Strategies</option>
                    <option value="momentum">Momentum</option>
                    <option value="mean_reversion">Mean Reversion</option>
                    <option value="breakout">Breakout</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">P&L Range</label>
                <input type="number" class="filter-input" id="filterPnLMin" placeholder="Min P&L">
                <input type="number" class="filter-input mt-1" id="filterPnLMax" placeholder="Max P&L">
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Symbol</label>
                <input type="text" class="filter-input" id="filterSymbol" placeholder="e.g., AAPL, TSLA">
            </div>
            
            <div class="filter-actions">
                <button class="btn" onclick="applyFilters()" style="flex: 1;">Apply Filters</button>
                <button class="btn btn-secondary" onclick="clearFilters()">Clear</button>
            </div>
        </div>
    </div>
    
    <!-- Settings Panel (NEW v3.2) -->
    <div class="sidebar-panel" id="settingsPanel">
        <div class="sidebar-header">
            <div class="sidebar-title">‚öôÔ∏è Settings</div>
            <button class="sidebar-close" onclick="toggleSettingsPanel()">&times;</button>
        </div>
        <div class="sidebar-body">
            <div class="settings-section">
                <div class="settings-section-title">Appearance</div>
                <div class="settings-item">
                    <div>
                        <div class="settings-label">Dark Mode</div>
                        <div class="settings-description">Toggle between dark and light theme</div>
                    </div>
                    <div class="toggle-switch" id="themeToggleSwitch" onclick="toggleTheme()"></div>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">Updates</div>
                <div class="settings-item">
                    <div>
                        <div class="settings-label">Auto-Refresh</div>
                        <div class="settings-description">Refresh data automatically</div>
                    </div>
                    <div class="toggle-switch active" id="autoRefreshToggle" onclick="toggleAutoRefresh()"></div>
                </div>
                <div class="settings-item">
                    <div>
                        <div class="settings-label">Refresh Interval</div>
                        <div class="settings-description">Update frequency (seconds)</div>
                    </div>
                    <select class="filter-input" id="refreshInterval" style="width: 100px;">
                        <option value="10">10s</option>
                        <option value="30" selected>30s</option>
                        <option value="60">60s</option>
                        <option value="300">5m</option>
                    </select>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">Notifications</div>
                <div class="settings-item">
                    <div>
                        <div class="settings-label">Desktop Notifications</div>
                        <div class="settings-description">Show browser notifications</div>
                    </div>
                    <div class="toggle-switch" id="notificationsToggle" onclick="toggleNotifications()"></div>
                </div>
                <div class="settings-item">
                    <div>
                        <div class="settings-label">Sound Alerts</div>
                        <div class="settings-description">Play sound on important events</div>
                    </div>
                    <div class="toggle-switch" id="soundToggle" onclick="toggleSound()"></div>
                </div>
            </div>
            
            <div class="filter-actions mt-1">
                <button class="btn" onclick="saveSettings()" style="flex: 1;">Save Settings</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Container (NEW v3.2) -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Keyboard Shortcuts Help (NEW v3.2) -->
    <div class="shortcuts-help" id="shortcutsHelp">
        <div style="font-weight: 700; margin-bottom: var(--spacing-sm);">‚å®Ô∏è Keyboard Shortcuts</div>
        <div class="shortcut-item"><span>Refresh</span><span class="shortcut-key">R</span></div>
        <div class="shortcut-item"><span>Filters</span><span class="shortcut-key">F</span></div>
        <div class="shortcut-item"><span>Settings</span><span class="shortcut-key">S</span></div>
        <div class="shortcut-item"><span>Comparison</span><span class="shortcut-key">C</span></div>
        <div class="shortcut-item"><span>Theme</span><span class="shortcut-key">T</span></div>
        <div class="shortcut-item"><span>Close</span><span class="shortcut-key">ESC</span></div>
        <div class="shortcut-item"><span>Help</span><span class="shortcut-key">?</span></div>
    </div>
    
    <!-- Alert Container (from v3.1) -->
    <div class="alert-container" id="alertContainer"></div>
    
    <!-- Enhanced JavaScript v3.2 -->
    <script>
        console.log('üöÄ BotV2 Dashboard v3.2 Ultra-Advanced loading...');
        
        // Global State (Enhanced from v3.1)
        const AppState = {
            connected: false,
            socket: null,
            timeRange: 'ALL',
            comparisonMode: false,
            selectedStrategies: [],
            filters: {},
            settings: {
                theme: 'dark',
                autoRefresh: true,
                refreshInterval: 30,
                notifications: false,
                sound: false
            },
            chartCache: {},
            data: { overview: {}, equity: {}, trades: [], strategies: {}, risk: {} }
        };
        
        // ============================================
        // MODAL SYSTEM (NEW v3.2)
        // ============================================
        function openModal(type, data) {
            const overlay = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            
            if (type === 'trade') {
                title.textContent = 'üìä Trade Details';
                body.innerHTML = generateTradeDetailsHTML(data);
            } else if (type === 'strategy') {
                title.textContent = 'üìà Strategy Analysis';
                body.innerHTML = generateStrategyAnalysisHTML(data);
            }
            
            overlay.classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }
        
        function generateTradeDetailsHTML(trade) {
            return `
                <div class="trade-detail-grid">
                    <div class="trade-detail-item"><div class="trade-detail-label">Strategy</div><div class="trade-detail-value">${trade.strategy}</div></div>
                    <div class="trade-detail-item"><div class="trade-detail-label">Symbol</div><div class="trade-detail-value">${trade.symbol}</div></div>
                    <div class="trade-detail-item"><div class="trade-detail-label">Action</div><div class="trade-detail-value">${trade.action}</div></div>
                    <div class="trade-detail-item"><div class="trade-detail-label">Size</div><div class="trade-detail-value">${trade.size}</div></div>
                    <div class="trade-detail-item"><div class="trade-detail-label">Entry Price</div><div class="trade-detail-value">‚Ç¨${trade.entry_price}</div></div>
                    <div class="trade-detail-item"><div class="trade-detail-label">P&L</div><div class="trade-detail-value ${trade.pnl >= 0 ? 'text-success' : 'text-danger'}">‚Ç¨${trade.pnl}</div></div>
                </div>
                <div style="margin-top: var(--spacing-lg);">
                    <strong>Execution Timeline:</strong>
                    <div style="margin-top: var(--spacing-sm); font-size: 0.875rem; color: var(--text-secondary);">
                        Entry: ${trade.timestamp}<br>
                        Confidence: ${(trade.confidence * 100).toFixed(1)}%
                    </div>
                </div>
            `;
        }
        
        function generateStrategyAnalysisHTML(strategy) {
            return `
                <div class="trade-detail-grid">
                    <div class="trade-detail-item"><div class="trade-detail-label">Total Return</div><div class="trade-detail-value">${strategy.total_return.toFixed(2)}%</div></div>
                    <div class="trade-detail-item"><div class="trade-detail-label">Sharpe Ratio</div><div class="trade-detail-value">${strategy.sharpe_ratio.toFixed(2)}</div></div>
                    <div class="trade-detail-item"><div class="trade-detail-label">Win Rate</div><div class="trade-detail-value">${strategy.win_rate.toFixed(2)}%</div></div>
                    <div class="trade-detail-item"><div class="trade-detail-label">Total Trades</div><div class="trade-detail-value">${strategy.total_trades}</div></div>
                    <div class="trade-detail-item"><div class="trade-detail-label">Avg Win</div><div class="trade-detail-value text-success">‚Ç¨${strategy.avg_win.toFixed(2)}</div></div>
                    <div class="trade-detail-item"><div class="trade-detail-label">Avg Loss</div><div class="trade-detail-value text-danger">‚Ç¨${Math.abs(strategy.avg_loss).toFixed(2)}</div></div>
                </div>
            `;
        }
        
        // ============================================
        // SIDEBAR PANELS (NEW v3.2)
        // ============================================
        function toggleFilterPanel() {
            const panel = document.getElementById('filterPanel');
            const settingsPanel = document.getElementById('settingsPanel');
            settingsPanel.classList.remove('active');
            panel.classList.toggle('active');
        }
        
        function toggleSettingsPanel() {
            const panel = document.getElementById('settingsPanel');
            const filterPanel = document.getElementById('filterPanel');
            filterPanel.classList.remove('active');
            panel.classList.toggle('active');
        }
        
        // ============================================
        // FILTERS (NEW v3.2)
        // ============================================
        function applyPresetFilter(preset) {
            const now = new Date();
            let from, to = now;
            
            if (preset === 'today') {
                from = new Date(now.setHours(0,0,0,0));
            } else if (preset === 'week') {
                from = new Date(now.setDate(now.getDate() - 7));
            }
            
            document.getElementById('filterDateFrom').value = from ? from.toISOString().split('T')[0] : '';
            document.getElementById('filterDateTo').value = to.toISOString().split('T')[0];
            
            if (preset === 'winners') document.getElementById('filterPnLMin').value = '0';
            if (preset === 'losers') document.getElementById('filterPnLMax').value = '0';
            
            applyFilters();
        }
        
        function applyFilters() {
            AppState.filters = {
                dateFrom: document.getElementById('filterDateFrom').value,
                dateTo: document.getElementById('filterDateTo').value,
                strategy: document.getElementById('filterStrategy').value,
                pnlMin: document.getElementById('filterPnLMin').value,
                pnlMax: document.getElementById('filterPnLMax').value,
                symbol: document.getElementById('filterSymbol').value
            };
            
            const activeFilters = Object.values(AppState.filters).filter(v => v).length;
            const badge = document.getElementById('filterBadge');
            if (activeFilters > 0) {
                badge.textContent = activeFilters;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
            
            showToast('Filters Applied', `${activeFilters} filter(s) active`, 'success');
            loadAllData();
        }
        
        function clearFilters() {
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterStrategy').value = '';
            document.getElementById('filterPnLMin').value = '';
            document.getElementById('filterPnLMax').value = '';
            document.getElementById('filterSymbol').value = '';
            AppState.filters = {};
            document.getElementById('filterBadge').classList.add('hidden');
            showToast('Filters Cleared', 'All filters removed', 'info');
            loadAllData();
        }
        
        // ============================================
        // COMPARISON MODE (NEW v3.2)
        // ============================================
        function toggleComparisonMode() {
            AppState.comparisonMode = !AppState.comparisonMode;
            const banner = document.getElementById('comparisonBanner');
            if (AppState.comparisonMode) {
                banner.classList.add('active');
                showToast('Comparison Mode', 'Select strategies to compare', 'info');
            } else {
                banner.classList.remove('active');
                AppState.selectedStrategies = [];
            }
        }
        
        function exportComparison() {
            showToast('Export', 'Comparison report exported', 'success');
        }
        
        // ============================================
        // SETTINGS (NEW v3.2)
        // ============================================
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            AppState.settings.theme = newTheme;
            document.getElementById('themeToggle').textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            document.getElementById('themeToggleSwitch').classList.toggle('active', newTheme === 'dark');
            localStorage.setItem('theme', newTheme);
        }
        
        function toggleAutoRefresh() {
            AppState.settings.autoRefresh = !AppState.settings.autoRefresh;
            document.getElementById('autoRefreshToggle').classList.toggle('active', AppState.settings.autoRefresh);
        }
        
        function toggleNotifications() {
            AppState.settings.notifications = !AppState.settings.notifications;
            document.getElementById('notificationsToggle').classList.toggle('active', AppState.settings.notifications);
        }
        
        function toggleSound() {
            AppState.settings.sound = !AppState.settings.sound;
            document.getElementById('soundToggle').classList.toggle('active', AppState.settings.sound);
        }
        
        function saveSettings() {
            AppState.settings.refreshInterval = document.getElementById('refreshInterval').value;
            localStorage.setItem('dashboardSettings', JSON.stringify(AppState.settings));
            showToast('Settings Saved', 'Your preferences have been saved', 'success');
        }
        
        function loadSettings() {
            const saved = localStorage.getItem('dashboardSettings');
            if (saved) {
                AppState.settings = { ...AppState.settings, ...JSON.parse(saved) };
                document.documentElement.setAttribute('data-theme', AppState.settings.theme);
                document.getElementById('themeToggle').textContent = AppState.settings.theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            }
        }
        
        // ============================================
        // TOAST NOTIFICATIONS (NEW v3.2)
        // ============================================
        function showToast(title, message, level = 'info') {
            const container = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            const icons = { success: '‚úÖ', danger: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
            
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast ${level}`;
            toast.innerHTML = `
                <div class="toast-icon">${icons[level]}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="closeToast('${toastId}')">&times;</button>
            `;
            container.appendChild(toast);
            setTimeout(() => closeToast(toastId), 5000);
        }
        
        function closeToast(toastId) {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }
        }
        
        // ============================================
        // KEYBOARD SHORTCUTS (NEW v3.2)
        // ============================================
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
            
            switch(e.key.toLowerCase()) {
                case 'r': refreshDashboard(); break;
                case 'f': toggleFilterPanel(); break;
                case 's': toggleSettingsPanel(); break;
                case 'c': toggleComparisonMode(); break;
                case 't': toggleTheme(); break;
                case 'escape': closeModal(); toggleFilterPanel(); toggleSettingsPanel(); break;
                case '?': document.getElementById('shortcutsHelp').classList.toggle('active'); break;
            }
        });
        
        // ============================================
        // REUSE v3.1 FUNCTIONS
        // ============================================
        // Include all functions from v3.1: initWebSocket, requestAllData, handleUpdate, fetchData, loadAllData,
        // updateOverview, updateEquityChart, updateWaterfallChart, updateStrategiesChart, updateScatterChart,
        // updateBoxPlotChart, updateDrawdownChart, updateHeatmapChart, updateRiskMetrics, updateTradesTable,
        // exportChart, toggleFullscreen, formatCurrency, formatPercent, formatDate, etc.
        
        // ============================================
        // INITIALIZATION (Enhanced)
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ BotV2 Dashboard v3.2 Ultra-Advanced initializing...');
            loadSettings();
            loadAllData();
            initWebSocket();
            console.log('‚úÖ Dashboard v3.2 initialized with advanced features!');
        });
    </script>
</body>
</html>