{% extends "base.html" %}
{% block title %}Trade History - BotV2{% endblock %}
{% block page_title %}Trade History{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Statistics Cards - CSS v4.0 -->
    <div class="card-grid mb-4" style="grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));">
        <!-- Total Trades -->
        <div class="metric-card">
            <div class="metric-card__icon bg-primary">
                <i class="fas fa-list"></i>
            </div>
            <div class="metric-card__content">
                <span class="metric-card__label">Total Trades</span>
                <span class="metric-card__value" id="total-trades">0</span>
            </div>
        </div>

        <!-- Win Rate -->
        <div class="metric-card">
            <div class="metric-card__icon bg-success">
                <i class="fas fa-percentage"></i>
            </div>
            <div class="metric-card__content">
                <span class="metric-card__label">Win Rate</span>
                <span class="metric-card__value text-success" id="win-rate">0%</span>
            </div>
        </div>

        <!-- Profit Factor -->
        <div class="metric-card">
            <div class="metric-card__icon bg-info">
                <i class="fas fa-calculator"></i>
            </div>
            <div class="metric-card__content">
                <span class="metric-card__label">Profit Factor</span>
                <span class="metric-card__value" id="profit-factor">0.00</span>
            </div>
        </div>

        <!-- Avg Win -->
        <div class="metric-card">
            <div class="metric-card__icon bg-success">
                <i class="fas fa-arrow-up"></i>
            </div>
            <div class="metric-card__content">
                <span class="metric-card__label">Avg Win</span>
                <span class="metric-card__value text-success" id="avg-win">$0</span>
            </div>
        </div>

        <!-- Avg Loss -->
        <div class="metric-card">
            <div class="metric-card__icon bg-danger">
                <i class="fas fa-arrow-down"></i>
            </div>
            <div class="metric-card__content">
                <span class="metric-card__label">Avg Loss</span>
                <span class="metric-card__value text-danger" id="avg-loss">$0</span>
            </div>
        </div>

        <!-- Total Fees -->
        <div class="metric-card">
            <div class="metric-card__icon bg-warning">
                <i class="fas fa-receipt"></i>
            </div>
            <div class="metric-card__content">
                <span class="metric-card__label">Total Fees</span>
                <span class="metric-card__value" id="total-fees">$0</span>
            </div>
        </div>
    </div>

    <!-- Filters and Table -->
    <div class="card">
        <div class="card-header">
            <div class="card-header__title">
                <h5><i class="fas fa-history me-2"></i>Recent Trades</h5>
            </div>
            <div class="card-header__actions">
                <div class="input-group" style="width: auto;">
                    <select class="form-select" id="symbol-filter" style="min-width: 150px;">
                        <option value="">All Symbols</option>
                        <option value="BTC/USDT">BTC/USDT</option>
                        <option value="ETH/USDT">ETH/USDT</option>
                        <option value="SOL/USDT">SOL/USDT</option>
                    </select>
                    <button class="btn btn-outline-primary" onclick="loadTradeHistory()">
                        <i class="fas fa-filter"></i> Filter
                    </button>
                    <button class="btn btn-outline-success" onclick="exportTrades()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-sm" id="trades-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Symbol</th>
                            <th>Side</th>
                            <th>Type</th>
                            <th>Size</th>
                            <th>Price</th>
                            <th>P&L</th>
                            <th>Fee</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- Empty State - CSS v4.0 -->
            <div id="no-trades" class="empty-state">
                <i class="empty-state__icon fas fa-history"></i>
                <div class="empty-state__title">No Trades Yet</div>
                <div class="empty-state__description">
                    Your trade history will appear here once you execute trades
                </div>
            </div>
            
            <nav class="mt-3 px-3 pb-3" id="pagination-container" style="display: none;">
                <ul class="pagination justify-content-center" id="pagination"></ul>
            </nav>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
const tradesPerPage = 20;

async function loadStatistics() {
    try {
        const res = await fetch('/trade-history/api/statistics');
        const data = await res.json();
        
        if (data.success) {
            const stats = data.statistics;
            document.getElementById('total-trades').textContent = stats.total_trades.toLocaleString();
            document.getElementById('win-rate').textContent = (stats.win_rate * 100).toFixed(1) + '%';
            document.getElementById('profit-factor').textContent = stats.profit_factor.toFixed(2);
            document.getElementById('avg-win').textContent = '$' + stats.avg_win_usd.toFixed(2);
            document.getElementById('avg-loss').textContent = '$' + stats.avg_loss_usd.toFixed(2);
            document.getElementById('total-fees').textContent = '$' + stats.total_fees_usd.toLocaleString();
        }
    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

async function loadTradeHistory() {
    try {
        showLoading('Loading trades...');
        
        const symbol = document.getElementById('symbol-filter').value;
        const url = `/trade-history/api/history?limit=${tradesPerPage}${symbol ? '&symbol=' + symbol : ''}`;
        
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.success) {
            const tbody = document.querySelector('#trades-table tbody');
            const table = document.getElementById('trades-table');
            const emptyState = document.getElementById('no-trades');
            const paginationContainer = document.getElementById('pagination-container');
            
            if (data.trades.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'flex';
                paginationContainer.style.display = 'none';
            } else {
                table.style.display = 'table';
                emptyState.style.display = 'none';
                paginationContainer.style.display = 'block';
                
                tbody.innerHTML = '';
                data.trades.forEach(trade => {
                    const row = tbody.insertRow();
                    const pnlClass = trade.pnl_usd >= 0 ? 'text-success' : 'text-danger';
                    const timestamp = new Date(trade.timestamp);
                    
                    row.innerHTML = `
                        <td>${timestamp.toLocaleString()}</td>
                        <td><strong>${trade.symbol}</strong></td>
                        <td><span class="badge bg-${trade.side === 'buy' ? 'success' : 'danger'}">${trade.side.toUpperCase()}</span></td>
                        <td><span class="badge bg-secondary">${trade.type}</span></td>
                        <td>${trade.size}</td>
                        <td>$${trade.price.toLocaleString()}</td>
                        <td class="${pnlClass}"><strong>$${trade.pnl_usd.toFixed(2)}</strong> (${trade.pnl_pct.toFixed(2)}%)</td>
                        <td>$${trade.fee_usd.toFixed(2)}</td>
                        <td><span class="badge bg-success">${trade.status}</span></td>
                    `;
                });
            }
        }
        
        hideLoading();
    } catch (error) {
        console.error('Error loading trades:', error);
        hideLoading();
        showToast('Failed to load trades', 'error');
    }
}

function exportTrades() {
    showToast('Export functionality coming soon', 'info');
}

loadStatistics();
loadTradeHistory();

setInterval(() => {
    loadStatistics();
    loadTradeHistory();
}, 60000);
</script>
{% endblock %}
