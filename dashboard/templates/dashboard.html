{% extends "base.html" %}
{% block title %}Dashboard - Trading Bot{% endblock %}
{% block page_title %}Dashboard Overview{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header Stats Row -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted mb-1">Total Balance</h6>
                            <h3 class="mb-0" id="total-balance">€0.00</h3>
                        </div>
                        <div class="stat-icon bg-primary">
                            <i class="fas fa-wallet"></i>
                        </div>
                    </div>
                    <small class="text-success" id="balance-change">+0.00%</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted mb-1">Today's P&L</h6>
                            <h3 class="mb-0" id="daily-pnl">€0.00</h3>
                        </div>
                        <div class="stat-icon bg-success">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <small id="daily-trades">0 trades</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted mb-1">Win Rate</h6>
                            <h3 class="mb-0" id="win-rate">0%</h3>
                        </div>
                        <div class="stat-icon bg-info">
                            <i class="fas fa-trophy"></i>
                        </div>
                    </div>
                    <small id="total-trades">0 total trades</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted mb-1">Bot Status</h6>
                            <h3 class="mb-0" id="bot-status">Offline</h3>
                        </div>
                        <div class="stat-icon bg-warning" id="status-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                    </div>
                    <small id="bot-uptime">--</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Charts Row -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Portfolio Performance</h5>
                    <div class="btn-group-period" id="period-buttons">
                        <button class="btn btn-sm btn-period" data-period="1d" onclick="selectPeriod(this, '1d')">1D</button>
                        <button class="btn btn-sm btn-period active" data-period="1w" onclick="selectPeriod(this, '1w')">1W</button>
                        <button class="btn btn-sm btn-period" data-period="1m" onclick="selectPeriod(this, '1m')">1M</button>
                        <button class="btn btn-sm btn-period" data-period="all" onclick="selectPeriod(this, 'all')">All</button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="performance-chart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Asset Allocation</h5>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <canvas id="allocation-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Open Positions & Recent Trades -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <h5 class="mb-0">Open Positions</h5>
                    <span class="badge bg-primary" id="position-count">0</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="positions-table">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Side</th>
                                    <th>Size</th>
                                    <th>Entry</th>
                                    <th>P&L</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="positions-body">
                                <tr><td colspan="6" class="text-center text-muted">No open positions</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <h5 class="mb-0">Recent Trades</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="trades-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Symbol</th>
                                    <th>Type</th>
                                    <th>P&L</th>
                                </tr>
                            </thead>
                            <tbody id="trades-body">
                                <tr><td colspan="4" class="text-center text-muted">No recent trades</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Period Button Group - Professional Styling */
.btn-group-period {
    display: inline-flex;
    border-radius: var(--radius-md);
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.btn-period {
    padding: 6px 14px;
    font-size: var(--font-size-sm);
    font-weight: 500;
    background: var(--bg-card);
    color: var(--text-secondary);
    border: none;
    border-right: 1px solid var(--border-color);
    transition: all var(--transition-fast);
    cursor: pointer;
}

.btn-period:last-child {
    border-right: none;
}

.btn-period:hover {
    background: var(--bg-card-hover);
    color: var(--text-primary);
}

.btn-period.active {
    background: var(--color-primary);
    color: white;
}

/* Light theme adjustments */
[data-theme="light"] .btn-group-period {
    border-color: var(--border-color);
    box-shadow: var(--shadow-xs);
}

[data-theme="light"] .btn-period {
    background: var(--bg-card);
}

[data-theme="light"] .btn-period:hover {
    background: var(--bg-card-hover);
}

[data-theme="light"] .btn-period.active {
    background: var(--color-primary);
    color: white;
}
</style>
{% endblock %}

{% block scripts %}
<script>
    // Professional color palette for charts
    const CHART_COLORS = {
        primary: '#6366f1',
        primaryLight: 'rgba(99, 102, 241, 0.15)',
        success: '#10b981',
        danger: '#ef4444',
        warning: '#f59e0b',
        info: '#3b82f6',
        text: '#64748b',
        grid: 'rgba(100, 116, 139, 0.1)'
    };

    // Initialize charts and load data
    let performanceChart = null;
    let allocationChart = null;
    let currentPeriod = '1w';

    // Period button selection handler
    function selectPeriod(button, period) {
        // Remove active class from all buttons
        document.querySelectorAll('.btn-period').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Add active class to clicked button
        button.classList.add('active');
        
        // Update current period and reload chart
        currentPeriod = period;
        loadPerformanceData(period);
    }

    // Load performance data for specific period
    async function loadPerformanceData(period) {
        try {
            // Generate data based on period
            const performanceData = generatePerformanceData(period);
            updatePerformanceChart(performanceData);
        } catch (error) {
            console.error('Error loading performance data:', error);
        }
    }

    // Generate performance data based on period
    function generatePerformanceData(period) {
        let labels = [];
        let data = [];
        let baseValue = 100000;
        let points = 0;
        
        switch(period) {
            case '1d':
                points = 24;
                for (let i = 0; i < points; i++) {
                    labels.push(`${String(i).padStart(2, '0')}:00`);
                    baseValue += (Math.random() - 0.48) * 500;
                    data.push(Math.round(baseValue * 100) / 100);
                }
                break;
            case '1w':
                points = 7;
                const weekDays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                for (let i = 0; i < points; i++) {
                    labels.push(weekDays[i]);
                    baseValue += (Math.random() - 0.45) * 2000;
                    data.push(Math.round(baseValue * 100) / 100);
                }
                break;
            case '1m':
                points = 30;
                const today = new Date();
                for (let i = points - 1; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    baseValue += (Math.random() - 0.45) * 3000;
                    data.push(Math.round(baseValue * 100) / 100);
                }
                break;
            case 'all':
                points = 12;
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const currentMonth = new Date().getMonth();
                for (let i = 0; i < points; i++) {
                    const monthIndex = (currentMonth - 11 + i + 12) % 12;
                    labels.push(monthNames[monthIndex]);
                    baseValue += (Math.random() - 0.4) * 8000;
                    data.push(Math.round(baseValue * 100) / 100);
                }
                break;
        }
        
        return { labels, data };
    }

    // Load dashboard data
    async function loadDashboardData() {
        try {
            const response = await fetch('/api/section/dashboard');
            if (!response.ok) {
                console.warn('Dashboard API not available, using demo data');
                loadDemoData();
                return;
            }
            
            const data = await response.json();
            updateDashboardStats(data);
        } catch (error) {
            console.warn('Error loading dashboard data:', error);
            loadDemoData();
        }
    }

    // Load demo data as fallback
    function loadDemoData() {
        const demoData = {
            overview: {
                equity: '€105,664.34',
                total_pnl: '+€7,758.62',
                daily_pnl: '€0.00',
                win_rate: 68.5,
                total_trades: 0,
                daily_trades: 0,
                bot_status: 'Offline',
                uptime: '--'
            },
            allocation: {
                labels: ['BTC', 'ETH', 'SOL', 'USDT'],
                data: [45, 30, 15, 10]
            },
            positions: [],
            trades: []
        };
        
        updateDashboardStats(demoData);
        // Load performance data for current period
        loadPerformanceData(currentPeriod);
    }

    // Update dashboard statistics
    function updateDashboardStats(data) {
        const overview = data.overview || {};
        
        // Update stats cards
        document.getElementById('total-balance').textContent = overview.equity || '€0.00';
        
        const balanceChange = document.getElementById('balance-change');
        balanceChange.textContent = overview.total_pnl || '+0.00%';
        balanceChange.className = (overview.total_pnl && overview.total_pnl.includes('+')) ? 'text-success' : 'text-danger';
        
        document.getElementById('daily-pnl').textContent = overview.daily_pnl || '€0.00';
        document.getElementById('daily-trades').textContent = `${overview.daily_trades || 0} trades`;
        document.getElementById('win-rate').textContent = `${overview.win_rate || 0}%`;
        document.getElementById('total-trades').textContent = `${overview.total_trades || 0} total trades`;
        document.getElementById('bot-status').textContent = overview.bot_status || 'Offline';
        document.getElementById('bot-uptime').textContent = overview.uptime || '--';

        // Update performance chart with current period
        loadPerformanceData(currentPeriod);
        
        // Update allocation chart
        if (data.allocation) {
            updateAllocationChart(data.allocation);
        }

        // Update positions table
        if (data.positions) {
            updatePositionsTable(data.positions);
        }

        // Update trades table
        if (data.trades) {
            updateTradesTable(data.trades);
        }
    }

    // Update performance chart
    function updatePerformanceChart(data) {
        const ctx = document.getElementById('performance-chart');
        if (!ctx) return;

        if (performanceChart) {
            performanceChart.destroy();
        }

        performanceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels || [],
                datasets: [{
                    label: 'Portfolio Value',
                    data: data.data || [],
                    borderColor: CHART_COLORS.primary,
                    backgroundColor: CHART_COLORS.primaryLight,
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0,
                    pointHoverRadius: 5,
                    pointHoverBackgroundColor: CHART_COLORS.primary,
                    pointHoverBorderColor: '#fff',
                    pointHoverBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                        titleColor: '#fff',
                        bodyColor: '#cbd5e1',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        cornerRadius: 8,
                        padding: 12,
                        callbacks: {
                            label: (context) => `Value: €${context.parsed.y.toLocaleString()}`
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        grid: {
                            color: CHART_COLORS.grid
                        },
                        ticks: {
                            color: CHART_COLORS.text,
                            font: { size: 11 },
                            callback: (value) => '€' + value.toLocaleString()
                        },
                        border: { display: false }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: CHART_COLORS.text,
                            font: { size: 11 },
                            maxRotation: 0
                        },
                        border: { display: false }
                    }
                }
            }
        });
    }

    // Update allocation chart
    function updateAllocationChart(data) {
        const ctx = document.getElementById('allocation-chart');
        if (!ctx) return;

        if (allocationChart) {
            allocationChart.destroy();
        }

        // Professional allocation colors
        const allocationColors = [
            '#6366f1', // Indigo (BTC)
            '#10b981', // Emerald (ETH)
            '#f59e0b', // Amber (SOL)
            '#ef4444'  // Red (USDT/Other)
        ];

        allocationChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.labels || [],
                datasets: [{
                    data: data.data || [],
                    backgroundColor: allocationColors,
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                cutout: '65%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: 'var(--text-secondary)',
                            padding: 15,
                            usePointStyle: true,
                            pointStyle: 'circle',
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                        titleColor: '#fff',
                        bodyColor: '#cbd5e1',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        cornerRadius: 8,
                        padding: 12,
                        callbacks: {
                            label: (context) => `${context.label}: ${context.parsed}%`
                        }
                    }
                }
            }
        });
    }

    // Update positions table
    function updatePositionsTable(positions) {
        const tbody = document.getElementById('positions-body');
        if (!tbody) return;

        document.getElementById('position-count').textContent = positions.length;

        if (positions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No open positions</td></tr>';
            return;
        }

        tbody.innerHTML = positions.map(pos => `
            <tr>
                <td><strong>${pos.symbol}</strong></td>
                <td><span class="badge bg-${pos.side === 'LONG' ? 'success' : 'danger'}">${pos.side}</span></td>
                <td>${pos.size}</td>
                <td>€${pos.entry.toLocaleString()}</td>
                <td class="${pos.pnl >= 0 ? 'text-success' : 'text-danger'}">
                    ${pos.pnl >= 0 ? '+' : ''}€${pos.pnl.toFixed(2)} (${pos.pnl_pct.toFixed(2)}%)
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="closePosition('${pos.symbol}')">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // Update trades table
    function updateTradesTable(trades) {
        const tbody = document.getElementById('trades-body');
        if (!tbody) return;

        if (trades.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No recent trades</td></tr>';
            return;
        }

        tbody.innerHTML = trades.map(trade => `
            <tr>
                <td>${trade.time}</td>
                <td><strong>${trade.symbol}</strong></td>
                <td><span class="badge bg-${trade.type === 'BUY' ? 'success' : 'info'}">${trade.type}</span></td>
                <td class="${trade.pnl >= 0 ? 'text-success' : 'text-danger'}">
                    ${trade.pnl >= 0 ? '+' : ''}€${trade.pnl.toFixed(2)}
                </td>
            </tr>
        `).join('');
    }

    // Close position action
    function closePosition(symbol) {
        if (confirm(`Close position for ${symbol}?`)) {
            console.log(`Closing position: ${symbol}`);
            showToast(`Position ${symbol} close request sent`, 'info');
            // TODO: Implement close position API call
        }
    }

    // WebSocket real-time updates
    if (typeof socket !== 'undefined' && socket) {
        socket.on('dashboard_update', function(data) {
            updateDashboardStats(data);
        });
    }

    // Auto-refresh every 30 seconds
    setInterval(loadDashboardData, 30000);

    // Initial load
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
    });
</script>
{% endblock %}
