{% extends "base.html" %}
{% block title %}Dashboard - Trading Bot{% endblock %}
{% block page_title %}Dashboard Overview{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header Stats Row -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted mb-1">Total Balance</h6>
                            <h3 class="mb-0" id="total-balance">€0.00</h3>
                        </div>
                        <div class="stat-icon bg-primary">
                            <i class="fas fa-wallet"></i>
                        </div>
                    </div>
                    <small class="text-success" id="balance-change">+0.00%</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted mb-1">Today's P&L</h6>
                            <h3 class="mb-0" id="daily-pnl">€0.00</h3>
                        </div>
                        <div class="stat-icon bg-success">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <small id="daily-trades">0 trades</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted mb-1">Win Rate</h6>
                            <h3 class="mb-0" id="win-rate">0%</h3>
                        </div>
                        <div class="stat-icon bg-info">
                            <i class="fas fa-trophy"></i>
                        </div>
                    </div>
                    <small id="total-trades">0 total trades</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted mb-1">Bot Status</h6>
                            <h3 class="mb-0" id="bot-status">Offline</h3>
                        </div>
                        <div class="stat-icon bg-warning" id="status-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                    </div>
                    <small id="bot-uptime">--</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Charts Row -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Portfolio Performance</h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary active" data-period="1d">1D</button>
                        <button class="btn btn-outline-primary" data-period="1w">1W</button>
                        <button class="btn btn-outline-primary" data-period="1m">1M</button>
                        <button class="btn btn-outline-primary" data-period="all">All</button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="performance-chart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Asset Allocation</h5>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <canvas id="allocation-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Open Positions & Recent Trades -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <h5 class="mb-0">Open Positions</h5>
                    <span class="badge bg-primary" id="position-count">0</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="positions-table">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Side</th>
                                    <th>Size</th>
                                    <th>Entry</th>
                                    <th>P&L</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="positions-body">
                                <tr><td colspan="6" class="text-center text-muted">No open positions</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <h5 class="mb-0">Recent Trades</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="trades-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Symbol</th>
                                    <th>Type</th>
                                    <th>P&L</th>
                                </tr>
                            </thead>
                            <tbody id="trades-body">
                                <tr><td colspan="4" class="text-center text-muted">No recent trades</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize charts and load data
    let performanceChart = null;
    let allocationChart = null;

    // Load dashboard data
    async function loadDashboardData() {
        try {
            const response = await fetch('/api/section/dashboard');
            if (!response.ok) {
                console.warn('Dashboard API not available, using demo data');
                loadDemoData();
                return;
            }
            
            const data = await response.json();
            updateDashboardStats(data);
        } catch (error) {
            console.warn('Error loading dashboard data:', error);
            loadDemoData();
        }
    }

    // Load demo data as fallback
    function loadDemoData() {
        const demoData = {
            overview: {
                equity: '€3,000.00',
                total_pnl: '+€150.00',
                daily_pnl: '+€25.50',
                win_rate: 65.5,
                total_trades: 24,
                daily_trades: 3,
                bot_status: 'Paper',
                uptime: '2h 15m'
            },
            performance: {
                labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'],
                data: [3000, 3020, 3010, 3050, 3080, 3000]
            },
            allocation: {
                labels: ['BTC', 'ETH', 'USDT', 'Other'],
                data: [45, 30, 15, 10]
            },
            positions: [
                { symbol: 'BTC/USDT', side: 'LONG', size: 0.05, entry: 50000, pnl: 125.50, pnl_pct: 2.5 },
                { symbol: 'ETH/USDT', side: 'LONG', size: 0.5, entry: 3000, pnl: -25.00, pnl_pct: -0.8 }
            ],
            trades: [
                { time: '14:23', symbol: 'BTC/USDT', type: 'SELL', pnl: 75.00 },
                { time: '13:45', symbol: 'ETH/USDT', type: 'BUY', pnl: -15.00 },
                { time: '12:10', symbol: 'BNB/USDT', type: 'SELL', pnl: 42.50 }
            ]
        };
        
        updateDashboardStats(demoData);
    }

    // Update dashboard statistics
    function updateDashboardStats(data) {
        const overview = data.overview || {};
        
        // Update stats cards
        document.getElementById('total-balance').textContent = overview.equity || '€0.00';
        document.getElementById('balance-change').textContent = overview.total_pnl || '+0.00%';
        document.getElementById('daily-pnl').textContent = overview.daily_pnl || '€0.00';
        document.getElementById('daily-trades').textContent = `${overview.daily_trades || 0} trades`;
        document.getElementById('win-rate').textContent = `${overview.win_rate || 0}%`;
        document.getElementById('total-trades').textContent = `${overview.total_trades || 0} total trades`;
        document.getElementById('bot-status').textContent = overview.bot_status || 'Offline';
        document.getElementById('bot-uptime').textContent = overview.uptime || '--';

        // Update charts
        if (data.performance) {
            updatePerformanceChart(data.performance);
        }
        
        if (data.allocation) {
            updateAllocationChart(data.allocation);
        }

        // Update positions table
        if (data.positions) {
            updatePositionsTable(data.positions);
        }

        // Update trades table
        if (data.trades) {
            updateTradesTable(data.trades);
        }
    }

    // Update performance chart
    function updatePerformanceChart(data) {
        const ctx = document.getElementById('performance-chart');
        if (!ctx) return;

        if (performanceChart) {
            performanceChart.destroy();
        }

        performanceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels || [],
                datasets: [{
                    label: 'Portfolio Value',
                    data: data.data || [],
                    borderColor: '#5865f2',
                    backgroundColor: 'rgba(88, 101, 242, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#8e9297'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#8e9297'
                        }
                    }
                }
            }
        });
    }

    // Update allocation chart
    function updateAllocationChart(data) {
        const ctx = document.getElementById('allocation-chart');
        if (!ctx) return;

        if (allocationChart) {
            allocationChart.destroy();
        }

        allocationChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.labels || [],
                datasets: [{
                    data: data.data || [],
                    backgroundColor: [
                        '#f7931a',
                        '#627eea',
                        '#26a17b',
                        '#5865f2'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#e4e6eb',
                            padding: 15
                        }
                    }
                }
            }
        });
    }

    // Update positions table
    function updatePositionsTable(positions) {
        const tbody = document.getElementById('positions-body');
        if (!tbody) return;

        document.getElementById('position-count').textContent = positions.length;

        if (positions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No open positions</td></tr>';
            return;
        }

        tbody.innerHTML = positions.map(pos => `
            <tr>
                <td>${pos.symbol}</td>
                <td><span class="badge bg-${pos.side === 'LONG' ? 'success' : 'danger'}">${pos.side}</span></td>
                <td>${pos.size}</td>
                <td>€${pos.entry.toLocaleString()}</td>
                <td class="${pos.pnl >= 0 ? 'text-success' : 'text-danger'}">
                    ${pos.pnl >= 0 ? '+' : ''}€${pos.pnl.toFixed(2)} (${pos.pnl_pct.toFixed(2)}%)
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="closePosition('${pos.symbol}')">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // Update trades table
    function updateTradesTable(trades) {
        const tbody = document.getElementById('trades-body');
        if (!tbody) return;

        if (trades.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No recent trades</td></tr>';
            return;
        }

        tbody.innerHTML = trades.map(trade => `
            <tr>
                <td>${trade.time}</td>
                <td>${trade.symbol}</td>
                <td><span class="badge bg-${trade.type === 'BUY' ? 'success' : 'info'}">${trade.type}</span></td>
                <td class="${trade.pnl >= 0 ? 'text-success' : 'text-danger'}">
                    ${trade.pnl >= 0 ? '+' : ''}€${trade.pnl.toFixed(2)}
                </td>
            </tr>
        `).join('');
    }

    // Close position action
    function closePosition(symbol) {
        if (confirm(`Close position for ${symbol}?`)) {
            console.log(`Closing position: ${symbol}`);
            // TODO: Implement close position API call
        }
    }

    // WebSocket real-time updates
    if (socket) {
        socket.on('dashboard_update', function(data) {
            updateDashboardStats(data);
        });
    }

    // Auto-refresh every 30 seconds
    setInterval(loadDashboardData, 30000);

    // Initial load
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
    });
</script>
{% endblock %}
