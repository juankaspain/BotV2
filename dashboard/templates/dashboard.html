{% extends "base.html" %}
{% block title %}Dashboard - Trading Bot{% endblock %}
{% block page_title %}Dashboard Overview{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header Stats - CSS v4.0 Metric Cards -->
    <div class="card-grid mb-4">
        <!-- Total Balance Metric -->
        <div class="metric-card">
            <div class="metric-card__icon bg-primary">
                <i class="fas fa-wallet"></i>
            </div>
            <div class="metric-card__content">
                <span class="metric-card__label">Total Balance</span>
                <span class="metric-card__value" id="total-balance">€0.00</span>
                <small id="balance-change" class="text-success" style="font-size: 0.75rem; margin-top: 4px; display: block;">+0.00%</small>
            </div>
        </div>

        <!-- Today's P&L Metric -->
        <div class="metric-card">
            <div class="metric-card__icon bg-success">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="metric-card__content">
                <span class="metric-card__label">Today's P&L</span>
                <span class="metric-card__value" id="daily-pnl">€0.00</span>
                <small id="daily-trades" style="font-size: 0.75rem; margin-top: 4px; display: block;">0 trades</small>
            </div>
        </div>

        <!-- Win Rate Metric -->
        <div class="metric-card">
            <div class="metric-card__icon bg-info">
                <i class="fas fa-trophy"></i>
            </div>
            <div class="metric-card__content">
                <span class="metric-card__label">Win Rate</span>
                <span class="metric-card__value" id="win-rate">0%</span>
                <small id="total-trades" class="text-muted" style="font-size: 0.75rem; margin-top: 4px; display: block;">0 total trades</small>
            </div>
        </div>

        <!-- Bot Status Metric -->
        <div class="metric-card">
            <div class="metric-card__icon bg-warning" id="status-icon">
                <i class="fas fa-robot"></i>
            </div>
            <div class="metric-card__content">
                <span class="metric-card__label">Bot Status</span>
                <span class="metric-card__value" id="bot-status">Offline</span>
                <small id="bot-uptime" class="text-muted" style="font-size: 0.75rem; margin-top: 4px; display: block;">--</small>
            </div>
        </div>
    </div>

    <!-- Main Charts Row -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <div class="card-header__title">
                        <h5>Portfolio Performance</h5>
                    </div>
                    <div class="card-header__actions">
                        <div class="btn-group-period" id="period-buttons">
                            <button class="btn btn-sm btn-period" data-period="1d" onclick="selectPeriod(this, '1d')">1D</button>
                            <button class="btn btn-sm btn-period active" data-period="1w" onclick="selectPeriod(this, '1w')">1W</button>
                            <button class="btn btn-sm btn-period" data-period="1m" onclick="selectPeriod(this, '1m')">1M</button>
                            <button class="btn btn-sm btn-period" data-period="all" onclick="selectPeriod(this, 'all')">All</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Chart Container - CSS v4.0 -->
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="performance-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header">
                    <div class="card-header__title">
                        <h5>Asset Allocation</h5>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Chart Container - CSS v4.0 -->
                    <div class="chart-container">
                        <canvas id="allocation-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Open Positions & Recent Trades -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <div class="card-header__title">
                        <h5>Open Positions</h5>
                    </div>
                    <div class="card-header__actions">
                        <span class="badge bg-primary" id="position-count">0</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover" id="positions-table">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Side</th>
                                    <th>Size</th>
                                    <th>Entry</th>
                                    <th>P&L</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="positions-body"></tbody>
                        </table>
                    </div>
                    
                    <!-- Empty State - CSS v4.0 -->
                    <div id="no-positions" class="empty-state">
                        <i class="empty-state__icon fas fa-layer-group"></i>
                        <div class="empty-state__title">No Open Positions</div>
                        <div class="empty-state__description">
                            Your active trades will appear here
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <div class="card-header__title">
                        <h5>Recent Trades</h5>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover" id="trades-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Symbol</th>
                                    <th>Type</th>
                                    <th>P&L</th>
                                </tr>
                            </thead>
                            <tbody id="trades-body"></tbody>
                        </table>
                    </div>
                    
                    <!-- Empty State - CSS v4.0 -->
                    <div id="no-trades" class="empty-state">
                        <i class="empty-state__icon fas fa-history"></i>
                        <div class="empty-state__title">No Recent Trades</div>
                        <div class="empty-state__description">
                            Your trade history will appear here
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Period Button Group - Professional Styling */
.btn-group-period {
    display: inline-flex;
    border-radius: var(--radius-md);
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.btn-period {
    padding: 6px 14px;
    font-size: var(--font-size-sm);
    font-weight: 500;
    background: var(--bg-card);
    color: var(--text-secondary);
    border: none;
    border-right: 1px solid var(--border-color);
    transition: all var(--transition-fast);
    cursor: pointer;
}

.btn-period:last-child {
    border-right: none;
}

.btn-period:hover {
    background: var(--bg-card-hover);
    color: var(--text-primary);
}

.btn-period.active {
    background: var(--color-primary);
    color: white;
}

[data-theme="light"] .btn-group-period {
    border-color: var(--border-color);
    box-shadow: var(--shadow-xs);
}
</style>
{% endblock %}

{% block scripts %}
<script>
    // ✅ Use ThemeManager for all charts
    let performanceChart = null;
    let allocationChart = null;
    let currentPeriod = '1w';

    // Period button selection handler
    function selectPeriod(button, period) {
        document.querySelectorAll('.btn-period').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        currentPeriod = period;
        loadPerformanceData(period);
    }

    // Generate performance data based on period
    function generatePerformanceData(period) {
        let labels = [];
        let data = [];
        let baseValue = 100000;
        let points = 0;
        
        switch(period) {
            case '1d':
                points = 24;
                for (let i = 0; i < points; i++) {
                    labels.push(`${String(i).padStart(2, '0')}:00`);
                    baseValue += (Math.random() - 0.48) * 500;
                    data.push(Math.round(baseValue * 100) / 100);
                }
                break;
            case '1w':
                points = 7;
                const weekDays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                for (let i = 0; i < points; i++) {
                    labels.push(weekDays[i]);
                    baseValue += (Math.random() - 0.45) * 2000;
                    data.push(Math.round(baseValue * 100) / 100);
                }
                break;
            case '1m':
                points = 30;
                const today = new Date();
                for (let i = points - 1; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    baseValue += (Math.random() - 0.45) * 3000;
                    data.push(Math.round(baseValue * 100) / 100);
                }
                break;
            case 'all':
                points = 12;
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const currentMonth = new Date().getMonth();
                for (let i = 0; i < points; i++) {
                    const monthIndex = (currentMonth - 11 + i + 12) % 12;
                    labels.push(monthNames[monthIndex]);
                    baseValue += (Math.random() - 0.4) * 8000;
                    data.push(Math.round(baseValue * 100) / 100);
                }
                break;
        }
        
        return { labels, data };
    }

    // Load performance data
    async function loadPerformanceData(period) {
        try {
            const performanceData = generatePerformanceData(period);
            updatePerformanceChart(performanceData);
        } catch (error) {
            console.error('Error loading performance data:', error);
        }
    }

    // Load dashboard data
    async function loadDashboardData() {
        try {
            const response = await fetch('/api/section/dashboard');
            if (!response.ok) {
                console.warn('Dashboard API not available, using demo data');
                loadDemoData();
                return;
            }
            
            const data = await response.json();
            updateDashboardStats(data);
        } catch (error) {
            console.warn('Error loading dashboard data:', error);
            loadDemoData();
        }
    }

    // Load demo data as fallback
    function loadDemoData() {
        const demoData = {
            overview: {
                equity: '€105,664.34',
                total_pnl: '+€7,758.62',
                daily_pnl: '€0.00',
                win_rate: 68.5,
                total_trades: 0,
                daily_trades: 0,
                bot_status: 'Offline',
                uptime: '--'
            },
            allocation: {
                labels: ['BTC', 'ETH', 'SOL', 'USDT'],
                data: [45, 30, 15, 10]
            },
            positions: [],
            trades: []
        };
        
        updateDashboardStats(demoData);
        loadPerformanceData(currentPeriod);
    }

    // Update dashboard statistics
    function updateDashboardStats(data) {
        const overview = data.overview || {};
        
        document.getElementById('total-balance').textContent = overview.equity || '€0.00';
        
        const balanceChange = document.getElementById('balance-change');
        balanceChange.textContent = overview.total_pnl || '+0.00%';
        balanceChange.className = (overview.total_pnl && overview.total_pnl.includes('+')) ? 'text-success' : 'text-danger';
        
        document.getElementById('daily-pnl').textContent = overview.daily_pnl || '€0.00';
        document.getElementById('daily-trades').textContent = `${overview.daily_trades || 0} trades`;
        document.getElementById('win-rate').textContent = `${overview.win_rate || 0}%`;
        document.getElementById('total-trades').textContent = `${overview.total_trades || 0} total trades`;
        document.getElementById('bot-status').textContent = overview.bot_status || 'Offline';
        document.getElementById('bot-uptime').textContent = overview.uptime || '--';

        loadPerformanceData(currentPeriod);
        
        if (data.allocation) {
            updateAllocationChart(data.allocation);
        }

        if (data.positions) {
            updatePositionsTable(data.positions);
        }

        if (data.trades) {
            updateTradesTable(data.trades);
        }
    }

    // ✅ Update performance chart with ThemeManager
    function updatePerformanceChart(data) {
        const ctx = document.getElementById('performance-chart');
        if (!ctx) return;

        if (performanceChart) {
            performanceChart.destroy();
        }

        const colors = ThemeManager.getChartColors();
        const config = ThemeManager.getChartDefaults('line');
        
        config.data = {
            labels: data.labels || [],
            datasets: [{
                label: 'Portfolio Value',
                data: data.data || [],
                borderColor: colors.primary,
                backgroundColor: `${colors.primary}20`,
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 5
            }]
        };

        config.options.plugins.tooltip.callbacks = {
            label: (context) => `Value: €${context.parsed.y.toLocaleString()}`
        };

        config.options.scales.y.ticks.callback = (value) => '€' + value.toLocaleString();
        
        performanceChart = new Chart(ctx, config);
    }

    // ✅ Update allocation chart with ThemeManager
    function updateAllocationChart(data) {
        const ctx = document.getElementById('allocation-chart');
        if (!ctx) return;

        if (allocationChart) {
            allocationChart.destroy();
        }

        const colors = ThemeManager.getChartColors();
        const config = ThemeManager.getChartDefaults('doughnut');

        config.data = {
            labels: data.labels || [],
            datasets: [{
                data: data.data || [],
                backgroundColor: colors.palette,
                borderWidth: 0
            }]
        };

        config.options.plugins.tooltip.callbacks = {
            label: (context) => `${context.label}: ${context.parsed}%`
        };
        
        allocationChart = new Chart(ctx, config);
    }

    // Update positions table with empty state
    function updatePositionsTable(positions) {
        const tbody = document.getElementById('positions-body');
        const noPositions = document.getElementById('no-positions');
        const table = document.getElementById('positions-table');
        
        if (!tbody) return;

        document.getElementById('position-count').textContent = positions.length;

        if (positions.length === 0) {
            table.style.display = 'none';
            noPositions.style.display = 'flex';
            return;
        }

        table.style.display = 'table';
        noPositions.style.display = 'none';

        tbody.innerHTML = positions.map(pos => `
            <tr>
                <td><strong>${pos.symbol}</strong></td>
                <td><span class="badge bg-${pos.side === 'LONG' ? 'success' : 'danger'}">${pos.side}</span></td>
                <td>${pos.size}</td>
                <td>€${pos.entry.toLocaleString()}</td>
                <td class="${pos.pnl >= 0 ? 'text-success' : 'text-danger'}">
                    ${pos.pnl >= 0 ? '+' : ''}€${pos.pnl.toFixed(2)} (${pos.pnl_pct.toFixed(2)}%)
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="closePosition('${pos.symbol}')">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // Update trades table with empty state
    function updateTradesTable(trades) {
        const tbody = document.getElementById('trades-body');
        const noTrades = document.getElementById('no-trades');
        const table = document.getElementById('trades-table');
        
        if (!tbody) return;

        if (trades.length === 0) {
            table.style.display = 'none';
            noTrades.style.display = 'flex';
            return;
        }

        table.style.display = 'table';
        noTrades.style.display = 'none';

        tbody.innerHTML = trades.map(trade => `
            <tr>
                <td>${trade.time}</td>
                <td><strong>${trade.symbol}</strong></td>
                <td><span class="badge bg-${trade.type === 'BUY' ? 'success' : 'info'}">${trade.type}</span></td>
                <td class="${trade.pnl >= 0 ? 'text-success' : 'text-danger'}">
                    ${trade.pnl >= 0 ? '+' : ''}€${trade.pnl.toFixed(2)}
                </td>
            </tr>
        `).join('');
    }

    function closePosition(symbol) {
        if (confirm(`Close position for ${symbol}?`)) {
            console.log(`Closing position: ${symbol}`);
            showToast(`Position ${symbol} close request sent`, 'info');
        }
    }

    // ✅ Re-render charts on theme change
    window.addEventListener('themechange', function() {
        if (performanceChart) {
            loadPerformanceData(currentPeriod);
        }
        if (allocationChart) {
            const data = {
                labels: ['BTC', 'ETH', 'SOL', 'USDT'],
                data: [45, 30, 15, 10]
            };
            updateAllocationChart(data);
        }
    });

    // WebSocket real-time updates
    if (typeof socket !== 'undefined' && socket) {
        socket.on('dashboard_update', function(data) {
            updateDashboardStats(data);
        });
    }

    // Auto-refresh every 30 seconds
    setInterval(loadDashboardData, 30000);

    // Initial load
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
    });
</script>
{% endblock %}
