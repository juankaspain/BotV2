{% extends "base.html" %}
{% block title %}Portfolio - BotV2{% endblock %}
{% block page_title %}Portfolio{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Summary Cards -->
    <div class="row mb-4 g-3">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted mb-2"><i class="fas fa-wallet me-2"></i>Total Value</h6>
                    <h3 class="mb-1" id="total-value">$0.00</h3>
                    <small id="total-pnl" class="text-success"><i class="fas fa-arrow-up"></i> +0.00%</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted mb-2"><i class="fas fa-chart-line me-2"></i>Daily P&L</h6>
                    <h3 class="mb-1" id="daily-pnl">$0.00</h3>
                    <small id="daily-pnl-pct">+0.00%</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted mb-2"><i class="fas fa-layer-group me-2"></i>Open Positions</h6>
                    <h3 class="mb-1" id="open-positions">0</h3>
                    <small class="text-muted">Active trades</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted mb-2"><i class="fas fa-coins me-2"></i>Assets</h6>
                    <h3 class="mb-1" id="assets-count">0</h3>
                    <small class="text-muted">Unique assets</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row g-3">
        <!-- Positions Table -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Open Positions</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshPortfolio()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="positions-table">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Side</th>
                                    <th>Size</th>
                                    <th>Entry</th>
                                    <th>Current</th>
                                    <th>P&L</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="no-positions" class="text-center py-4" style="display: none;">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No open positions</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Asset Allocation -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-pie-chart me-2"></i>Asset Allocation</h5>
                </div>
                <div class="card-body">
                    <canvas id="allocation-chart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let allocationChart = null;

async function loadPortfolioData() {
    try {
        showLoading('Loading portfolio...');
        
        // Load summary
        const summaryRes = await fetch('/api/portfolio/summary');
        const summary = await summaryRes.json();
        
        if (summary.success) {
            const s = summary.summary;
            document.getElementById('total-value').textContent = '$' + s.total_value_usd.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            const totalPnlEl = document.getElementById('total-pnl');
            totalPnlEl.textContent = (s.total_pnl_pct >= 0 ? '+' : '') + s.total_pnl_pct + '%';
            totalPnlEl.className = s.total_pnl_pct >= 0 ? 'text-success' : 'text-danger';
            totalPnlEl.innerHTML = `<i class="fas fa-arrow-${s.total_pnl_pct >= 0 ? 'up' : 'down'}"></i> ` + totalPnlEl.textContent;
            
            document.getElementById('daily-pnl').textContent = '$' + s.daily_pnl_usd.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            const dailyPnlPctEl = document.getElementById('daily-pnl-pct');
            dailyPnlPctEl.textContent = (s.daily_pnl_pct >= 0 ? '+' : '') + s.daily_pnl_pct + '%';
            dailyPnlPctEl.className = s.daily_pnl_pct >= 0 ? 'text-success' : 'text-danger';
            
            document.getElementById('open-positions').textContent = s.open_positions;
            document.getElementById('assets-count').textContent = s.assets_count;
        }
        
        // Load positions
        const positionsRes = await fetch('/api/portfolio/positions');
        const positions = await positionsRes.json();
        
        if (positions.success) {
            const tbody = document.querySelector('#positions-table tbody');
            const noPositions = document.getElementById('no-positions');
            tbody.innerHTML = '';
            
            if (positions.positions.length === 0) {
                noPositions.style.display = 'block';
                document.querySelector('#positions-table').style.display = 'none';
            } else {
                noPositions.style.display = 'none';
                document.querySelector('#positions-table').style.display = 'table';
                
                positions.positions.forEach(pos => {
                    const row = tbody.insertRow();
                    const pnlClass = pos.pnl_usd >= 0 ? 'text-success' : 'text-danger';
                    row.innerHTML = `
                        <td><strong>${pos.symbol}</strong></td>
                        <td><span class="badge bg-${pos.side === 'long' ? 'success' : 'danger'}">${pos.side.toUpperCase()}</span></td>
                        <td>${pos.size}</td>
                        <td>$${pos.entry_price.toLocaleString()}</td>
                        <td>$${pos.current_price.toLocaleString()}</td>
                        <td class="${pnlClass}">
                            <strong>$${pos.pnl_usd.toFixed(2)}</strong><br>
                            <small>(${pos.pnl_pct.toFixed(2)}%)</small>
                        </td>
                    `;
                });
            }
        }
        
        // Load allocation for chart
        const allocationRes = await fetch('/api/portfolio/allocation');
        const allocation = await allocationRes.json();
        
        if (allocation.success) {
            renderAllocationChart(allocation.allocation);
        }
        
        hideLoading();
        showToast('Portfolio updated successfully', 'success', 2000);
    } catch (error) {
        console.error('Error loading portfolio:', error);
        hideLoading();
        showToast('Failed to load portfolio data', 'error');
    }
}

function renderAllocationChart(data) {
    const ctx = document.getElementById('allocation-chart');
    
    if (allocationChart) {
        allocationChart.destroy();
    }
    
    allocationChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.map(d => d.asset),
            datasets: [{
                data: data.map(d => d.percentage),
                backgroundColor: [
                    '#5865f2',
                    '#57f287',
                    '#fee75c',
                    '#ed4245',
                    '#eb459e',
                    '#00d9ff'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#e4e6eb',
                        padding: 15,
                        font: { size: 12 }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const asset = context.label;
                            const percentage = context.parsed;
                            const value = data[context.dataIndex].value_usd;
                            return `${asset}: ${percentage}% ($${value.toLocaleString()})`;
                        }
                    }
                }
            }
        }
    });
}

function refreshPortfolio() {
    loadPortfolioData();
}

// Load on page load
loadPortfolioData();

// Auto-refresh every 30 seconds
setInterval(loadPortfolioData, 30000);
</script>
{% endblock %}
