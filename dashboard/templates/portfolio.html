{% extends "base.html" %}
{% block title %}Portfolio - BotV2{% endblock %}
{% block page_title %}Portfolio{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Summary Metrics - CSS v4.0 Metric Cards -->
    <div class="card-grid mb-4">
        <!-- Total Value Metric -->
        <div class="metric-card">
            <div class="metric-card__icon bg-primary">
                <i class="fas fa-wallet"></i>
            </div>
            <div class="metric-card__content">
                <span class="metric-card__label">Total Value</span>
                <span class="metric-card__value" id="total-value">$0.00</span>
                <small id="total-pnl" class="text-success" style="font-size: 0.75rem; margin-top: 4px; display: block;">
                    <i class="fas fa-arrow-up"></i> +0.00%
                </small>
            </div>
        </div>

        <!-- Daily P&L Metric -->
        <div class="metric-card">
            <div class="metric-card__icon bg-info">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="metric-card__content">
                <span class="metric-card__label">Daily P&L</span>
                <span class="metric-card__value" id="daily-pnl">$0.00</span>
                <small id="daily-pnl-pct" style="font-size: 0.75rem; margin-top: 4px; display: block;">
                    +0.00%
                </small>
            </div>
        </div>

        <!-- Open Positions Metric -->
        <div class="metric-card">
            <div class="metric-card__icon bg-success">
                <i class="fas fa-layer-group"></i>
            </div>
            <div class="metric-card__content">
                <span class="metric-card__label">Open Positions</span>
                <span class="metric-card__value" id="open-positions">0</span>
                <small class="text-muted" style="font-size: 0.75rem; margin-top: 4px; display: block;">
                    Active trades
                </small>
            </div>
        </div>

        <!-- Assets Count Metric -->
        <div class="metric-card">
            <div class="metric-card__icon bg-warning">
                <i class="fas fa-coins"></i>
            </div>
            <div class="metric-card__content">
                <span class="metric-card__label">Assets</span>
                <span class="metric-card__value" id="assets-count">0</span>
                <small class="text-muted" style="font-size: 0.75rem; margin-top: 4px; display: block;">
                    Unique assets
                </small>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row g-3">
        <!-- Positions Table -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <div class="card-header__title">
                        <h5><i class="fas fa-list"></i> Open Positions</h5>
                    </div>
                    <div class="card-header__actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshPortfolio()" aria-label="Refresh portfolio data">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="positions-table">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Side</th>
                                    <th>Size</th>
                                    <th>Entry</th>
                                    <th>Current</th>
                                    <th>P&L</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    
                    <!-- Empty State - CSS v4.0 -->
                    <div id="no-positions" class="empty-state" style="display: none;">
                        <i class="empty-state__icon fas fa-inbox"></i>
                        <div class="empty-state__title">No Open Positions</div>
                        <div class="empty-state__description">
                            Your active trades will appear here once you open positions
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Asset Allocation -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <div class="card-header__title">
                        <h5><i class="fas fa-pie-chart"></i> Asset Allocation</h5>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Chart Container - CSS v4.0 -->
                    <div class="chart-container">
                        <canvas id="allocation-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let allocationChart = null;

async function loadPortfolioData() {
    try {
        showLoading('Loading portfolio...');
        
        // Load summary
        const summaryRes = await fetch('/portfolio/api/summary');
        const summary = await summaryRes.json();
        
        if (summary.success) {
            const s = summary.summary;
            document.getElementById('total-value').textContent = '$' + s.total_value_usd.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            const totalPnlEl = document.getElementById('total-pnl');
            totalPnlEl.textContent = (s.total_pnl_pct >= 0 ? '+' : '') + s.total_pnl_pct + '%';
            totalPnlEl.className = s.total_pnl_pct >= 0 ? 'text-success' : 'text-danger';
            totalPnlEl.innerHTML = `<i class="fas fa-arrow-${s.total_pnl_pct >= 0 ? 'up' : 'down'}"></i> ` + totalPnlEl.textContent;
            
            document.getElementById('daily-pnl').textContent = '$' + s.daily_pnl_usd.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            const dailyPnlPctEl = document.getElementById('daily-pnl-pct');
            dailyPnlPctEl.textContent = (s.daily_pnl_pct >= 0 ? '+' : '') + s.daily_pnl_pct + '%';
            dailyPnlPctEl.className = s.daily_pnl_pct >= 0 ? 'text-success' : 'text-danger';
            
            document.getElementById('open-positions').textContent = s.open_positions;
            document.getElementById('assets-count').textContent = s.assets_count;
        }
        
        // Load positions
        const positionsRes = await fetch('/portfolio/api/positions');
        const positions = await positionsRes.json();
        
        if (positions.success) {
            const tbody = document.querySelector('#positions-table tbody');
            const noPositions = document.getElementById('no-positions');
            tbody.innerHTML = '';
            
            if (positions.positions.length === 0) {
                noPositions.style.display = 'flex'; // empty-state usa flexbox
                document.querySelector('#positions-table').style.display = 'none';
            } else {
                noPositions.style.display = 'none';
                document.querySelector('#positions-table').style.display = 'table';
                
                positions.positions.forEach(pos => {
                    const row = tbody.insertRow();
                    const pnlClass = pos.pnl_usd >= 0 ? 'text-success' : 'text-danger';
                    row.innerHTML = `
                        <td><strong>${pos.symbol}</strong></td>
                        <td><span class="badge bg-${pos.side === 'long' ? 'success' : 'danger'}">${pos.side.toUpperCase()}</span></td>
                        <td>${pos.size}</td>
                        <td>$${pos.entry_price.toLocaleString()}</td>
                        <td>$${pos.current_price.toLocaleString()}</td>
                        <td class="${pnlClass}">
                            <strong>$${pos.pnl_usd.toFixed(2)}</strong><br>
                            <small>(${pos.pnl_pct.toFixed(2)}%)</small>
                        </td>
                    `;
                });
            }
        }
        
        // Load allocation for chart
        const allocationRes = await fetch('/portfolio/api/allocation');
        const allocation = await allocationRes.json();
        
        if (allocation.success) {
            renderAllocationChart(allocation.allocation);
        }
        
        hideLoading();
        showToast('Portfolio updated successfully', 'success', 2000);
    } catch (error) {
        console.error('Error loading portfolio:', error);
        hideLoading();
        showToast('Failed to load portfolio data', 'error');
    }
}

function renderAllocationChart(data) {
    const ctx = document.getElementById('allocation-chart');
    
    if (allocationChart) {
        allocationChart.destroy();
    }

    // ✅ Use ThemeManager for theme-aware colors
    const colors = ThemeManager.getChartColors();
    const chartConfig = ThemeManager.getChartDefaults('doughnut');
    
    // Override with our data
    chartConfig.data = {
        labels: data.map(d => d.asset),
        datasets: [{
            data: data.map(d => d.percentage),
            backgroundColor: colors.palette,
            borderWidth: 0
        }]
    };

    // Customize tooltip for allocation data
    chartConfig.options.plugins.tooltip.callbacks = {
        label: function(context) {
            const asset = context.label;
            const percentage = context.parsed;
            const value = data[context.dataIndex].value_usd;
            return `${asset}: ${percentage}% ($${value.toLocaleString()})`;
        }
    };
    
    allocationChart = new Chart(ctx, chartConfig);
}

function refreshPortfolio() {
    loadPortfolioData();
}

// Load on page load
loadPortfolioData();

// Auto-refresh every 30 seconds
setInterval(loadPortfolioData, 30000);

// ✅ Re-render chart when theme changes
window.addEventListener('themechange', function() {
    if (allocationChart) {
        fetch('/portfolio/api/allocation')
            .then(res => res.json())
            .then(allocation => {
                if (allocation.success) {
                    renderAllocationChart(allocation.allocation);
                }
            });
    }
});
</script>
{% endblock %}
