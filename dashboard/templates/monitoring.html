{% extends "base.html" %}
{% block title %}Monitoring - Trading Bot{% endblock %}
{% block page_title %}Live Monitor{% endblock %}

{% block navbar_actions %}
<div class="connection-status connection-status--connecting" id="connection-status">
    <span class="connection-status__indicator"></span>
    <span class="connection-status__text">Connecting...</span>
</div>
<div class="latency-indicator" id="latency-display">
    <div class="latency-indicator__bars">
        <span class="latency-indicator__bar" style="height: 4px;"></span>
        <span class="latency-indicator__bar" style="height: 7px;"></span>
        <span class="latency-indicator__bar" style="height: 10px;"></span>
        <span class="latency-indicator__bar" style="height: 12px;"></span>
    </div>
    <span class="latency-indicator__value">--ms</span>
</div>
{% endblock %}

{% block content %}
<div class="monitoring-container">
    <!-- Alert Banner -->
    <div class="alert alert-info" id="ws-alert" role="status" aria-live="polite">
        <i class="fas fa-circle-notch fa-spin me-2"></i>
        <span id="ws-status-text">Establishing connection to real-time feed...</span>
    </div>

    <!-- Main Grid -->
    <div class="card-grid">
        <!-- Live Price Chart -->
        <div class="card card--chart" style="grid-column: span 2;">
            <div class="card-header">
                <div class="card-header__title">
                    <i class="fas fa-chart-line text-primary"></i>
                    <h5>Live Price Chart</h5>
                </div>
                <div class="card-header__actions">
                    <div class="dropdown" id="symbol-dropdown">
                        <button class="dropdown__trigger" onclick="toggleDropdown('symbol-dropdown')">
                            <span id="selected-symbol">BTC/USDT</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="dropdown__menu">
                            <div class="dropdown__item" onclick="selectSymbol('BTC/USDT')">
                                <i class="fab fa-bitcoin"></i> BTC/USDT
                            </div>
                            <div class="dropdown__item" onclick="selectSymbol('ETH/USDT')">
                                <i class="fab fa-ethereum"></i> ETH/USDT
                            </div>
                            <div class="dropdown__item" onclick="selectSymbol('SOL/USDT')">
                                <i class="fas fa-sun"></i> SOL/USDT
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Chart Container - CSS v4.0 ✅ -->
                <div class="chart-container" id="chart-wrapper">
                    <div class="skeleton skeleton-chart" id="chart-skeleton"></div>
                    <canvas id="live-chart" style="display: none;"></canvas>
                </div>
            </div>
        </div>

        <!-- Order Book -->
        <div class="card card--orderbook">
            <div class="card-header">
                <div class="card-header__title">
                    <i class="fas fa-book text-info"></i>
                    <h5>Order Book</h5>
                </div>
                <span class="badge bg-secondary" id="orderbook-depth">Depth: 10</span>
            </div>
            <div class="card-body p-0">
                <div class="orderbook">
                    <div class="orderbook__section orderbook__section--asks" id="asks-container">
                        <div class="skeleton skeleton-row" style="height: 24px;"></div>
                        <div class="skeleton skeleton-row" style="height: 24px;"></div>
                        <div class="skeleton skeleton-row" style="height: 24px;"></div>
                        <div class="skeleton skeleton-row" style="height: 24px;"></div>
                        <div class="skeleton skeleton-row" style="height: 24px;"></div>
                    </div>
                    <div class="orderbook__spread">
                        <span class="orderbook__spread-label">Spread</span>
                        <span class="orderbook__spread-value" id="spread-value">--</span>
                    </div>
                    <div class="orderbook__section orderbook__section--bids" id="bids-container">
                        <div class="skeleton skeleton-row" style="height: 24px;"></div>
                        <div class="skeleton skeleton-row" style="height: 24px;"></div>
                        <div class="skeleton skeleton-row" style="height: 24px;"></div>
                        <div class="skeleton skeleton-row" style="height: 24px;"></div>
                        <div class="skeleton skeleton-row" style="height: 24px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Second Row -->
    <div class="card-grid mt-4">
        <!-- Live Trades Feed -->
        <div class="card">
            <div class="card-header">
                <div class="card-header__title">
                    <i class="fas fa-exchange-alt text-warning"></i>
                    <h5>Live Trades</h5>
                </div>
                <span class="badge bg-primary" id="trade-count">0</span>
            </div>
            <div class="card-body p-0">
                <div class="trades-feed" id="trades-feed">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Price</th>
                                <th>Amount</th>
                                <th>Side</th>
                            </tr>
                        </thead>
                        <tbody id="trades-body">
                            <!-- Empty State - CSS v4.0 ✅ -->
                            <tr id="trades-empty-state">
                                <td colspan="4">
                                    <div class="empty-state empty-state--compact">
                                        <i class="empty-state__icon fas fa-exchange-alt"></i>
                                        <div class="empty-state__title">No trades yet</div>
                                        <div class="empty-state__description">Waiting for trade data...</div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- System Logs -->
        <div class="card">
            <div class="card-header">
                <div class="card-header__title">
                    <i class="fas fa-terminal text-success"></i>
                    <h5>System Logs</h5>
                </div>
                <div class="card-header__actions">
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearLogs()" title="Clear logs">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="downloadLogs()" title="Download logs">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="logs-container" id="logs-container" role="log" aria-live="polite">
                    <div class="log-entry log-info">
                        <span class="log-entry__time">[{{ now().strftime('%H:%M:%S') if now is defined else '00:00:00' }}]</span>
                        <span class="log-entry__level">INFO</span>
                        <span class="log-entry__message">System initialized - Waiting for WebSocket connection</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Real-time Metrics - CSS v4.0 ✅ -->
    <div class="card mt-4">
        <div class="card-header">
            <div class="card-header__title">
                <i class="fas fa-tachometer-alt text-primary"></i>
                <h5>Real-time Metrics</h5>
            </div>
            <div class="card-header__actions">
                <span class="security-badge security-badge--secure">
                    <i class="fas fa-shield-alt"></i>
                    <span>Encrypted</span>
                </span>
            </div>
        </div>
        <div class="card-body">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-card__icon bg-primary">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="metric-card__content">
                        <span class="metric-card__label">Latency</span>
                        <span class="metric-card__value" id="latency">--ms</span>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-card__icon bg-info">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="metric-card__content">
                        <span class="metric-card__label">Messages/sec</span>
                        <span class="metric-card__value" id="msg-rate">--</span>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-card__icon bg-warning">
                        <i class="fas fa-microchip"></i>
                    </div>
                    <div class="metric-card__content">
                        <span class="metric-card__label">CPU Usage</span>
                        <span class="metric-card__value" id="cpu-usage">--%</span>
                        <div class="progress progress--sm mt-2">
                            <div class="progress__bar" id="cpu-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-card__icon bg-success">
                        <i class="fas fa-memory"></i>
                    </div>
                    <div class="metric-card__content">
                        <span class="metric-card__label">Memory</span>
                        <span class="metric-card__value" id="memory-usage">--MB</span>
                        <div class="progress progress--sm mt-2">
                            <div class="progress__bar" id="memory-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-card__icon bg-danger">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="metric-card__content">
                        <span class="metric-card__label">Orders/min</span>
                        <span class="metric-card__value" id="order-rate">--</span>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-card__icon" style="background: var(--color-primary-light);">
                        <i class="fas fa-hourglass-half"></i>
                    </div>
                    <div class="metric-card__content">
                        <span class="metric-card__label">Uptime</span>
                        <span class="metric-card__value" id="uptime">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // =====================================================
    // MONITORING PAGE - PROFESSIONAL IMPLEMENTATION
    // ✅ CSS v4.0 + ThemeManager Integration
    // =====================================================

    const state = {
        symbol: 'BTC/USDT',
        isConnected: false,
        trades: [],
        maxTrades: 50,
        logs: [],
        maxLogs: 100,
        chart: null,
        chartData: [],
        metrics: {
            latency: 0,
            msgRate: 0,
            cpuUsage: 0,
            memoryUsage: 0,
            orderRate: 0,
            uptime: 0
        }
    };

    const elements = {
        connectionStatus: document.getElementById('connection-status'),
        wsAlert: document.getElementById('ws-alert'),
        wsStatusText: document.getElementById('ws-status-text'),
        chartSkeleton: document.getElementById('chart-skeleton'),
        liveChart: document.getElementById('live-chart'),
        tradesBody: document.getElementById('trades-body'),
        tradesEmptyState: document.getElementById('trades-empty-state'),
        tradeCount: document.getElementById('trade-count'),
        logsContainer: document.getElementById('logs-container'),
        spreadValue: document.getElementById('spread-value'),
        asksContainer: document.getElementById('asks-container'),
        bidsContainer: document.getElementById('bids-container'),
        latencyDisplay: document.getElementById('latency-display')
    };

    // =====================================================
    // CONNECTION STATUS
    // =====================================================
    function updateConnectionStatus(status) {
        const statusEl = elements.connectionStatus;
        const alertEl = elements.wsAlert;
        
        statusEl.className = 'connection-status';
        
        switch(status) {
            case 'connected':
                statusEl.classList.add('connection-status--connected');
                statusEl.querySelector('.connection-status__text').textContent = 'Connected';
                alertEl.className = 'alert alert-success';
                alertEl.innerHTML = '<i class="fas fa-check-circle me-2"></i><span>Connected to real-time feed</span>';
                state.isConnected = true;
                break;
            case 'disconnected':
                statusEl.classList.add('connection-status--disconnected');
                statusEl.querySelector('.connection-status__text').textContent = 'Disconnected';
                alertEl.className = 'alert alert-danger';
                alertEl.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i><span>Connection lost. Attempting to reconnect...</span>';
                state.isConnected = false;
                break;
            case 'reconnecting':
                statusEl.classList.add('connection-status--reconnecting');
                statusEl.querySelector('.connection-status__text').textContent = 'Reconnecting...';
                alertEl.className = 'alert alert-warning';
                alertEl.innerHTML = '<i class="fas fa-circle-notch fa-spin me-2"></i><span>Reconnecting to server...</span>';
                break;
            default:
                statusEl.classList.add('connection-status--connecting');
                statusEl.querySelector('.connection-status__text').textContent = 'Connecting...';
        }
    }

    // =====================================================
    // CHART INITIALIZATION - ✅ WITH THEMEMANAGER
    // =====================================================
    function initChart() {
        const ctx = elements.liveChart.getContext('2d');
        const colors = ThemeManager.getChartColors();
        const config = ThemeManager.getChartDefaults('line');
        
        config.data = {
            labels: [],
            datasets: [{
                label: state.symbol,
                data: [],
                borderColor: colors.primary,
                backgroundColor: `${colors.primary}1A`,
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 4
            }]
        };
        
        config.options.plugins.tooltip.callbacks = {
            label: function(context) {
                return `Price: $${context.parsed.y.toLocaleString()}`;
            }
        };
        
        state.chart = new Chart(ctx, config);

        // Show chart, hide skeleton
        elements.chartSkeleton.style.display = 'none';
        elements.liveChart.style.display = 'block';
    }

    // ✅ Re-render chart on theme change
    window.addEventListener('themechange', function() {
        if (state.chart) {
            const colors = ThemeManager.getChartColors();
            state.chart.data.datasets[0].borderColor = colors.primary;
            state.chart.data.datasets[0].backgroundColor = `${colors.primary}1A`;
            state.chart.options.scales.x.grid.color = colors.gridColor;
            state.chart.options.scales.y.grid.color = colors.gridColor;
            state.chart.options.scales.x.ticks.color = colors.textColor;
            state.chart.options.scales.y.ticks.color = colors.textColor;
            state.chart.update();
        }
    });

    // =====================================================
    // TRADES HANDLING
    // =====================================================
    function addTrade(trade) {
        if (elements.tradesEmptyState) {
            elements.tradesEmptyState.remove();
        }

        state.trades.unshift(trade);
        if (state.trades.length > state.maxTrades) {
            state.trades.pop();
        }

        elements.tradeCount.textContent = state.trades.length;

        const row = document.createElement('tr');
        row.className = `trade-row trade-row--${trade.side.toLowerCase()} fade-in`;
        row.innerHTML = `
            <td class="trade-row__time">${trade.time}</td>
            <td class="trade-row__price">$${parseFloat(trade.price).toLocaleString()}</td>
            <td class="trade-row__amount">${parseFloat(trade.amount).toFixed(4)}</td>
            <td class="trade-row__side">
                <span class="badge ${trade.side === 'buy' ? 'bg-success' : 'bg-danger'}">
                    ${trade.side.toUpperCase()}
                </span>
            </td>
        `;

        elements.tradesBody.insertBefore(row, elements.tradesBody.firstChild);

        while (elements.tradesBody.children.length > state.maxTrades) {
            elements.tradesBody.removeChild(elements.tradesBody.lastChild);
        }
    }

    // =====================================================
    // LOGS HANDLING
    // =====================================================
    function addLog(message, level = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const levelColors = {
            info: 'log-info',
            success: 'log-success',
            warning: 'log-warning',
            error: 'log-error'
        };

        const logEntry = document.createElement('div');
        logEntry.className = `log-entry ${levelColors[level] || 'log-info'}`;
        logEntry.innerHTML = `
            <span class="log-entry__time">[${timestamp}]</span>
            <span class="log-entry__level">${level.toUpperCase()}</span>
            <span class="log-entry__message">${DOMPurify.sanitize(message)}</span>
        `;

        elements.logsContainer.appendChild(logEntry);
        elements.logsContainer.scrollTop = elements.logsContainer.scrollHeight;

        while (elements.logsContainer.children.length > state.maxLogs) {
            elements.logsContainer.removeChild(elements.logsContainer.firstChild);
        }
    }

    function clearLogs() {
        elements.logsContainer.innerHTML = '';
        addLog('Logs cleared', 'info');
        showToast('Logs cleared', 'success');
    }

    function downloadLogs() {
        const logs = Array.from(elements.logsContainer.children)
            .map(el => el.textContent)
            .join('\n');
        
        const blob = new Blob([logs], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `botv2-logs-${new Date().toISOString().slice(0, 10)}.txt`;
        a.click();
        URL.revokeObjectURL(url);
        
        showToast('Logs downloaded', 'success');
    }

    // =====================================================
    // ORDERBOOK
    // =====================================================
    function updateOrderbook(data) {
        if (!data) return;

        const renderOrders = (orders, container, type) => {
            container.innerHTML = orders.map(order => `
                <div class="orderbook__row orderbook__row--${type}">
                    <span class="orderbook__price">${parseFloat(order.price).toFixed(2)}</span>
                    <span class="orderbook__amount">${parseFloat(order.amount).toFixed(4)}</span>
                    <div class="orderbook__depth" style="width: ${order.depth || 0}%"></div>
                </div>
            `).join('');
        };

        if (data.asks) renderOrders(data.asks.slice(0, 10).reverse(), elements.asksContainer, 'ask');
        if (data.bids) renderOrders(data.bids.slice(0, 10), elements.bidsContainer, 'bid');
        
        if (data.spread) {
            elements.spreadValue.textContent = `$${parseFloat(data.spread).toFixed(2)}`;
        }
    }

    // =====================================================
    // METRICS UPDATE
    // =====================================================
    function updateMetrics(data) {
        if (data.latency !== undefined) {
            document.getElementById('latency').textContent = `${data.latency}ms`;
            updateLatencyIndicator(data.latency);
        }
        if (data.msgRate !== undefined) {
            document.getElementById('msg-rate').textContent = data.msgRate;
        }
        if (data.cpuUsage !== undefined) {
            document.getElementById('cpu-usage').textContent = `${data.cpuUsage}%`;
            document.getElementById('cpu-bar').style.width = `${data.cpuUsage}%`;
            document.getElementById('cpu-bar').className = `progress__bar ${data.cpuUsage > 80 ? 'bg-danger' : data.cpuUsage > 60 ? 'bg-warning' : ''}`;
        }
        if (data.memoryUsage !== undefined) {
            document.getElementById('memory-usage').textContent = `${data.memoryUsage}MB`;
            const memPercent = Math.min((data.memoryUsage / 1024) * 100, 100);
            document.getElementById('memory-bar').style.width = `${memPercent}%`;
        }
        if (data.orderRate !== undefined) {
            document.getElementById('order-rate').textContent = data.orderRate;
        }
        if (data.uptime !== undefined) {
            document.getElementById('uptime').textContent = formatUptime(data.uptime);
        }
    }

    function updateLatencyIndicator(latency) {
        const indicator = elements.latencyDisplay;
        const bars = indicator.querySelectorAll('.latency-indicator__bar');
        const value = indicator.querySelector('.latency-indicator__value');
        
        value.textContent = `${latency}ms`;
        
        let activeBars = 4;
        if (latency > 500) activeBars = 1;
        else if (latency > 200) activeBars = 2;
        else if (latency > 100) activeBars = 3;
        
        bars.forEach((bar, i) => {
            bar.style.backgroundColor = i < activeBars ? 
                (activeBars <= 2 ? 'var(--color-danger)' : activeBars === 3 ? 'var(--color-warning)' : 'var(--color-success)') 
                : 'var(--border-color)';
        });
    }

    function formatUptime(seconds) {
        const d = Math.floor(seconds / 86400);
        const h = Math.floor((seconds % 86400) / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        
        if (d > 0) return `${d}d ${h}h`;
        if (h > 0) return `${h}h ${m}m`;
        return `${m}m`;
    }

    // =====================================================
    // DROPDOWN
    // =====================================================
    function toggleDropdown(id) {
        document.getElementById(id).classList.toggle('is-open');
    }

    function selectSymbol(symbol) {
        state.symbol = symbol;
        document.getElementById('selected-symbol').textContent = symbol;
        document.getElementById('symbol-dropdown').classList.remove('is-open');
        
        if (state.chart) {
            state.chart.data.labels = [];
            state.chart.data.datasets[0].data = [];
            state.chart.data.datasets[0].label = symbol;
            state.chart.update('none');
        }
        
        if (socket) {
            socket.emit('subscribe_symbol', { symbol: symbol });
        }
        
        addLog(`Switched to ${symbol}`, 'info');
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.dropdown')) {
            document.querySelectorAll('.dropdown.is-open').forEach(d => d.classList.remove('is-open'));
        }
    });

    // =====================================================
    // WEBSOCKET HANDLERS
    // =====================================================
    if (typeof socket !== 'undefined' && socket) {
        socket.on('connect', () => {
            updateConnectionStatus('connected');
            addLog('WebSocket connected successfully', 'success');
            socket.emit('subscribe_symbol', { symbol: state.symbol });
        });

        socket.on('disconnect', () => {
            updateConnectionStatus('disconnected');
            addLog('WebSocket disconnected', 'error');
        });

        socket.on('reconnecting', () => {
            updateConnectionStatus('reconnecting');
            addLog('Attempting to reconnect...', 'warning');
        });

        socket.on('price_update', (data) => {
            if (state.chart && data.price) {
                const time = new Date().toLocaleTimeString();
                state.chart.data.labels.push(time);
                state.chart.data.datasets[0].data.push(data.price);
                
                if (state.chart.data.labels.length > 60) {
                    state.chart.data.labels.shift();
                    state.chart.data.datasets[0].data.shift();
                }
                
                state.chart.update('none');
            }
        });

        socket.on('trade', (data) => {
            addTrade(data);
        });

        socket.on('orderbook', (data) => {
            updateOrderbook(data);
        });

        socket.on('metrics', (data) => {
            updateMetrics(data);
        });

        socket.on('log', (data) => {
            addLog(data.message, data.level);
        });
    }

    document.addEventListener('ws:connected', () => updateConnectionStatus('connected'));
    document.addEventListener('ws:disconnected', () => updateConnectionStatus('disconnected'));
    document.addEventListener('ws:error', () => updateConnectionStatus('disconnected'));

    // =====================================================
    // INITIALIZATION
    // =====================================================
    document.addEventListener('DOMContentLoaded', () => {
        initChart();
        addLog('Monitoring page initialized', 'info');
        
        setTimeout(() => {
            if (!state.isConnected) {
                document.querySelectorAll('.skeleton').forEach(el => {
                    el.style.display = 'none';
                });
            }
        }, 2000);
    });
</script>
{% endblock %}
