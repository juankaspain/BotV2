<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="BotV2 Professional Trading Dashboard v7.8 - 100% Complete">
    <meta name="theme-color" content="#1a1d21">

    <!-- SECURITY: CSRF Token Meta Tag -->
    {% if csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {% endif %}

    <title>{% block title %}BotV2 Dashboard{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">

    <!-- CRITICAL: Theme initialization (MUST be first to prevent FOUC) -->
    <script>
        // Execute immediately, before any rendering
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>

    <!-- PERFORMANCE: Preconnect to external origins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>

    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">

    <!-- Custom CSS - ALL STYLES UNIFIED HERE -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">

    {% block head %}{% endblock %}
</head>
<body>
    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-brand">
                <div class="sidebar-brand__logo">
                    <i class="fas fa-robot"></i>
                </div>
                <span class="sidebar__text">BotV2</span>
                <span class="badge bg-success ms-2" style="font-size: 0.65rem;">v7.8</span>
            </div>
        </div>

        <nav class="sidebar-nav">
            <!-- Main Section -->
            <div class="nav-section">
                <div class="nav-section__title">Main</div>
                <a href="{{ url_for('index') }}" class="nav-link {% if request.endpoint == 'index' %}active{% endif %}">
                    <i class="fas fa-home"></i>
                    <span class="sidebar__text">Dashboard</span>
                </a>
                <a href="{{ url_for('control.control_panel_ui') }}" class="nav-link {% if request.endpoint == 'control.control_panel_ui' %}active{% endif %}">
                    <i class="fas fa-sliders-h"></i>
                    <span class="sidebar__text">Control Panel</span>
                </a>
                <a href="{{ url_for('monitoring.monitoring_ui') }}" class="nav-link {% if request.endpoint == 'monitoring.monitoring_ui' %}active{% endif %}">
                    <i class="fas fa-eye"></i>
                    <span class="sidebar__text">Live Monitor</span>
                </a>
            </div>

            <!-- Trading Section -->
            <div class="nav-section">
                <div class="nav-section__title">Trading</div>
                <a href="{{ url_for('strategy_editor.strategy_editor_ui') }}" class="nav-link {% if request.endpoint == 'strategy_editor.strategy_editor_ui' %}active{% endif %}">
                    <i class="fas fa-brain"></i>
                    <span class="sidebar__text">Strategies</span>
                </a>
                <!-- v7.7: Portfolio -->
                <a href="{{ url_for('portfolio.portfolio_ui') }}" class="nav-link {% if request.endpoint == 'portfolio.portfolio_ui' %}active{% endif %}">
                    <i class="fas fa-chart-line"></i>
                    <span class="sidebar__text">Portfolio</span>
                </a>
                <!-- v7.7: Trade History -->
                <a href="{{ url_for('trade_history.trade_history_ui') }}" class="nav-link {% if request.endpoint == 'trade_history.trade_history_ui' %}active{% endif %}">
                    <i class="fas fa-history"></i>
                    <span class="sidebar__text">Trade History</span>
                </a>
            </div>

            <!-- Analysis Section -->
            <div class="nav-section">
                <div class="nav-section__title">Analysis</div>
                <!-- v7.7: Performance -->
                <a href="{{ url_for('performance.performance_ui') }}" class="nav-link {% if request.endpoint == 'performance.performance_ui' %}active{% endif %}">
                    <i class="fas fa-chart-bar"></i>
                    <span class="sidebar__text">Performance</span>
                </a>
                <!-- v7.8: Risk Management (NEW) -->
                <a href="{{ url_for('risk.risk_management_ui') }}" class="nav-link {% if request.endpoint == 'risk.risk_management_ui' %}active{% endif %}">
                    <i class="fas fa-shield-alt"></i>
                    <span class="sidebar__text">Risk Management</span>
                </a>
            </div>

            <!-- System Section -->
            <div class="nav-section">
                <div class="nav-section__title">System</div>
                <a href="{{ url_for('system_health_ui') }}" class="nav-link {% if request.endpoint == 'system_health_ui' %}active{% endif %}">
                    <i class="fas fa-heartbeat"></i>
                    <span class="sidebar__text">System Health</span>
                </a>
                <!-- v7.8: Settings (NEW) -->
                <a href="{{ url_for('settings.settings_ui') }}" class="nav-link {% if request.endpoint == 'settings.settings_ui' %}active{% endif %}">
                    <i class="fas fa-cog"></i>
                    <span class="sidebar__text">Settings</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-info__avatar">
                    {{ user[0]|upper if user else 'A' }}
                </div>
                <div class="user-info__details">
                    <div class="user-info__name">{{ user or 'Admin' }}</div>
                    <div class="user-info__status">
                        <span class="status-indicator online"></span>
                        <span class="sidebar__text">Online</span>
                    </div>
                </div>
                <button class="btn-icon btn-icon--ghost" onclick="window.location.href='{{ url_for('logout') }}'" title="Logout" aria-label="Logout">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </aside>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- Main Content -->
    <div class="main-wrapper">
        <header class="header">
            <div class="header__left">
                <button class="hamburger" id="hamburger" onclick="toggleSidebar()" aria-label="Toggle menu">
                    <span class="hamburger__line"></span>
                    <span class="hamburger__line"></span>
                    <span class="hamburger__line"></span>
                </button>
                <h1 class="header__title">{% block page_title %}Dashboard{% endblock %}</h1>
            </div>
            <div class="header__right">
                {% block navbar_actions %}{% endblock %}
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                    <i class="fas fa-moon" id="theme-icon"></i>
                </button>
            </div>
        </header>

        <main class="main-content" id="main-content">
            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- Toast Container -->
    <div class="toast-container toast-container--top-right" id="toast-container" aria-live="polite"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="global-loading">
        <div class="loading-overlay__spinner"></div>
        <div class="loading-overlay__text">Loading...</div>
    </div>

    <!-- DOMPurify for XSS Protection -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js" crossorigin="anonymous"></script>

    <!-- Bootstrap 5.3 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <!-- Chart.js 4 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>

    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js" crossorigin="anonymous"></script>

    <script>
        // =====================================================
        // GLOBAL UTILITIES v7.8
        // =====================================================
        
        // Theme Management
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('theme-icon');
            if (icon) {
                icon.className = theme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
            }
        }

        // Initialize theme icon on load (theme already applied in <head>)
        (function initThemeIcon() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            updateThemeIcon(currentTheme);
        })();

        // Sidebar Management
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const hamburger = document.getElementById('hamburger');
            sidebar.classList.toggle('is-open');
            overlay.classList.toggle('is-active');
            hamburger.classList.toggle('is-active');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const hamburger = document.getElementById('hamburger');
            sidebar.classList.remove('is-open');
            overlay.classList.remove('is-active');
            hamburger.classList.remove('is-active');
        }

        // Loading Overlay
        function showLoading(message = 'Loading...') {
            const overlay = document.getElementById('global-loading');
            const text = overlay.querySelector('.loading-overlay__text');
            if (text) text.textContent = message;
            overlay.classList.add('is-active');
        }

        function hideLoading() {
            const overlay = document.getElementById('global-loading');
            overlay.classList.remove('is-active');
        }

        // Toast Notification System
        function showToast(message, type = 'info', duration = 5000) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast toast--${type}`;
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };

            toast.innerHTML = `
                <i class="toast__icon fas ${icons[type] || icons.info}"></i>
                <div class="toast__content">
                    <div class="toast__message">${DOMPurify.sanitize(message)}</div>
                </div>
                <button class="toast__close" onclick="this.parentElement.remove()" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
                <div class="toast__progress">
                    <div class="toast__progress-bar" style="animation-duration: ${duration}ms"></div>
                </div>
            `;

            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('toast--exiting');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // CSRF Token
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
        
        // Fetch wrapper with CSRF
        async function secureFetch(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(csrfToken && { 'X-CSRFToken': csrfToken })
                }
            };
            
            try {
                const response = await fetch(url, { ...defaultOptions, ...options });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response;
            } catch (error) {
                showToast(error.message, 'error');
                throw error;
            }
        }

        // WebSocket connection
        let socket = null;
        try {
            socket = io({
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                reconnectionAttempts: 5
            });

            socket.on('connect', () => {
                console.log('âœ“ WebSocket connected');
                document.dispatchEvent(new CustomEvent('ws:connected'));
            });
            
            socket.on('disconnect', () => {
                console.log('âœ— WebSocket disconnected');
                document.dispatchEvent(new CustomEvent('ws:disconnected'));
            });
            
            socket.on('connect_error', (error) => {
                console.warn('âš  WebSocket error:', error.message);
                document.dispatchEvent(new CustomEvent('ws:error', { detail: error }));
            });
        } catch (e) {
            console.warn('WebSocket initialization failed:', e);
        }

        // Hide loading on page load
        window.addEventListener('load', hideLoading);

        // Log dashboard version
        console.log('%cðŸ¤– BotV2 Dashboard v7.8 - 100% Complete ', 'background: #5865f2; color: white; padding: 5px 10px; border-radius: 3px; font-weight: bold;');
        console.log('%câœ“ All 10 features active', 'color: #57f287; font-weight: bold;');
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
