{% extends "base.html" %}

{% block title %}System Health - BotV2{% endblock %}
{% block page_title %}System Health{% endblock %}

{% block navbar_actions %}
<div class="connection-status connection-status--connected" id="health-status">
    <span class="connection-status__indicator"></span>
    <span>System Online</span>
</div>
<div class="refresh-controls">
    <span class="refresh-timer" id="refresh-timer" title="Next auto-refresh">60s</span>
    <button class="btn btn-sm btn-outline-secondary" onclick="refreshHealthData()" title="Refresh Now">
        <i class="fas fa-sync-alt" id="refresh-icon"></i>
    </button>
</div>
{% endblock %}

{% block content %}
<div class="system-health">
    <!-- Quick Stats Row - Horizontal Layout -->
    <div class="metrics-row mb-4" id="quick-stats">
        <div class="metric-item">
            <div class="metric-item__icon bg-success">
                <i class="fas fa-heartbeat"></i>
            </div>
            <div class="metric-item__content">
                <span class="metric-item__label">Status</span>
                <span class="metric-item__value" id="stat-status">--</span>
            </div>
        </div>
        <div class="metric-item">
            <div class="metric-item__icon bg-primary">
                <i class="fas fa-code-branch"></i>
            </div>
            <div class="metric-item__content">
                <span class="metric-item__label">Version</span>
                <span class="metric-item__value" id="stat-version">--</span>
            </div>
        </div>
        <div class="metric-item">
            <div class="metric-item__icon bg-info">
                <i class="fas fa-clock"></i>
            </div>
            <div class="metric-item__content">
                <span class="metric-item__label">Uptime</span>
                <span class="metric-item__value" id="stat-uptime">--</span>
            </div>
        </div>
        <div class="metric-item">
            <div class="metric-item__icon bg-warning">
                <i class="fas fa-tachometer-alt"></i>
            </div>
            <div class="metric-item__content">
                <span class="metric-item__label">Req/min</span>
                <span class="metric-item__value" id="stat-rpm">--</span>
            </div>
        </div>
        <div class="metric-item">
            <div class="metric-item__icon bg-danger">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="metric-item__content">
                <span class="metric-item__label">Errors</span>
                <span class="metric-item__value" id="stat-errors">--</span>
            </div>
        </div>
        <div class="metric-item">
            <div class="metric-item__icon bg-primary">
                <i class="fas fa-users"></i>
            </div>
            <div class="metric-item__content">
                <span class="metric-item__label">Users</span>
                <span class="metric-item__value" id="stat-users">--</span>
            </div>
        </div>
    </div>

    <!-- Resource Usage Charts -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="card-header__title">
                        <i class="fas fa-chart-area text-primary"></i>
                        <h5>Resource Usage History</h5>
                    </div>
                    <div class="card-header__actions">
                        <span class="badge bg-secondary" id="data-points-count">0 data points</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="charts-grid">
                        <div class="chart-container">
                            <div class="chart-header">
                                <span class="chart-title"><i class="fas fa-microchip text-primary"></i> CPU Usage</span>
                                <span class="chart-value" id="cpu-current">--</span>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="cpu-chart"></canvas>
                            </div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-header">
                                <span class="chart-title"><i class="fas fa-memory text-info"></i> Memory Usage</span>
                                <span class="chart-value" id="memory-current">--</span>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="memory-chart"></canvas>
                            </div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-header">
                                <span class="chart-title"><i class="fas fa-hdd text-warning"></i> Disk Usage</span>
                                <span class="chart-value" id="disk-current">--</span>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="disk-chart"></canvas>
                            </div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-header">
                                <span class="chart-title"><i class="fas fa-network-wired text-success"></i> Network I/O</span>
                                <span class="chart-value" id="network-current">--</span>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="network-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- System Resources (Gauges) -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <div class="card-header__title">
                        <i class="fas fa-microchip text-primary"></i>
                        <h5>Current Resources</h5>
                    </div>
                </div>
                <div class="card-body">
                    <div class="resource-gauge mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-secondary"><i class="fas fa-memory me-2"></i>CPU Usage</span>
                            <span class="fw-semibold" id="cpu-value">--</span>
                        </div>
                        <div class="progress">
                            <div class="progress__bar" id="cpu-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="resource-gauge mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-secondary"><i class="fas fa-server me-2"></i>Memory</span>
                            <span class="fw-semibold" id="memory-value">--</span>
                        </div>
                        <div class="progress">
                            <div class="progress__bar bg-info" id="memory-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="resource-gauge mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-secondary"><i class="fas fa-hdd me-2"></i>Disk Usage</span>
                            <span class="fw-semibold" id="disk-value">--</span>
                        </div>
                        <div class="progress">
                            <div class="progress__bar bg-warning" id="disk-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="resource-gauge">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-secondary"><i class="fas fa-network-wired me-2"></i>Network I/O</span>
                            <span class="fw-semibold" id="network-value">--</span>
                        </div>
                        <div class="progress progress--sm">
                            <div class="progress__bar bg-success" id="network-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Component Status -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <div class="card-header__title">
                        <i class="fas fa-cubes text-info"></i>
                        <h5>Component Status</h5>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="component-list" id="component-list">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Status -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <div class="card-header__title">
                        <i class="fas fa-shield-alt text-success"></i>
                        <h5>Security Status</h5>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="security-list" id="security-list">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mt-2">
        <!-- Active Connections -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <div class="card-header__title">
                        <i class="fas fa-plug text-warning"></i>
                        <h5>Active Connections</h5>
                    </div>
                    <span class="badge bg-primary" id="connections-count">0</span>
                </div>
                <div class="card-body">
                    <div class="connections-grid" id="connections-grid">
                        <div class="connection-item">
                            <div class="connection-item__icon">
                                <i class="fas fa-globe"></i>
                            </div>
                            <div class="connection-item__info">
                                <span class="connection-item__label">HTTP Connections</span>
                                <span class="connection-item__value" id="http-connections">--</span>
                            </div>
                        </div>
                        <div class="connection-item">
                            <div class="connection-item__icon">
                                <i class="fas fa-bolt"></i>
                            </div>
                            <div class="connection-item__info">
                                <span class="connection-item__label">WebSocket</span>
                                <span class="connection-item__value" id="ws-connections">--</span>
                            </div>
                        </div>
                        <div class="connection-item">
                            <div class="connection-item__icon">
                                <i class="fas fa-database"></i>
                            </div>
                            <div class="connection-item__info">
                                <span class="connection-item__label">Database Pool</span>
                                <span class="connection-item__value" id="db-connections">--</span>
                            </div>
                        </div>
                        <div class="connection-item">
                            <div class="connection-item__icon">
                                <i class="fas fa-exchange-alt"></i>
                            </div>
                            <div class="connection-item__info">
                                <span class="connection-item__label">Exchange APIs</span>
                                <span class="connection-item__value" id="api-connections">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Python Environment -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <div class="card-header__title">
                        <i class="fab fa-python text-info"></i>
                        <h5>Python Environment</h5>
                    </div>
                </div>
                <div class="card-body">
                    <div class="env-grid" id="python-env">
                        <div class="env-item">
                            <span class="env-item__label">Python Version</span>
                            <span class="env-item__value" id="python-version">--</span>
                        </div>
                        <div class="env-item">
                            <span class="env-item__label">Flask Version</span>
                            <span class="env-item__value" id="flask-version">--</span>
                        </div>
                        <div class="env-item">
                            <span class="env-item__label">OS Platform</span>
                            <span class="env-item__value" id="os-platform">--</span>
                        </div>
                        <div class="env-item">
                            <span class="env-item__label">Process ID</span>
                            <span class="env-item__value" id="process-id">--</span>
                        </div>
                        <div class="env-item">
                            <span class="env-item__label">Thread Count</span>
                            <span class="env-item__value" id="thread-count">--</span>
                        </div>
                        <div class="env-item">
                            <span class="env-item__label">Open Files</span>
                            <span class="env-item__value" id="open-files">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity Log -->
    <div class="row g-4 mt-2">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="card-header__title">
                        <i class="fas fa-list-alt text-secondary"></i>
                        <h5>Recent Activity</h5>
                    </div>
                    <div class="card-header__actions">
                        <span class="text-muted" id="last-refresh">Last refresh: --</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="activity-log" id="activity-log">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* ==========================================================================
   METRICS ROW - Horizontal Professional Layout
   ========================================================================== */

.metrics-row {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: var(--space-md);
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    box-shadow: var(--shadow-sm);
}

.metric-item {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-sm);
    border-radius: var(--radius-md);
    transition: all var(--transition-smooth);
}

.metric-item:hover {
    background: var(--bg-card-hover);
}

.metric-item__icon {
    width: 44px;
    height: 44px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    color: white;
    flex-shrink: 0;
    box-shadow: var(--shadow-sm);
}

.metric-item__icon.bg-primary { background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark)); }
.metric-item__icon.bg-success { background: linear-gradient(135deg, var(--color-success), var(--color-success-dark)); }
.metric-item__icon.bg-warning { background: linear-gradient(135deg, var(--color-warning), var(--color-warning-dark)); }
.metric-item__icon.bg-danger { background: linear-gradient(135deg, var(--color-danger), var(--color-danger-dark)); }
.metric-item__icon.bg-info { background: linear-gradient(135deg, var(--color-info), var(--color-info-dark)); }

.metric-item__content {
    display: flex;
    flex-direction: column;
    min-width: 0;
}

.metric-item__label {
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.03em;
    white-space: nowrap;
}

.metric-item__value {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);
    font-family: var(--font-mono);
    color: var(--text-heading);
    white-space: nowrap;
}

/* Responsive for metrics row */
@media (max-width: 1399.98px) {
    .metrics-row {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (max-width: 991.98px) {
    .metrics-row {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 575.98px) {
    .metrics-row {
        grid-template-columns: 1fr;
    }
    
    .metric-item {
        justify-content: flex-start;
    }
}

/* Charts Grid */
.charts-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-lg);
}

@media (max-width: 991.98px) {
    .charts-grid {
        grid-template-columns: 1fr;
    }
}

.chart-container {
    background: var(--bg-sidebar);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
    padding: var(--space-md);
    transition: all var(--transition-normal);
}

.chart-container:hover {
    border-color: var(--color-primary);
    box-shadow: 0 0 20px rgba(78, 115, 223, 0.1);
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-sm);
    border-bottom: 1px solid var(--border-color);
}

.chart-title {
    font-weight: 600;
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.chart-title i {
    font-size: var(--font-size-base);
}

.chart-value {
    font-family: var(--font-mono);
    font-weight: 700;
    font-size: var(--font-size-lg);
    color: var(--text-primary);
}

.chart-wrapper {
    height: 150px;
    position: relative;
}

/* Refresh Controls */
.refresh-controls {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.refresh-timer {
    font-family: var(--font-mono);
    font-size: var(--font-size-sm);
    color: var(--text-muted);
    background: var(--bg-card-hover);
    padding: 4px 10px;
    border-radius: var(--radius-sm);
    min-width: 45px;
    text-align: center;
}

/* Component and Security lists */
.component-list,
.security-list {
    display: flex;
    flex-direction: column;
}

.component-item,
.security-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-md);
    border-bottom: 1px solid var(--border-color);
    transition: background var(--transition-fast);
}

.component-item:last-child,
.security-item:last-child {
    border-bottom: none;
}

.component-item:hover,
.security-item:hover {
    background: var(--bg-card-hover);
}

.component-item__info,
.security-item__info {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.component-item__icon {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-card-hover);
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
}

.component-item__name,
.security-item__name {
    font-weight: 500;
}

.component-item__status {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: var(--font-size-sm);
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-full);
}

.component-item__status.status--ok {
    background: rgba(28, 200, 138, 0.15);
    color: var(--color-success);
}

.component-item__status.status--warning {
    background: rgba(246, 194, 62, 0.15);
    color: var(--color-warning);
}

.component-item__status.status--error {
    background: rgba(231, 74, 59, 0.15);
    color: var(--color-danger);
}

.component-item__status.status--disabled {
    background: var(--bg-card-hover);
    color: var(--text-muted);
}

/* Connections Grid */
.connections-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-md);
}

.connection-item {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--bg-sidebar);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
}

.connection-item__icon {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-card-hover);
    color: var(--color-primary);
}

.connection-item__info {
    display: flex;
    flex-direction: column;
}

.connection-item__label {
    font-size: var(--font-size-xs);
    color: var(--text-muted);
}

.connection-item__value {
    font-size: var(--font-size-lg);
    font-weight: 600;
    font-family: var(--font-mono);
}

/* Environment Grid */
.env-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-md);
}

.env-item {
    padding: var(--space-md);
    background: var(--bg-sidebar);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
}

.env-item__label {
    display: block;
    font-size: var(--font-size-xs);
    color: var(--text-muted);
    margin-bottom: var(--space-xs);
}

.env-item__value {
    display: block;
    font-size: var(--font-size-sm);
    font-weight: 500;
    font-family: var(--font-mono);
    color: var(--text-primary);
}

/* Activity Log */
.activity-log {
    max-height: 300px;
    overflow-y: auto;
}

.activity-item {
    display: flex;
    align-items: flex-start;
    gap: var(--space-md);
    padding: var(--space-sm) var(--space-md);
    border-bottom: 1px solid var(--border-color);
    font-size: var(--font-size-sm);
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-item__time {
    color: var(--text-muted);
    font-family: var(--font-mono);
    font-size: var(--font-size-xs);
    flex-shrink: 0;
    min-width: 80px;
}

.activity-item__type {
    padding: 2px 8px;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    font-weight: 600;
    flex-shrink: 0;
}

.activity-item__type.type--info {
    background: rgba(78, 115, 223, 0.2);
    color: var(--color-primary);
}

.activity-item__type.type--success {
    background: rgba(28, 200, 138, 0.2);
    color: var(--color-success);
}

.activity-item__type.type--warning {
    background: rgba(246, 194, 62, 0.2);
    color: var(--color-warning);
}

.activity-item__type.type--error {
    background: rgba(231, 74, 59, 0.2);
    color: var(--color-danger);
}

.activity-item__message {
    flex: 1;
    color: var(--text-secondary);
}

/* Responsive */
@media (max-width: 767.98px) {
    .connections-grid,
    .env-grid {
        grid-template-columns: 1fr;
    }
}

@media (min-width: 768px) and (max-width: 1023.98px) {
    .env-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* Refresh animation */
.refreshing {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block scripts %}
<script>
// =====================================================
// SYSTEM HEALTH DASHBOARD - Professional Charts v2.0
// =====================================================

// Configuration
const CONFIG = {
    refreshInterval: 60000,      // 60 seconds auto-refresh
    maxDataPoints: 60,           // Keep last 60 data points (1 hour of data)
    chartAnimationDuration: 750  // Chart animation duration in ms
};

// State
let refreshInterval = null;
let countdownInterval = null;
let healthData = null;
let countdown = 60;

// Historical data buffers
const historyData = {
    labels: [],
    cpu: [],
    memory: [],
    disk: [],
    network: []
};

// Chart instances
let charts = {
    cpu: null,
    memory: null,
    disk: null,
    network: null
};

// Chart colors with gradients
const chartColors = {
    cpu: { line: '#4e73df', fill: 'rgba(78, 115, 223, 0.15)', gradient: ['rgba(78, 115, 223, 0.4)', 'rgba(78, 115, 223, 0)'] },
    memory: { line: '#36b9cc', fill: 'rgba(54, 185, 204, 0.15)', gradient: ['rgba(54, 185, 204, 0.4)', 'rgba(54, 185, 204, 0)'] },
    disk: { line: '#f6c23e', fill: 'rgba(246, 194, 62, 0.15)', gradient: ['rgba(246, 194, 62, 0.4)', 'rgba(246, 194, 62, 0)'] },
    network: { line: '#1cc88a', fill: 'rgba(28, 200, 138, 0.15)', gradient: ['rgba(28, 200, 138, 0.4)', 'rgba(28, 200, 138, 0)'] }
};

// =====================================================
// INITIALIZATION
// =====================================================

document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    refreshHealthData();
    startAutoRefresh();
});

function initializeCharts() {
    // Common chart options
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
            duration: CONFIG.chartAnimationDuration
        },
        interaction: {
            intersect: false,
            mode: 'index'
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(26, 29, 33, 0.95)',
                titleColor: '#fff',
                bodyColor: '#a0aec0',
                borderColor: 'rgba(255, 255, 255, 0.1)',
                borderWidth: 1,
                padding: 12,
                cornerRadius: 8,
                displayColors: false,
                titleFont: {
                    size: 13,
                    weight: '600'
                },
                bodyFont: {
                    size: 12
                }
            }
        },
        scales: {
            x: {
                display: true,
                grid: {
                    display: false
                },
                ticks: {
                    color: 'rgba(160, 174, 192, 0.6)',
                    font: { size: 10 },
                    maxRotation: 0,
                    maxTicksLimit: 6
                },
                border: {
                    display: false
                }
            },
            y: {
                display: true,
                min: 0,
                max: 100,
                grid: {
                    color: 'rgba(160, 174, 192, 0.1)',
                    drawBorder: false
                },
                ticks: {
                    color: 'rgba(160, 174, 192, 0.6)',
                    font: { size: 10 },
                    padding: 8,
                    callback: function(value) {
                        return value + '%';
                    },
                    stepSize: 25
                },
                border: {
                    display: false
                }
            }
        }
    };

    // Create each chart
    ['cpu', 'memory', 'disk', 'network'].forEach(metric => {
        const ctx = document.getElementById(`${metric}-chart`);
        if (!ctx) return;

        const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 150);
        gradient.addColorStop(0, chartColors[metric].gradient[0]);
        gradient.addColorStop(1, chartColors[metric].gradient[1]);

        const options = JSON.parse(JSON.stringify(commonOptions));
        
        // Special config for network (KB/s instead of %)
        if (metric === 'network') {
            options.scales.y.max = undefined;
            options.scales.y.suggestedMax = 1000;
            options.scales.y.ticks.callback = function(value) {
                if (value >= 1024) return (value / 1024).toFixed(1) + ' MB/s';
                return value.toFixed(0) + ' KB/s';
            };
        }

        charts[metric] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: historyData.labels,
                datasets: [{
                    data: historyData[metric],
                    borderColor: chartColors[metric].line,
                    backgroundColor: gradient,
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0,
                    pointHoverRadius: 5,
                    pointHoverBackgroundColor: chartColors[metric].line,
                    pointHoverBorderColor: '#fff',
                    pointHoverBorderWidth: 2
                }]
            },
            options: options
        });
    });
}

// =====================================================
// DATA FETCHING & UPDATE
// =====================================================

async function refreshHealthData() {
    const refreshIcon = document.getElementById('refresh-icon');
    refreshIcon.classList.add('refreshing');
    
    try {
        const response = await fetch('/api/system-health');
        if (!response.ok) throw new Error('Failed to fetch health data');
        
        healthData = await response.json();
        updateUI(healthData);
        updateCharts(healthData);
        
        document.getElementById('last-refresh').textContent = 
            'Last refresh: ' + new Date().toLocaleTimeString();
        
        // Reset countdown
        countdown = 60;
        updateCountdownDisplay();
        
    } catch (error) {
        console.error('Health check error:', error);
        showToast('Failed to fetch system health data', 'error');
        updateHealthStatus('error');
    } finally {
        refreshIcon.classList.remove('refreshing');
    }
}

function updateCharts(data) {
    if (!data.system) return;

    // Add timestamp label
    const now = new Date();
    const timeLabel = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    
    // Add new data points
    historyData.labels.push(timeLabel);
    historyData.cpu.push(data.system.cpu_percent || 0);
    historyData.memory.push(data.system.memory_percent || 0);
    historyData.disk.push(data.system.disk_percent || 0);
    historyData.network.push(data.system.network_io_kbps || 0);

    // Trim to max data points
    if (historyData.labels.length > CONFIG.maxDataPoints) {
        historyData.labels.shift();
        historyData.cpu.shift();
        historyData.memory.shift();
        historyData.disk.shift();
        historyData.network.shift();
    }

    // Update charts
    Object.keys(charts).forEach(key => {
        if (charts[key]) {
            charts[key].data.labels = historyData.labels;
            charts[key].data.datasets[0].data = historyData[key];
            charts[key].update('none'); // 'none' for smooth updates without full animation
        }
    });

    // Update current values display
    document.getElementById('cpu-current').textContent = (data.system.cpu_percent || 0).toFixed(1) + '%';
    document.getElementById('memory-current').textContent = (data.system.memory_percent || 0).toFixed(1) + '%';
    document.getElementById('disk-current').textContent = (data.system.disk_percent || 0).toFixed(1) + '%';
    document.getElementById('network-current').textContent = formatNetworkRate(data.system.network_io_kbps || 0);

    // Update data points count
    document.getElementById('data-points-count').textContent = historyData.labels.length + ' data points';
}

// =====================================================
// AUTO-REFRESH WITH COUNTDOWN
// =====================================================

function startAutoRefresh() {
    // Clear any existing intervals
    if (refreshInterval) clearInterval(refreshInterval);
    if (countdownInterval) clearInterval(countdownInterval);

    // Start countdown timer (updates every second)
    countdownInterval = setInterval(() => {
        countdown--;
        updateCountdownDisplay();
        
        if (countdown <= 0) {
            countdown = 60;
        }
    }, 1000);

    // Start auto-refresh (every 60 seconds)
    refreshInterval = setInterval(refreshHealthData, CONFIG.refreshInterval);
}

function updateCountdownDisplay() {
    const timerEl = document.getElementById('refresh-timer');
    if (timerEl) {
        timerEl.textContent = countdown + 's';
        
        // Visual indication when close to refresh
        if (countdown <= 5) {
            timerEl.style.color = 'var(--color-warning)';
        } else {
            timerEl.style.color = '';
        }
    }
}

// =====================================================
// UI UPDATE FUNCTIONS
// =====================================================

function updateUI(data) {
    updateHealthStatus(data.status);
    
    // Quick stats
    document.getElementById('stat-status').textContent = data.status?.toUpperCase() || '--';
    document.getElementById('stat-version').textContent = 'v' + (data.version || '--');
    document.getElementById('stat-uptime').textContent = formatUptime(data.system?.uptime_seconds);
    document.getElementById('stat-rpm').textContent = data.metrics?.request_rate_rpm?.toFixed(1) || '0';
    document.getElementById('stat-errors').textContent = (data.metrics?.error_rate_pct?.toFixed(2) || '0') + '%';
    document.getElementById('stat-users').textContent = data.metrics?.active_users || '0';
    
    // System resources bars
    if (data.system) {
        updateResourceBar('cpu', data.system.cpu_percent);
        updateResourceBar('memory', data.system.memory_percent);
        updateResourceBar('disk', data.system.disk_percent);
        
        const networkKbps = data.system.network_io_kbps || 0;
        const networkBarPercent = Math.min((networkKbps / 10240) * 100, 100);
        updateResourceBar('network', networkBarPercent);
        
        document.getElementById('network-value').textContent = formatNetworkRate(networkKbps);
    }
    
    // Component status
    updateComponentList(data.components || {});
    
    // Security status
    updateSecurityList(data.security || {});
    
    // Connections
    if (data.connections) {
        document.getElementById('http-connections').textContent = data.connections.http || '0';
        document.getElementById('ws-connections').textContent = data.connections.websocket || '0';
        document.getElementById('db-connections').textContent = data.connections.database || 'N/A';
        document.getElementById('api-connections').textContent = data.connections.exchange_apis || '0';
        
        const total = (data.connections.http || 0) + (data.connections.websocket || 0);
        document.getElementById('connections-count').textContent = total;
    }
    
    // Python environment
    if (data.python) {
        document.getElementById('python-version').textContent = data.python.version || '--';
        document.getElementById('flask-version').textContent = data.python.flask_version || '--';
        document.getElementById('os-platform').textContent = data.python.platform || '--';
        document.getElementById('process-id').textContent = data.python.pid || '--';
        document.getElementById('thread-count').textContent = data.python.threads || '--';
        document.getElementById('open-files').textContent = data.python.open_files || '--';
    }
    
    // Activity log
    updateActivityLog(data.recent_activity || []);
}

function updateHealthStatus(status) {
    const statusEl = document.getElementById('health-status');
    statusEl.className = 'connection-status';
    
    if (status === 'healthy') {
        statusEl.classList.add('connection-status--connected');
        statusEl.querySelector('span:last-child').textContent = 'System Online';
    } else if (status === 'degraded') {
        statusEl.classList.add('connection-status--reconnecting');
        statusEl.querySelector('span:last-child').textContent = 'Degraded';
    } else {
        statusEl.classList.add('connection-status--disconnected');
        statusEl.querySelector('span:last-child').textContent = 'System Error';
    }
}

function updateResourceBar(resource, percent) {
    const bar = document.getElementById(`${resource}-bar`);
    const value = document.getElementById(`${resource}-value`);
    
    if (bar) {
        bar.style.width = `${percent || 0}%`;
        
        bar.classList.remove('bg-success', 'bg-warning', 'bg-danger');
        if (percent > 90) bar.classList.add('bg-danger');
        else if (percent > 70) bar.classList.add('bg-warning');
        else bar.classList.add('bg-success');
    }
    
    if (value && resource !== 'network') {
        value.textContent = (percent?.toFixed(1) || '0') + '%';
    }
}

function formatNetworkRate(kbps) {
    if (kbps >= 1024) {
        return (kbps / 1024).toFixed(2) + ' MB/s';
    }
    return kbps.toFixed(2) + ' KB/s';
}

function updateComponentList(components) {
    const container = document.getElementById('component-list');
    if (!container) return;
    
    const componentConfig = [
        { key: 'flask', name: 'Flask Server', icon: 'fa-server' },
        { key: 'socketio', name: 'WebSocket (Socket.IO)', icon: 'fa-plug' },
        { key: 'database', name: 'Database', icon: 'fa-database' },
        { key: 'mock_data', name: 'Mock Data Engine', icon: 'fa-vial' },
        { key: 'metrics', name: 'Metrics Monitor', icon: 'fa-chart-line' },
        { key: 'compression', name: 'GZIP Compression', icon: 'fa-compress' },
        { key: 'rate_limiter', name: 'Rate Limiter', icon: 'fa-tachometer-alt' },
        { key: 'session_manager', name: 'Session Manager', icon: 'fa-user-clock' }
    ];
    
    container.innerHTML = componentConfig.map(comp => {
        const status = components[comp.key];
        const statusClass = status === true ? 'status--ok' : 
                           status === false ? 'status--disabled' : 
                           status === 'error' ? 'status--error' : 'status--warning';
        const statusText = status === true ? 'OK' : 
                          status === false ? 'Disabled' : 
                          status === 'error' ? 'Error' : 'Unknown';
        const statusIcon = status === true ? 'fa-check' : 
                          status === false ? 'fa-minus' : 
                          status === 'error' ? 'fa-times' : 'fa-question';
        
        return `
            <div class="component-item">
                <div class="component-item__info">
                    <div class="component-item__icon">
                        <i class="fas ${comp.icon}"></i>
                    </div>
                    <span class="component-item__name">${comp.name}</span>
                </div>
                <div class="component-item__status ${statusClass}">
                    <i class="fas ${statusIcon}"></i>
                    <span>${statusText}</span>
                </div>
            </div>
        `;
    }).join('');
}

function updateSecurityList(security) {
    const container = document.getElementById('security-list');
    if (!container) return;
    
    const securityConfig = [
        { key: 'csrf_protection', name: 'CSRF Protection', icon: 'fa-shield-alt' },
        { key: 'xss_prevention', name: 'XSS Prevention', icon: 'fa-bug' },
        { key: 'input_validation', name: 'Input Validation', icon: 'fa-check-double' },
        { key: 'session_security', name: 'Session Security', icon: 'fa-lock' },
        { key: 'audit_logging', name: 'Audit Logging', icon: 'fa-file-alt' },
        { key: 'https_enforced', name: 'HTTPS Enforcement', icon: 'fa-certificate' }
    ];
    
    container.innerHTML = securityConfig.map(sec => {
        const status = security[sec.key];
        const statusClass = status === true ? 'status--ok' : 'status--disabled';
        const statusText = status === true ? 'Enabled' : 'Disabled';
        const statusIcon = status === true ? 'fa-check' : 'fa-minus';
        
        return `
            <div class="component-item">
                <div class="component-item__info">
                    <div class="component-item__icon">
                        <i class="fas ${sec.icon}"></i>
                    </div>
                    <span class="component-item__name">${sec.name}</span>
                </div>
                <div class="component-item__status ${statusClass}">
                    <i class="fas ${statusIcon}"></i>
                    <span>${statusText}</span>
                </div>
            </div>
        `;
    }).join('');
}

function updateActivityLog(activities) {
    const container = document.getElementById('activity-log');
    if (!container) return;
    
    if (activities.length === 0) {
        container.innerHTML = `
            <div class="empty-state empty-state--compact">
                <i class="empty-state__icon fas fa-inbox"></i>
                <div class="empty-state__title">No recent activity</div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = activities.map(activity => {
        const typeClass = `type--${activity.type || 'info'}`;
        return `
            <div class="activity-item">
                <span class="activity-item__time">${activity.time || '--'}</span>
                <span class="activity-item__type ${typeClass}">${(activity.type || 'INFO').toUpperCase()}</span>
                <span class="activity-item__message">${DOMPurify.sanitize(activity.message || '')}</span>
            </div>
        `;
    }).join('');
}

function formatUptime(seconds) {
    if (!seconds) return '--';
    
    const days = Math.floor(seconds / 86400);
    const hours = Math.floor((seconds % 86400) / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    
    if (days > 0) return `${days}d ${hours}h`;
    if (hours > 0) return `${hours}h ${mins}m`;
    return `${mins}m`;
}

// =====================================================
// CLEANUP
// =====================================================

window.addEventListener('beforeunload', function() {
    if (refreshInterval) clearInterval(refreshInterval);
    if (countdownInterval) clearInterval(countdownInterval);
    
    // Destroy charts
    Object.values(charts).forEach(chart => {
        if (chart) chart.destroy();
    });
});
</script>
{% endblock %}
