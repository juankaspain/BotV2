# BotV2 Trading System - Docker Compose Configuration
# Demo Mode Configuration (Default)
# Services: Trading Bot (Demo) + Dashboard (Demo Data)

# ARCHITECTURE (DEMO MODE):
#   Trading Bot → Paper Trading Mode (No real money)
#   Dashboard → Standalone Mode with Demo Data
#   No Database Required → All data is simulated/demo

# ARCHITECTURE (PRODUCTION MODE):
#   Trading Bot → Writes to → PostgreSQL/Redis
#   Dashboard → Reads from → PostgreSQL/Redis
#   (Uncomment PostgreSQL and Redis services below)

# QUICK START (DEMO MODE):
#   cp local.env .env
#   docker compose up -d
#   Access: http://localhost:8050 (Dashboard)

# PRODUCTION MODE:
#   1. Uncomment botv2-postgres and botv2-redis services
#   2. Uncomment depends_on sections in botv2-app and botv2-dashboard
#   3. Set TRADING_MODE=live in .env
#   4. Set DEMO_MODE=false in .env

services:
  # ============================================================================
  # Trading Bot Container (Background Process) - DEMO MODE ENABLED
  # ============================================================================
  botv2-app:
    container_name: botv2-app
    image: botv2-app:latest
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - .env  # CRITICAL: Loads all environment variables from .env file
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - TRADING_MODE=${TRADING_MODE:-paper}  # paper = demo mode (no real money)
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DEMO_MODE=true  # Enable demo/simulation mode
    command: ["python", "src/main.py"]  # Trading bot entry point
    # NOTE: No port mapping - this is a background process, not an HTTP server
    
    # PRODUCTION: Uncomment for database dependencies
    # depends_on:
    #   botv2-postgres:
    #     condition: service_healthy
    #   botv2-redis:
    #     condition: service_healthy
    
    networks:
      - botv2-network
    restart: on-failure:3  # Stop after 3 failures (no infinite restart loop)
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./logs:/app/logs
      - ./backups:/app/backups
      - ./data:/app/data

  # ============================================================================
  # Dashboard Container (Web Interface) - DEMO MODE WITH DEMO DATA
  # ============================================================================
  botv2-dashboard:
    container_name: botv2-dashboard
    image: botv2-dashboard:latest
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - .env  # CRITICAL: Loads all environment variables from .env file
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - FLASK_ENV=development  # development mode (HTTP only) for demo
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - FLASK_APP=src.dashboard.web_app
      - DASHBOARD_HOST=0.0.0.0
      - DASHBOARD_PORT=8050
      # Demo mode environment variables
      - DEMO_MODE=true  # Enables demo data generation
      - INITIAL_CAPITAL=3000  # Demo portfolio starting capital
      # Redis (optional for demo, required for production rate limiting)
      - REDIS_HOST=${REDIS_HOST:-localhost}
      - REDIS_PORT=${REDIS_PORT:-6379}
      # Authentication (will be auto-generated if not set)
      - DASHBOARD_USERNAME=${DASHBOARD_USERNAME:-admin}
      - DASHBOARD_PASSWORD=${DASHBOARD_PASSWORD:-}  # Leave empty for auto-generation
      - SECRET_KEY=${SECRET_KEY:-}  # Leave empty for auto-generation
    command: ["python", "src/dashboard/dashboard_standalone.py"]  # Standalone entry point with demo data
    ports:
      - "${DASHBOARD_PORT:-8050}:8050"  # Dashboard web interface
    
    # PRODUCTION: Uncomment for database dependencies
    # depends_on:
    #   botv2-postgres:
    #     condition: service_healthy
    #   botv2-redis:
    #     condition: service_healthy
    
    networks:
      - botv2-network
    restart: on-failure:3  # Stop after 3 failures (no infinite restart loop)
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8050/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./logs:/app/logs  # Dashboard logs
      - ./data:/app/data  # Optional: Persistent demo data

  # ============================================================================
  # PostgreSQL Database - OPTIONAL (Required for production mode)
  # ============================================================================
  # PRODUCTION: Uncomment this entire section for production mode
  # botv2-postgres:
  #   container_name: botv2-postgres
  #   image: postgres:16-alpine
  #   env_file:
  #     - .env  # Reads POSTGRES_* variables
  #   environment:
  #     # Override with values from .env if present
  #     - POSTGRES_USER=${POSTGRES_USER:-botv2}
  #     - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-botv2password}
  #     - POSTGRES_DB=${POSTGRES_DATABASE:-botv2_db}
  #     - POSTGRES_INITDB_ARGS=-c shared_buffers=256MB -c max_connections=200
  #   ports:
  #     - "${POSTGRES_PORT:-5432}:5432"
  #   networks:
  #     - botv2-network
  #   restart: unless-stopped  # Database should always restart
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-botv2} -d ${POSTGRES_DATABASE:-botv2_db}"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #     - ./backups:/backups

  # ============================================================================
  # Redis Cache - OPTIONAL (Recommended for rate limiting in production)
  # ============================================================================
  # PRODUCTION: Uncomment this entire section for production mode
  # botv2-redis:
  #   container_name: botv2-redis
  #   image: redis:7-alpine
  #   command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru --requirepass ${REDIS_PASSWORD:-}
  #   env_file:
  #     - .env  # Reads REDIS_* variables
  #   ports:
  #     - "${REDIS_PORT:-6379}:6379"
  #   networks:
  #     - botv2-network
  #   restart: unless-stopped  # Cache should always restart
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD:-}", "ping"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   volumes:
  #     - redis_data:/data

# ============================================================================
# Networks
# ============================================================================
networks:
  botv2-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# ============================================================================
# Volumes - OPTIONAL (Uncomment if using PostgreSQL/Redis in production)
# ============================================================================
# volumes:
#   postgres_data:
#     driver: local
#   redis_data:
#     driver: local
