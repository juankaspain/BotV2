# BotV2 Configuration
# All 26 Audit Improvements Implemented + New Features

system:
  name: "BotV2"
  version: "1.1.0"
  environment: "production"  # production, staging, development
  log_level: "INFO"

trading:
  initial_capital: 3000  # EUR
  trading_interval: 60   # seconds
  max_position_size: 0.15  # 15% of portfolio max
  min_position_size: 0.01  # 1% of portfolio min
  max_open_positions: 10
  
risk:
  circuit_breaker:
    level_1_drawdown: -5.0    # Stop trading at -5% daily DD
    level_2_drawdown: -10.0   # Reduce position size 50%
    level_3_drawdown: -15.0   # Emergency liquidation
    cooldown_minutes: 30      # Wait 30min after trigger
  
  # NEW: Dynamic Trailing Stops
  trailing_stops:
    enabled: true
    default_type: "percentage"  # percentage, atr, chandelier, dynamic
    activation_profit: 2.0      # Activate after 2% profit
    trail_distance: 1.0         # Trail by 1% (for percentage type)
    
    # ATR-based settings
    atr_period: 14
    atr_multiplier: 2.0         # Stop = High - (ATR * multiplier)
    
    # Chandelier settings
    chandelier_period: 22
    chandelier_multiplier: 3.0  # Stop = Highest High - (ATR * multiplier)
    
    # Per-strategy override (optional)
    strategy_overrides:
      momentum:
        type: "atr"
        activation_profit: 3.0
        atr_multiplier: 2.5
      mean_reversion:
        type: "percentage"
        activation_profit: 1.5
        trail_distance: 0.8
      breakout:
        type: "chandelier"
        activation_profit: 4.0
        chandelier_multiplier: 2.5
    
  correlation_threshold: 0.7  # Reduce if correlation > 0.7
  max_portfolio_correlation: 0.4
  
  kelly:
    fraction: 0.25  # Conservative Kelly (25% of full)
    min_probability: 0.55  # Minimum win probability
    
  sharpe_target: 2.5
  max_drawdown_tolerance: -20.0
  
execution:
  slippage_model: "realistic"  # realistic, aggressive, conservative
  commission_percent: 0.0005  # 0.05% per trade
  market_impact_percent: 0.001  # 0.1%
  
  # NEW: Latency Simulation
  latency:
    enabled: true               # Enable latency simulation
    model: "realistic"          # realistic, high, low, custom
    mean_ms: 50                 # Mean latency in milliseconds
    std_ms: 20                  # Standard deviation
    min_ms: 10                  # Minimum latency
    max_ms: 500                 # Maximum latency (timeout threshold)
    distribution: "lognormal"   # normal, lognormal, exponential
    
    # Time-of-day effects (higher latency during market open/close)
    time_effects:
      enabled: true
      peak_hours: [9, 10, 15, 16]  # UTC hours with higher latency
      peak_multiplier: 1.5      # Latency multiplier during peak
    
    # Network quality simulation
    packet_loss_rate: 0.001     # 0.1% packet loss
    retry_attempts: 3
    retry_delay_ms: 100
  
  order_types:
    market: true
    limit: true
    stop_loss: true
    take_profit: true
    trailing_stop: true         # NEW: Enable trailing stops
    
  simulation:
    model: "microstructure"
    include_bid_ask_spread: true
    include_order_book_depth: true
    include_time_of_day_effects: true
    realistic_fills: true
    include_latency: true       # NEW: Include latency in simulation

data:
  validation:
    check_nan: true
    check_infinity: true
    check_outliers: true
    check_ohlc_consistency: true
    check_volume: true
    outlier_std_threshold: 5
    
    # NEW: Enhanced Timestamp Validation
    timestamp_validation:
      enabled: true
      check_duplicates: true
      check_order: true          # Ensure chronological order
      check_future: true         # Reject future timestamps
      max_gap_seconds: 300       # Alert if gap > 5 minutes
      allow_backfill: false      # Reject late-arriving data
      timezone: "UTC"            # Expected timezone
      
      # Gap handling
      gap_detection:
        enabled: true
        critical_gap_seconds: 600  # 10 minutes = critical
        action_on_critical: "reject"  # reject, interpolate, skip
        max_interpolation_points: 5
    
  normalization:
    method: "zscore"  # zscore, minmax, robust
    lookback_period: 252  # days
    clip_range: [-3, 3]
    
  drift_detection:
    enabled: true
    method: "adwin"
    delta: 0.002

ensemble:
  voting_method: "weighted_average"
  confidence_threshold: 0.5
  min_strategies_agree: 3
  
  adaptive_allocation:
    method: "sharpe_based"
    rebalance_frequency: "daily"
    smoothing_alpha: 0.7
    lookback_days: 20
    
  correlation_management:
    recalculate_frequency: "hourly"
    correlation_lookback: 60  # minutes
    method: "pearson"  # pearson, spearman

strategies:
  enabled_count: 20
  
  # Base strategies (15)
  base:
    - momentum
    - stat_arb
    - regime
    - mean_reversion
    - volatility_expansion
    - breakout
    - fibonacci
    - macd_momentum
    - rsi_divergence
    - bollinger_bands
    - stochastic
    - ichimoku
    - elliot_wave
    - vix_hedge
    - sector_rotation
  
  # New high-performance strategies (5)
  advanced:
    - cross_exchange_arb
    - liquidation_flow
    - high_prob_bonds
    - liquidity_provision
    - domain_specialization

liquidation_detection:
  enabled: true
  cascade_threshold: 0.6  # 60% probability triggers action
  lookback_window: 300  # seconds
  recent_liquidation_count: 50
  action_on_cascade: "reduce_positions"  # reduce_positions, close_all, hedge
  
monitoring:
  real_time: true
  update_frequency: 5  # seconds
  
  metrics:
    - daily_returns
    - sharpe_ratio
    - max_drawdown
    - win_rate
    - profit_factor
    - recovery_factor
    - sortino_ratio
    - calmar_ratio
    
  alerts:
    email: false
    slack: false
    telegram: false

state_persistence:
  enabled: true
  checkpoint_frequency: 300  # Every 5 minutes
  backup_frequency: 3600  # Every hour
  
  storage:
    type: "postgresql"  # postgresql, sqlite, redis
    host: "localhost"
    port: 5432
    database: "botv2"
    user: "botv2_user"
    # password: set via environment variable POSTGRES_PASSWORD
    
  backup:
    path: "./backups"
    retention_days: 30
    compress: true

# ============================================================================
# EXCHANGE CONFIGURATIONS
# ============================================================================

exchanges:
  # Primary exchange (Polymarket for prediction markets)
  primary: "polymarket"
  
  # Binance - Fully supported and active
  binance:
    enabled: false  # Set to true to enable
    api_key_env: "BINANCE_API_KEY"
    api_secret_env: "BINANCE_SECRET"
    testnet: false
    trading_pairs:
      - "BTC/EUR"
      - "ETH/EUR"
      - "BNB/EUR"
    rate_limit: 1200  # requests per minute
    commission: 0.001  # 0.1%
  
  # Coinbase Pro - Optional
  coinbase:
    enabled: false  # Set to true to enable
    api_key_env: "COINBASE_API_KEY"
    api_secret_env: "COINBASE_SECRET"
    api_passphrase_env: "COINBASE_PASSPHRASE"
    testnet: false
    trading_pairs:
      - "BTC/EUR"
      - "ETH/EUR"
    rate_limit: 10  # requests per second
    commission: 0.005  # 0.5%
  
  # Kraken - Optional
  kraken:
    enabled: false  # Set to true to enable
    api_key_env: "KRAKEN_API_KEY"
    api_secret_env: "KRAKEN_SECRET"
    testnet: false
    trading_pairs:
      - "XBT/EUR"  # BTC on Kraken
      - "ETH/EUR"
    rate_limit: 15  # requests per second
    commission: 0.0026  # 0.26% (maker/taker average)
  
  # Finst - PREPARATORY (API not yet available)
  # Status: Waiting for Finst to release public API
  # Contact: support@finst.com to request API access
  finst:
    enabled: false  # Keep false until API is available
    api_available: false  # Will be updated when API launches
    api_key_env: "FINST_API_KEY"  # Placeholder
    api_secret_env: "FINST_SECRET"  # Placeholder
    testnet: false
    trading_pairs:
      - "BTC/EUR"
      - "ETH/EUR"
      - "USDT/EUR"
      - "SOL/EUR"
      - "ADA/EUR"
    rate_limit: 60  # Estimated - to be confirmed
    commission: 0.0015  # 0.15% (current platform fee)
    notes: |
      Finst is a European crypto exchange (Netherlands) with 340+ cryptocurrencies.
      Ultra-low fees (0.15% flat) and strong security focus.
      API is not yet publicly available as of January 2026.
      This configuration is preparatory for future integration.
      
      To request API access:
      - Email: support@finst.com
      - Subject: "API Access Request for Algorithmic Trading"
      
      When API becomes available:
      1. Obtain API credentials from Finst platform
      2. Set environment variables: FINST_API_KEY and FINST_SECRET
      3. Update api_available to true
      4. Set enabled to true
      5. Test with small amounts first

markets:
  # Prediction markets configuration
  polymarket:
    base_url: "https://clob.polymarket.com"
    api_key_env: "POLYMARKET_API_KEY"
    markets:
      - "election_2024"
      - "crypto_btc_eoy"
      - "ai_developments"
      - "sports_events"
      
  fallback:
    - "kalshi"
    - "predictit"

backtesting:
  enabled: true
  start_date: "2023-01-01"
  end_date: "2025-12-31"
  initial_capital: 3000
  
  simulation:
    realistic_slippage: true
    realistic_commissions: true
    realistic_market_impact: true
    partial_fills: true
    realistic_latency: true     # NEW: Include latency simulation
    
  output:
    save_trades: true
    save_equity_curve: true
    save_metrics: true
    generate_report: true

dashboard:
  enabled: true
  host: "0.0.0.0"
  port: 8050
  debug: false
  
  # NEW: Enhanced Security
  security:
    enabled: true
    authentication:
      type: "jwt"               # basic, jwt, oauth2
      username_env: "DASHBOARD_USERNAME"
      password_env: "DASHBOARD_PASSWORD"
      
      # JWT settings
      jwt_secret_env: "DASHBOARD_JWT_SECRET"
      jwt_algorithm: "HS256"
      jwt_expiry_hours: 24
      refresh_token_enabled: true
      refresh_token_expiry_days: 7
      
    # Rate limiting
    rate_limiting:
      enabled: true
      requests_per_minute: 60
      burst_size: 10
      
    # HTTPS/TLS
    https:
      enabled: false            # Set true in production
      cert_path: "/etc/ssl/certs/dashboard.crt"
      key_path: "/etc/ssl/private/dashboard.key"
      redirect_http: true       # Redirect HTTP to HTTPS
      
    # CORS
    cors:
      enabled: true
      allowed_origins:
        - "http://localhost:8050"
        - "https://yourdomain.com"
      
    # IP Whitelisting (optional)
    ip_whitelist:
      enabled: false
      allowed_ips:
        - "127.0.0.1"
        - "192.168.1.0/24"
    
    # Access logging
    access_log:
      enabled: true
      log_path: "./logs/dashboard_access.log"
      log_format: "combined"    # combined, common, custom
      
  refresh_rate: 5  # seconds
  
  charts:
    - equity_curve
    - daily_returns
    - drawdown
    - strategy_performance
    - correlation_heatmap
    - position_sizes
    - trailing_stops          # NEW: Trailing stops visualization
