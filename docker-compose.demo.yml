# ============================================================================
# BotV2 Trading System - DEMO MODE Configuration (OPTIMIZED)
# ============================================================================
# üéÆ MODO DEMO: Sistema optimizado para desarrollo y pruebas
#
# Caracter√≠sticas:
#   ‚Ä¢ Trading Bot + Dashboard v5.1 con datos demo
#   ‚Ä¢ NO requiere PostgreSQL ni Redis (usa memoria)
#   ‚Ä¢ Build R√ÅPIDO: ~2-3 minutos (vs 10-15 min producci√≥n)
#   ‚Ä¢ Inicio r√°pido (< 30 segundos)
#   ‚Ä¢ Bajo consumo de recursos
#   ‚Ä¢ Paper trading mode activado
#   ‚Ä¢ OHLCV + Annotations endpoints
#
# Inicio r√°pido:
#   cp .env.example .env
#   docker-compose -f docker-compose.demo.yml up -d
#   Acceso: http://localhost:8050
#   Login: admin / admin (cambiar en producci√≥n)
#
# Comandos √∫tiles:
#   docker-compose -f docker-compose.demo.yml logs -f
#   docker-compose -f docker-compose.demo.yml ps
#   docker-compose -f docker-compose.demo.yml down
#
# ‚ö†Ô∏è NOTA: Este modo usa Dockerfile.demo con dependencias reducidas
#   para builds m√°s r√°pidos. Para producci√≥n usar docker-compose.production.yml
# ============================================================================

services:
  # ==========================================================================
  # Trading Bot Container - Demo Mode (FAST BUILD)
  # ==========================================================================
  botv2-app:
    container_name: botv2-app
    image: botv2-app:latest
    build:
      context: .
      dockerfile: Dockerfile.demo
    env_file:
      - .env
    environment:
      # Python
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      
      # Trading (DEMO MODE)
      - TRADING_MODE=paper
      - DEMO_MODE=true
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - INITIAL_CAPITAL=3000
      
      # Database (not used in demo, but defined for compatibility)
      - POSTGRES_HOST=localhost
      - POSTGRES_PORT=5432
      - REDIS_HOST=localhost
      - REDIS_PORT=6379
    
    command: ["python", "bot/main.py"]
    
    networks:
      - botv2-network
    
    restart: on-failure:3
    
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    volumes:
      - ./logs:/app/logs
      - ./backups:/app/backups
      - ./data:/app/data
    
    labels:
      - "com.botv2.mode=demo"
      - "com.botv2.service=trading-bot"
      - "com.botv2.version=5.1-demo"
      - "com.botv2.build=fast"

  # ==========================================================================
  # Dashboard Container v5.1 - Demo Mode (FAST BUILD)
  # ==========================================================================
  botv2-dashboard:
    container_name: botv2-dashboard
    image: botv2-dashboard:latest
    build:
      context: .
      dockerfile: Dockerfile.demo
    env_file:
      - .env
    environment:
      # Python
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      
      # Flask
      - FLASK_ENV=development
      - FLASK_APP=dashboard.web_app
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      
      # Dashboard
      - DASHBOARD_HOST=0.0.0.0
      - DASHBOARD_PORT=8050
      
      # Demo Mode (ENABLED - uses mock data)
      - DEMO_MODE=true
      - INITIAL_CAPITAL=3000
      
      # Redis (fallback to memory if not available)
      - REDIS_HOST=${REDIS_HOST:-localhost}
      - REDIS_PORT=${REDIS_PORT:-6379}
      
      # Authentication (CHANGE IN PRODUCTION!)
      - DASHBOARD_USERNAME=${DASHBOARD_USERNAME:-admin}
      - DASHBOARD_PASSWORD=${DASHBOARD_PASSWORD:-admin}
      - SECRET_KEY=${SECRET_KEY:-demo-secret-key-change-in-production}
      
      # Database (optional - will use mock data if not available)
      - DATABASE_URL=${DATABASE_URL:-sqlite:///data/dashboard.db}
    
    # Use web_app.py v5.1 as module
    command: ["python", "-u", "-m", "dashboard.web_app"]
    
    ports:
      - "${DASHBOARD_PORT:-8050}:8050"
    
    networks:
      - botv2-network
    
    restart: on-failure:3
    
    healthcheck:
      test: |
        python -c "
        import urllib.request
        import sys
        try:
            response = urllib.request.urlopen('http://localhost:8050/health', timeout=5)
            sys.exit(0 if response.code in [200, 401, 302] else 1)
        except urllib.error.HTTPError as e:
            sys.exit(0 if e.code in [200, 401, 302] else 1)
        except Exception:
            sys.exit(1)
        "
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    
    volumes:
      - ./logs:/app/logs
      - ./data:/app/data
    
    labels:
      - "com.botv2.mode=demo"
      - "com.botv2.service=dashboard"
      - "com.botv2.version=5.1-demo"
      - "com.botv2.build=fast"
    
    depends_on:
      botv2-app:
        condition: service_started

# ============================================================================
# Networks
# ============================================================================
networks:
  botv2-network:
    driver: bridge
    labels:
      - "com.botv2.mode=demo"
